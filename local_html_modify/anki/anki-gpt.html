<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Anki Lite + Ebbinghaus (Single HTML)</title>
    <meta name="theme-color" content="#0b0f14" />
    <style>
        :root {
            --bg: #0b0f14;
            --panel: #111826;
            --panel2: #0f1520;
            --text: #e8eef8;
            --muted: #a9b6cc;
            --brand: #6ee7ff;
            --brand2: #8b5cf6;
            --ok: #22c55e;
            --warn: #f59e0b;
            --bad: #ef4444;
            --line: rgba(255, 255, 255, .10);
            --shadow: 0 14px 34px rgba(0, 0, 0, .35);
            --r: 18px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 20% 0%, rgba(110, 231, 255, .12), transparent 60%),
                radial-gradient(1000px 700px at 90% 10%, rgba(139, 92, 246, .12), transparent 60%),
                linear-gradient(180deg, #070a10, var(--bg));
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
            overflow-x: hidden;
        }

        a {
            color: inherit
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            padding: 16px 14px 18px;
            padding-bottom: calc(18px + env(safe-area-inset-bottom));
        }

        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: linear-gradient(180deg, rgba(11, 15, 20, .88), rgba(11, 15, 20, .55));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--line);
            margin: -16px -14px 16px;
            padding: 14px 14px 12px;
        }

        .topbar {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .logo {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(110, 231, 255, .95), rgba(139, 92, 246, .85));
            box-shadow: 0 10px 26px rgba(110, 231, 255, .12), 0 10px 26px rgba(139, 92, 246, .14);
        }

        .titlewrap {
            min-width: 0
        }

        .title {
            font-weight: 800;
            letter-spacing: .2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .subtitle {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px
        }

        .nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn {
            border: 1px solid var(--line);
            background: rgba(17, 24, 38, .65);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 14px;
            cursor: pointer;
            transition: .15s transform, .15s background, .15s border-color;
            box-shadow: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            border-color: rgba(110, 231, 255, .32)
        }

        .btn:active {
            transform: translateY(0px)
        }

        .btn.primary {
            background: linear-gradient(135deg, rgba(110, 231, 255, .22), rgba(139, 92, 246, .22));
            border-color: rgba(110, 231, 255, .35)
        }

        .btn.ghost {
            background: transparent
        }

        .btn.danger {
            border-color: rgba(239, 68, 68, .35);
            background: rgba(239, 68, 68, .08)
        }

        .btn.small {
            padding: 8px 10px;
            border-radius: 12px;
            font-size: 13px
        }

        .pill {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            color: var(--muted);
            background: rgba(255, 255, 255, .03);
            font-size: 12px;
        }

        main {
            display: block
        }

        .grid {
            display: grid;
            gap: 14px;
            grid-template-columns: 1.15fr .85fr;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr
            }

            .nav {
                gap: 6px
            }

            .btn {
                padding: 9px 10px
            }
        }

        .card {
            background: rgba(17, 24, 38, .60);
            border: 1px solid var(--line);
            border-radius: var(--r);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card .hd {
            padding: 14px 14px 10px;
            border-bottom: 1px solid var(--line);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .card .hd h2 {
            margin: 0;
            font-size: 15px;
            letter-spacing: .2px
        }

        .card .hd .right {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .card .bd {
            padding: 14px
        }

        .muted {
            color: var(--muted)
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .kpi {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .kpi .box {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
            border-radius: 16px;
            padding: 12px 12px;
        }

        .kpi .num {
            font-size: 22px;
            font-weight: 800
        }

        .kpi .lab {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px
        }

        .seg {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .seg .tab {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
            color: var(--muted);
            cursor: pointer;
            font-size: 13px;
        }

        .seg .tab.active {
            color: var(--text);
            border-color: rgba(110, 231, 255, .35);
            background: rgba(110, 231, 255, .10)
        }

        textarea,
        input,
        select {
            width: 100%;
            padding: 11px 12px;
            border-radius: 14px;
            border: 1px solid var(--line);
            background: rgba(15, 21, 32, .65);
            color: var(--text);
            outline: none;
        }

        textarea {
            min-height: 110px;
            resize: vertical
        }

        label {
            font-size: 12px;
            color: var(--muted)
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .drop {
            border: 1px dashed rgba(110, 231, 255, .30);
            background: rgba(110, 231, 255, .06);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drop .hint {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.35
        }

        .thumbs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .thumb {
            width: 92px;
            height: 92px;
            border-radius: 14px;
            border: 1px solid var(--line);
            overflow: hidden;
            background: rgba(255, 255, 255, .03);
            position: relative;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .thumb .x {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 22px;
            height: 22px;
            border-radius: 10px;
            background: rgba(0, 0, 0, .55);
            border: 1px solid rgba(255, 255, 255, .14);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .item {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
            border-radius: 16px;
            padding: 12px;
            display: grid;
            grid-template-columns: 72px 1fr auto;
            gap: 12px;
            align-items: center;
        }

        @media (max-width: 520px) {
            .item {
                grid-template-columns: 64px 1fr;
                grid-template-rows: auto auto;
            }

            .item .actions {
                grid-column: 1 / -1;
                display: flex;
                justify-content: flex-end;
                gap: 8px
            }
        }

        .item .img {
            width: 72px;
            height: 72px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
        }

        .item .img img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .item .t {
            font-weight: 750
        }

        .item .s {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
            line-height: 1.35
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
            color: var(--muted);
            font-size: 12px;
        }

        .hr {
            height: 1px;
            background: var(--line);
            margin: 12px 0
        }

        .reviewFace {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
            border-radius: 18px;
            padding: 14px;
        }

        .reviewText {
            white-space: pre-wrap;
            line-height: 1.55;
            font-size: 15px;
        }

        .reviewImgs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .reviewImgs img {
            max-width: 100%;
            width: auto;
            height: auto;
            border-radius: 16px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
        }

        .ratings {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 12px
        }

        @media (max-width:520px) {
            .ratings {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        .rate {
            padding: 12px 10px;
            border-radius: 16px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .03);
            cursor: pointer;
            font-weight: 750;
        }

        .rate.bad {
            border-color: rgba(239, 68, 68, .35);
            background: rgba(239, 68, 68, .07)
        }

        .rate.warn {
            border-color: rgba(245, 158, 11, .35);
            background: rgba(245, 158, 11, .07)
        }

        .rate.ok {
            border-color: rgba(34, 197, 94, .35);
            background: rgba(34, 197, 94, .07)
        }

        .rate.easy {
            border-color: rgba(110, 231, 255, .35);
            background: rgba(110, 231, 255, .07)
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, .72);
            border: 1px solid rgba(255, 255, 255, .14);
            border-radius: 999px;
            padding: 10px 14px;
            color: var(--text);
            display: none;
            max-width: min(720px, calc(100vw - 28px));
            box-shadow: 0 18px 40px rgba(0, 0, 0, .4);
            z-index: 1000;
        }

        .modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 900;
            background: rgba(0, 0, 0, .58);
            backdrop-filter: blur(8px);
            padding: 14px;
        }

        .modal .box {
            max-width: 860px;
            margin: 0 auto;
            margin-top: 18px;
            background: rgba(17, 24, 38, .90);
            border: 1px solid var(--line);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .modal .box .hd {
            padding: 14px;
            border-bottom: 1px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px
        }

        .modal .box .bd {
            padding: 14px
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div class="topbar">
                <div class="brand">
                    <div class="logo"></div>
                    <div class="titlewrap">
                        <div class="title">Anki Lite Â· Ebbinghaus</div>
                        <div class="subtitle">å•æ–‡ä»¶ Â· æœ¬åœ°å­˜å‚¨ Â· ç²˜è´´å›¾ç‰‡ Â· å¯¼å…¥å¯¼å‡º Â· ç»Ÿè®¡å›¾è¡¨</div>
                    </div>
                </div>
                <div class="nav">
                    <button class="btn small primary" data-nav="review">ğŸ§  å¤ä¹ </button>
                    <button class="btn small" data-nav="add">â• æ–°å»º</button>
                    <button class="btn small" data-nav="library">ğŸ—‚ï¸ å¡åº“</button>
                    <button class="btn small" data-nav="stats">ğŸ“Š ç»Ÿè®¡</button>
                    <button class="btn small ghost" data-nav="settings">âš™ï¸ è®¾ç½®</button>
                </div>
            </div>
        </header>

        <main>
            <!-- REVIEW -->
            <section id="view-review" class="grid" style="display:none;">
                <div class="card">
                    <div class="hd">
                        <h2>å¤ä¹ é˜Ÿåˆ—</h2>
                        <div class="right">
                            <span class="pill" id="duePill">Due: 0</span>
                            <button class="btn small" id="btnReloadDue">åˆ·æ–°é˜Ÿåˆ—</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="kpi" style="margin-bottom:12px">
                            <div class="box">
                                <div class="num" id="kpiDueNow">0</div>
                                <div class="lab">å½“å‰åˆ°æœŸå¡</div>
                            </div>
                            <div class="box">
                                <div class="num" id="kpiTodayDone">0</div>
                                <div class="lab">ä»Šæ—¥å·²å¤ä¹ </div>
                            </div>
                        </div>

                        <div id="reviewEmpty" class="muted" style="display:none; line-height:1.6">
                            å½“å‰æ²¡æœ‰åˆ°æœŸå¡ã€‚ä½ å¯ä»¥å»ã€Œæ–°å»ºã€åŠ å¡ï¼Œæˆ–åˆ°ã€Œå¡åº“ã€ç­›é€‰ä¸´æ—¶çªå‡»ã€‚
                        </div>

                        <div id="reviewWrap" style="display:none">
                            <div class="row"
                                style="justify-content:space-between; align-items:center; margin-bottom:10px">
                                <div class="muted" id="reviewMeta">â€”</div>
                                <div class="seg">
                                    <button class="tab active" id="btnShowFront">æ­£é¢</button>
                                    <button class="tab" id="btnShowBack" disabled>èƒŒé¢</button>
                                </div>
                            </div>

                            <div class="reviewFace">
                                <div class="reviewText" id="reviewText"></div>
                                <div class="reviewImgs" id="reviewImgs"></div>
                            </div>

                            <div class="row" style="margin-top:12px; align-items:center; justify-content:space-between">
                                <button class="btn primary" id="btnReveal">æ˜¾ç¤ºç­”æ¡ˆï¼ˆSpaceï¼‰</button>
                                <span class="muted" id="reviewHint">å¿«æ·é”®ï¼šSpace æ˜¾ç¤ºç­”æ¡ˆï¼›1/2/3/4 è¯„åˆ†</span>
                            </div>

                            <div class="ratings" id="rateButtons" style="display:none">
                                <button class="rate bad" data-rate="again">1 Â· å¿˜äº† (Again)</button>
                                <button class="rate warn" data-rate="hard">2 Â· å›°éš¾ (Hard)</button>
                                <button class="rate ok" data-rate="good">3 Â· ä¸€èˆ¬ (Good)</button>
                                <button class="rate easy" data-rate="easy">4 Â· è½»æ¾ (Easy)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="hd">
                        <h2>ä»Šæ—¥è¡¥ç¼ºå»ºè®®</h2>
                        <div class="right">
                            <button class="btn small" id="btnQuickReport">ç”Ÿæˆä»Šæ—¥æŠ¥å‘Š</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="muted" style="line-height:1.65">
                            è¯´æ˜ï¼šè¯¥åº”ç”¨ä»¥é—å¿˜æ›²çº¿ <span class="mono">R(t)=exp(-t/stability)</span> ä¼°ç®—â€œåº”è¯¥ä½•æ—¶å¤ä¹ â€ã€‚<br />
                            ä»Šå¤©çš„å¤ä¹ è®°å½•ä¼šè¢«ç”¨æ¥å¯¹æ¯”â€œé¢„æµ‹ vs å®é™…â€ã€‚<br /><br />
                            <span class="pill">å»ºè®®</span>
                        </div>
                        <div class="hr"></div>
                        <div id="suggestions" class="col"></div>
                    </div>
                </div>
            </section>

            <!-- ADD -->
            <section id="view-add" class="grid" style="display:none;">
                <div class="card">
                    <div class="hd">
                        <h2>æ–°å»ºå¡ç‰‡</h2>
                        <div class="right">
                            <span class="pill" id="pastePill">æ”¯æŒç²˜è´´å›¾ç‰‡</span>
                            <button class="btn small primary" id="btnSaveCard">ä¿å­˜å¡ç‰‡</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="field">
                            <label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                            <input id="inpTags" placeholder="ä¾‹å¦‚ï¼šJava,é¢è¯•,ç®—æ³•" />
                        </div>
                        <div class="hr"></div>

                        <div class="grid" style="grid-template-columns:1fr 1fr">
                            <div class="col">
                                <div class="field">
                                    <label>æ­£é¢ï¼ˆé¢˜ç›®/æç¤ºï¼‰</label>
                                    <textarea id="inpFront" placeholder="å†™é¢˜å¹²/æ¦‚å¿µ/é—®é¢˜â€¦"></textarea>
                                </div>
                                <div class="drop" id="dropFront">
                                    <div class="hint">
                                        âœ… æ¡Œé¢ç«¯ï¼šæˆªå›¾åç›´æ¥ Ctrl/âŒ˜+V ç²˜è´´å›¾ç‰‡åˆ°è¿™é‡Œ<br />
                                        âœ… ä¹Ÿå¯æ‹–æ‹½å›¾ç‰‡ï¼›ç§»åŠ¨ç«¯å¯â€œé€‰æ‹©å›¾ç‰‡/æ‹ç…§â€
                                    </div>
                                    <div class="row">
                                        <input type="file" accept="image/*" id="fileFront" multiple />
                                    </div>
                                    <div class="thumbs" id="frontThumbs"></div>
                                </div>
                            </div>

                            <div class="col">
                                <div class="field">
                                    <label>èƒŒé¢ï¼ˆç­”æ¡ˆ/è§£é‡Šï¼‰</label>
                                    <textarea id="inpBack" placeholder="å†™ç­”æ¡ˆ/è§£é‡Š/è¦ç‚¹â€¦"></textarea>
                                </div>
                                <div class="drop" id="dropBack">
                                    <div class="hint">
                                        æ”¯æŒä¸æ­£é¢ç›¸åŒçš„å›¾ç‰‡å¯¼å…¥æ–¹å¼ã€‚<br />
                                        å›¾ç‰‡ä¼šè‡ªåŠ¨å‹ç¼©åˆ° â‰¤200KBï¼Œå¹¶ç”Ÿæˆç¼©ç•¥å›¾ç”¨äºå¡åº“åˆ—è¡¨ã€‚
                                    </div>
                                    <div class="row">
                                        <input type="file" accept="image/*" id="fileBack" multiple />
                                    </div>
                                    <div class="thumbs" id="backThumbs"></div>
                                </div>
                            </div>
                        </div>

                        <div class="hr"></div>
                        <div class="row" style="justify-content:space-between; align-items:center">
                            <span class="muted">æç¤ºï¼šç‚¹å‡»ä»»æ„å¯¼å…¥åŒºåå†ç²˜è´´å›¾ç‰‡ï¼Œå¯è‡ªåŠ¨å½’ç±»åˆ°æ­£é¢/èƒŒé¢ã€‚</span>
                            <button class="btn danger" id="btnClearDraft">æ¸…ç©ºè‰ç¨¿</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="hd">
                        <h2>å‹ç¼©ä¸å­˜å‚¨</h2>
                        <div class="right">
                            <button class="btn small" id="btnTestPaste">æµ‹è¯•ç²˜è´´æç¤º</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="kpi" style="margin-bottom:12px">
                            <div class="box">
                                <div class="num" id="kpiMaxKB">200</div>
                                <div class="lab">å›¾ç‰‡æœ€å¤§ KB</div>
                            </div>
                            <div class="box">
                                <div class="num" id="kpiMaxDim">1600</div>
                                <div class="lab">æœ€é•¿è¾¹åƒç´ </div>
                            </div>
                        </div>
                        <div class="muted" style="line-height:1.7">
                            - å›¾ç‰‡ä¼šä¼˜å…ˆè½¬ä¸º WebPï¼ˆä¸æ”¯æŒæ—¶å›é€€ JPEGï¼‰ã€‚<br />
                            - é‡‡ç”¨â€œç¼©æ”¾ + è´¨é‡é€’å‡â€è¿­ä»£å‹ç¼©ï¼Œç›´åˆ° â‰¤ 200KBã€‚<br />
                            - åŒæ—¶ç”Ÿæˆçº¦ 320px çš„ç¼©ç•¥å›¾ï¼Œç”¨äºå¡åº“ç€‘å¸ƒ/åˆ—è¡¨é¢„è§ˆã€‚<br /><br />
                            æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ° IndexedDBã€‚ä½ å¯ä»¥åœ¨ã€Œè®¾ç½®ã€é‡Œå¯¼å‡º ZIP å¤‡ä»½æˆ–å¯¼å…¥æ¢å¤ã€‚
                        </div>
                    </div>
                </div>
            </section>

            <!-- LIBRARY -->
            <section id="view-library" class="grid" style="display:none;">
                <div class="card">
                    <div class="hd">
                        <h2>å¡åº“</h2>
                        <div class="right">
                            <button class="btn small" id="btnRefreshLib">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="row" style="gap:10px; align-items:center">
                            <input id="inpSearch" placeholder="æœç´¢ï¼šé¢˜å¹²/ç­”æ¡ˆ/æ ‡ç­¾â€¦" />
                            <select id="selFilter" style="max-width:200px">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="due">ä»…åˆ°æœŸ</option>
                                <option value="new">æ–°å¡ï¼ˆæœªå¤ä¹ ï¼‰</option>
                            </select>
                        </div>
                        <div class="hr"></div>
                        <div class="list" id="libList"></div>
                        <div id="libEmpty" class="muted" style="display:none; line-height:1.6">
                            æš‚æ— å¡ç‰‡ã€‚å»ã€Œæ–°å»ºã€æ·»åŠ ï¼Œæˆ–å¯¼å…¥å¤‡ä»½ ZIPã€‚
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="hd">
                        <h2>å¿«é€Ÿæ“ä½œ</h2>
                        <div class="right">
                            <button class="btn small primary" id="btnStartDue">å¼€å§‹å¤ä¹ åˆ°æœŸå¡</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="muted" style="line-height:1.7">
                            - åˆ°æœŸå¡ä¼˜å…ˆå¤ä¹ ã€‚<br />
                            - è‹¥ä½ éœ€è¦â€œä¸´æ—¶çªå‡»â€ï¼Œå¯ä»¥å…ˆç”¨æœç´¢ç­›å‡ºæŸæ ‡ç­¾ï¼Œç„¶åç‚¹å¡ç‰‡è¿›å…¥ç¼–è¾‘ï¼ŒæŠŠå®ƒçš„ <span class="mono">nextDueAt</span>
                            æå‰åˆ°ä»Šå¤©ï¼ˆåœ¨ç¼–è¾‘çª—å£é‡Œï¼‰ã€‚<br /><br />
                            åç»­å¦‚æœä½ æƒ³è¦æ›´åƒ Anki çš„â€œè‡ªå®šä¹‰ç‰Œç»„ / ä¸´æ—¶å­¦ä¹  / å­¦ä¹ ä¸Šé™â€ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»§ç»­æŠŠè¿™äº›åŠŸèƒ½è¡¥å…¨åˆ°åŒä¸€ä»½ HTML é‡Œã€‚
                        </div>
                    </div>
                </div>
            </section>

            <!-- STATS -->
            <section id="view-stats" class="grid" style="display:none;">
                <div class="card">
                    <div class="hd">
                        <h2>å…³é”®æŒ‡æ ‡</h2>
                        <div class="right">
                            <button class="btn small" id="btnRefreshStats">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="kpi" style="grid-template-columns:repeat(2,1fr);">
                            <div class="box">
                                <div class="num" id="statTotalCards">0</div>
                                <div class="lab">æ€»å¡ç‰‡æ•°</div>
                            </div>
                            <div class="box">
                                <div class="num" id="statDueToday">0</div>
                                <div class="lab">ä»Šæ—¥åˆ°æœŸ</div>
                            </div>
                            <div class="box">
                                <div class="num" id="statSuccessToday">0%</div>
                                <div class="lab">ä»Šæ—¥å›å¿†æˆåŠŸç‡ï¼ˆé Againï¼‰</div>
                            </div>
                            <div class="box">
                                <div class="num" id="statPredictedToday">â€”</div>
                                <div class="lab">ä»Šæ—¥é¢„æµ‹æˆåŠŸç‡ï¼ˆæ›²çº¿ä¼°ç®—ï¼‰</div>
                            </div>
                        </div>

                        <div class="hr"></div>
                        <div class="muted" style="line-height:1.65">
                            â€œé¢„æµ‹æˆåŠŸç‡â€åŸºäºæ¯æ¬¡å¤ä¹ å‰çš„é—å¿˜æ›²çº¿ <span class="mono">R(t)=exp(-t/stability)</span>ï¼›<br />
                            â€œå®é™…æˆåŠŸç‡â€æŠŠ <span class="mono">Again</span> è§†ä¸ºå¤±è´¥ï¼Œå…¶ä»–è§†ä¸ºæˆåŠŸã€‚<br />
                            è¿™æ ·ä½ å¯ä»¥çœ‹åˆ°â€œä½ çœŸå®çŠ¶æ€ vs ç†è®ºæ›²çº¿â€çš„å·®åˆ«ã€‚
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="hd">
                        <h2>å›¾è¡¨</h2>
                        <div class="right">
                            <span class="pill">Chart.js</span>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="col" style="gap:14px">
                            <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02)">
                                <div class="hd">
                                    <h2>è¿‘ 14 å¤©å¤ä¹ é‡</h2>
                                    <div class="right"><span class="pill">æŠ˜çº¿</span></div>
                                </div>
                                <div class="bd"><canvas id="chartReviews14"></canvas></div>
                            </div>
                            <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02)">
                                <div class="hd">
                                    <h2>æœªæ¥ 7 å¤©åˆ°æœŸé¢„æµ‹</h2>
                                    <div class="right"><span class="pill">æŸ±çŠ¶</span></div>
                                </div>
                                <div class="bd"><canvas id="chartDue7"></canvas></div>
                            </div>
                            <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02)">
                                <div class="hd">
                                    <h2>ä»Šæ—¥è¯„åˆ†åˆ†å¸ƒ</h2>
                                    <div class="right"><span class="pill">ç¯å½¢</span></div>
                                </div>
                                <div class="bd"><canvas id="chartRatesToday"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SETTINGS -->
            <section id="view-settings" class="grid" style="display:none;">
                <div class="card">
                    <div class="hd">
                        <h2>å¤‡ä»½ä¸æ¢å¤</h2>
                        <div class="right">
                            <button class="btn small primary" id="btnExportZip">å¯¼å‡º ZIP</button>
                            <label class="btn small">
                                å¯¼å…¥ ZIPï¼ˆè¦†ç›–ï¼‰
                                <input type="file" id="fileImportZip" accept=".zip" style="display:none" />
                            </label>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="muted" style="line-height:1.7">
                            å¯¼å‡º ZIP åŒ…å«ï¼š<br />
                            - <span class="mono">cards.json</span>ï¼ˆå¡ç‰‡å…ƒæ•°æ®ï¼‰<br />
                            - <span class="mono">assets/</span>ï¼ˆå›¾ç‰‡ä¸ç¼©ç•¥å›¾ï¼‰<br />
                            - <span class="mono">reviews.json</span>ï¼ˆå¤ä¹ è®°å½•ï¼‰<br /><br />
                            å¯¼å…¥ä¼šæ¸…ç©ºå½“å‰æ•°æ®åæ¢å¤å¤‡ä»½ï¼ˆé¿å…é‡å¤ä¸å†²çªï¼‰ã€‚
                        </div>
                        <div class="hr"></div>
                        <div class="row" style="justify-content:space-between; align-items:center">
                            <div class="muted">å±é™©æ“ä½œï¼šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®</div>
                            <button class="btn danger" id="btnResetAll">æ¸…ç©ºæ•°æ®åº“</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="hd">
                        <h2>å‚æ•°</h2>
                        <div class="right">
                            <button class="btn small" id="btnSaveSettings">ä¿å­˜</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div class="grid" style="grid-template-columns:1fr 1fr">
                            <div class="field">
                                <label>å›¾ç‰‡æœ€å¤§å¤§å°ï¼ˆKBï¼‰</label>
                                <input id="setMaxKB" type="number" min="50" max="800" step="10" />
                            </div>
                            <div class="field">
                                <label>å›¾ç‰‡æœ€é•¿è¾¹ï¼ˆpxï¼‰</label>
                                <input id="setMaxDim" type="number" min="640" max="4096" step="64" />
                            </div>
                        </div>
                        <div class="hr"></div>
                        <div class="grid" style="grid-template-columns:1fr 1fr">
                            <div class="field">
                                <label>å¤ä¹ é˜ˆå€¼ï¼ˆGood çš„ç›®æ ‡ä¿ç•™ç‡ Rï¼‰</label>
                                <input id="setTargetR" type="number" min="0.70" max="0.95" step="0.01" />
                            </div>
                            <div class="field">
                                <label>æœ€å°ç¨³å®šåº¦ï¼ˆå¤©ï¼‰</label>
                                <input id="setMinStab" type="number" min="0.05" max="5" step="0.05" />
                            </div>
                        </div>
                        <div class="hr"></div>
                        <div class="muted" style="line-height:1.7">
                            è°ƒåº¦æ ¸å¿ƒï¼š<span class="mono">R(t)=exp(-t/stability)</span>ï¼Œå¤ä¹ åä¼šæ›´æ–° stabilityï¼Œå¹¶è®¡ç®—ä¸‹ä¸€æ¬¡åˆ°æœŸæ—¶é—´ï¼š<br />
                            <span class="mono">nextIntervalDays = -stability * ln(targetRForRating)</span>ã€‚<br />
                            Again/Hard/Good/Easy ä¼šå¯¹åº”ä¸åŒçš„ targetRï¼ˆAgain æ›´æ¥è¿‘ 1ï¼Œé—´éš”æ›´çŸ­ï¼‰ã€‚
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="toast" id="toast"></div>

    <!-- EDIT MODAL -->
    <div class="modal" id="editModal">
        <div class="box">
            <div class="hd">
                <div style="display:flex; flex-direction:column; gap:2px; min-width:0">
                    <div style="font-weight:800">ç¼–è¾‘å¡ç‰‡</div>
                    <div class="muted" id="editId" style="font-size:12px"></div>
                </div>
                <div style="display:flex; gap:8px">
                    <button class="btn small danger" id="btnDeleteCard">åˆ é™¤</button>
                    <button class="btn small" id="btnCloseEdit">å…³é—­</button>
                    <button class="btn small primary" id="btnSaveEdit">ä¿å­˜</button>
                </div>
            </div>
            <div class="bd">
                <div class="grid" style="grid-template-columns:1fr 1fr">
                    <div class="field">
                        <label>æ­£é¢</label>
                        <textarea id="editFront"></textarea>
                    </div>
                    <div class="field">
                        <label>èƒŒé¢</label>
                        <textarea id="editBack"></textarea>
                    </div>
                </div>
                <div class="hr"></div>
                <div class="grid" style="grid-template-columns:1fr 1fr">
                    <div class="field">
                        <label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <input id="editTags" />
                    </div>
                    <div class="field">
                        <label>æ‰‹åŠ¨è®¾ç½® nextDueAtï¼ˆISO æˆ–ç•™ç©ºï¼‰</label>
                        <input id="editNextDue" placeholder="ä¾‹å¦‚ï¼š2025-12-10T20:30:00" />
                    </div>
                </div>
                <div class="hr"></div>
                <div class="muted" style="line-height:1.7">
                    ä½ å¯ä»¥ç”¨â€œæ‰‹åŠ¨è®¾ç½® nextDueAtâ€å®ç°ä¸´æ—¶çªå‡»ï¼šæŠŠ nextDue æå‰åˆ°ä»Šå¤©ï¼Œå¤ä¹ é˜Ÿåˆ—å°±ä¼šä¼˜å…ˆå‡ºç°ã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script>
        /** =========================
         *  Utilities
         *  ========================= */
        const $ = (sel, el = document) => el.querySelector(sel);
        const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
        const msDay = 24 * 60 * 60 * 1000;
        const now = () => Date.now();

        function toast(msg, ms = 2200) {
            const t = $("#toast");
            t.textContent = msg;
            t.style.display = "block";
            clearTimeout(toast._to);
            toast._to = setTimeout(() => t.style.display = "none", ms);
        }

        function uuid() {
            // crypto.randomUUID if available
            if (crypto && crypto.randomUUID) return crypto.randomUUID();
            return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c === "x" ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

        function dateKey(ts) {
            const d = new Date(ts);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            return `${y}-${m}-${dd}`;
        }
        function fmt(ts) {
            if (!ts) return "â€”";
            const d = new Date(ts);
            return d.toLocaleString();
        }
        function shortText(s, n = 54) {
            s = (s || "").trim().replace(/\s+/g, " ");
            if (!s) return "ï¼ˆæ— æ–‡æœ¬ï¼‰";
            return s.length > n ? s.slice(0, n) + "â€¦" : s;
        }

        /** =========================
         *  IndexedDB Layer
         *  ========================= */
        const DB_NAME = "anki_ebbinghaus_single_html";
        const DB_VER = 2;
        let db = null;

        function idbReq(req) {
            return new Promise((resolve, reject) => {
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        function tx(storeNames, mode = "readonly") {
            const t = db.transaction(storeNames, mode);
            return t;
        }
        async function openDB() {
            const req = indexedDB.open(DB_NAME, DB_VER);
            req.onupgradeneeded = (e) => {
                const d = req.result;
                if (!d.objectStoreNames.contains("cards")) {
                    const s = d.createObjectStore("cards", { keyPath: "id" });
                    s.createIndex("byNextDue", "nextDueAt", { unique: false });
                    s.createIndex("byUpdated", "updatedAt", { unique: false });
                }
                if (!d.objectStoreNames.contains("assets")) {
                    const s = d.createObjectStore("assets", { keyPath: "id" });
                    s.createIndex("byCreated", "createdAt", { unique: false });
                }
                if (!d.objectStoreNames.contains("reviews")) {
                    const s = d.createObjectStore("reviews", { keyPath: "id", autoIncrement: true });
                    s.createIndex("byDate", "date", { unique: false });
                    s.createIndex("byCard", "cardId", { unique: false });
                }
                if (!d.objectStoreNames.contains("settings")) {
                    d.createObjectStore("settings", { keyPath: "key" });
                }
            };
            db = await idbReq(req);
        }

        async function getSetting(key, fallback) {
            const t = tx(["settings"]);
            const s = t.objectStore("settings");
            const v = await idbReq(s.get(key)).catch(() => null);
            return v ? v.value : fallback;
        }
        async function setSetting(key, value) {
            const t = tx(["settings"], "readwrite");
            t.objectStore("settings").put({ key, value });
            return new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
        }

        async function putCard(card) {
            const t = tx(["cards"], "readwrite");
            t.objectStore("cards").put(card);
            return new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
        }
        async function getCard(id) {
            const t = tx(["cards"]);
            return idbReq(t.objectStore("cards").get(id));
        }
        async function deleteCard(id) {
            const card = await getCard(id);
            if (!card) return;
            // delete assets
            const assetIds = [...(card.frontAssets || []), ...(card.backAssets || [])];
            const t = tx(["cards", "assets"], "readwrite");
            t.objectStore("cards").delete(id);
            const as = t.objectStore("assets");
            for (const aid of assetIds) as.delete(aid);
            return new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
        }
        async function listCards() {
            const t = tx(["cards"]);
            return idbReq(t.objectStore("cards").getAll());
        }
        async function listDueCards() {
            const t = tx(["cards"]);
            const idx = t.objectStore("cards").index("byNextDue");
            const upper = IDBKeyRange.upperBound(Date.now());
            return idbReq(idx.getAll(upper));
        }

        async function putAsset(asset) {
            const t = tx(["assets"], "readwrite");
            t.objectStore("assets").put(asset);
            return new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
        }
        async function getAsset(id) {
            const t = tx(["assets"]);
            return idbReq(t.objectStore("assets").get(id));
        }
        async function addReviewEvent(ev) {
            const t = tx(["reviews"], "readwrite");
            t.objectStore("reviews").add(ev);
            return new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
        }
        async function listReviewsByDate(dkey) {
            const t = tx(["reviews"]);
            const idx = t.objectStore("reviews").index("byDate");
            return idbReq(idx.getAll(IDBKeyRange.only(dkey)));
        }
        async function listReviewsAll() {
            const t = tx(["reviews"]);
            return idbReq(t.objectStore("reviews").getAll());
        }
        async function clearAll() {
            const t = tx(["cards", "assets", "reviews"], "readwrite");
            t.objectStore("cards").clear();
            t.objectStore("assets").clear();
            t.objectStore("reviews").clear();
            return new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
        }

        /** =========================
         *  Settings Defaults
         *  ========================= */
        let SETTINGS = {
            maxKB: 200,
            maxDim: 1600,
            targetR: 0.85,  // Good target retention
            minStab: 0.30   // days
        };

        async function loadSettings() {
            SETTINGS.maxKB = await getSetting("maxKB", SETTINGS.maxKB);
            SETTINGS.maxDim = await getSetting("maxDim", SETTINGS.maxDim);
            SETTINGS.targetR = await getSetting("targetR", SETTINGS.targetR);
            SETTINGS.minStab = await getSetting("minStab", SETTINGS.minStab);

            $("#kpiMaxKB").textContent = SETTINGS.maxKB;
            $("#kpiMaxDim").textContent = SETTINGS.maxDim;

            $("#setMaxKB").value = SETTINGS.maxKB;
            $("#setMaxDim").value = SETTINGS.maxDim;
            $("#setTargetR").value = SETTINGS.targetR;
            $("#setMinStab").value = SETTINGS.minStab;
        }

        /** =========================
         *  Image Compression
         *  ========================= */
        function supportsWebP() {
            // quick test: if toDataURL webp works
            try {
                const c = document.createElement("canvas");
                c.width = c.height = 1;
                return c.toDataURL("image/webp").startsWith("data:image/webp");
            } catch (e) {
                return false;
            }
        }

        async function decodeToBitmap(fileOrBlob) {
            // Prefer createImageBitmap
            try {
                return await createImageBitmap(fileOrBlob);
            } catch (e) {
                // Fallback: HTMLImageElement
                const url = URL.createObjectURL(fileOrBlob);
                const img = new Image();
                img.decoding = "async";
                img.src = url;
                await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });
                const canvas = document.createElement("canvas");
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);
                // createImageBitmap from canvas
                try {
                    return await createImageBitmap(canvas);
                } catch (_) {
                    // return a pseudo-bitmap object by passing canvas
                    return canvas;
                }
            }
        }

        function drawToCanvas(bitmap, targetW, targetH) {
            const c = document.createElement("canvas");
            c.width = targetW; c.height = targetH;
            const ctx = c.getContext("2d");
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = "high";
            ctx.drawImage(bitmap, 0, 0, targetW, targetH);
            return c;
        }

        async function canvasToBlob(canvas, type, quality) {
            return new Promise((res) => {
                canvas.toBlob((b) => res(b), type, quality);
            });
        }

        async function compressImageToLimit(file, maxBytes, maxDim) {
            const bitmap = await decodeToBitmap(file);
            const w0 = bitmap.width || bitmap.naturalWidth || bitmap.videoWidth || bitmap.width;
            const h0 = bitmap.height || bitmap.naturalHeight || bitmap.videoHeight || bitmap.height;

            const maxSide = Math.max(w0, h0);
            const scale0 = maxSide > maxDim ? (maxDim / maxSide) : 1;
            let w = Math.max(1, Math.round(w0 * scale0));
            let h = Math.max(1, Math.round(h0 * scale0));

            const webp = supportsWebP();
            const mime = webp ? "image/webp" : "image/jpeg";

            // iterative: first reduce quality; then if still too large, reduce dimension.
            let q = 0.82;
            let attempts = 0;
            let blob = null;

            while (attempts < 14) {
                attempts++;
                const canvas = drawToCanvas(bitmap, w, h);
                blob = await canvasToBlob(canvas, mime, q);
                if (blob && blob.size <= maxBytes) break;

                // adjust
                if (q > 0.45) q -= 0.08;
                else {
                    // shrink dimensions
                    w = Math.max(1, Math.round(w * 0.85));
                    h = Math.max(1, Math.round(h * 0.85));
                    q = 0.78;
                }
            }

            if (!blob) throw new Error("å‹ç¼©å¤±è´¥ï¼šæ— æ³•ç”Ÿæˆå›¾ç‰‡ blob");
            return { blob, mime };
        }

        async function makeThumbnail(fileOrBlob, maxThumb = 320, maxBytes = 14 * 1024) {
            const bitmap = await decodeToBitmap(fileOrBlob);
            const w0 = bitmap.width || bitmap.naturalWidth || bitmap.width;
            const h0 = bitmap.height || bitmap.naturalHeight || bitmap.height;
            const maxSide = Math.max(w0, h0);
            const scale = maxSide > maxThumb ? (maxThumb / maxSide) : 1;
            const w = Math.max(1, Math.round(w0 * scale));
            const h = Math.max(1, Math.round(h0 * scale));
            const webp = supportsWebP();
            const mime = webp ? "image/webp" : "image/jpeg";

            let q = 0.75;
            let attempts = 0;
            let blob = null;

            while (attempts < 10) {
                attempts++;
                const canvas = drawToCanvas(bitmap, w, h);
                blob = await canvasToBlob(canvas, mime, q);
                if (blob && blob.size <= maxBytes) break;
                q -= 0.08;
                if (q < 0.35) break;
            }
            return { blob: blob || await canvasToBlob(drawToCanvas(bitmap, w, h), mime, 0.55), mime };
        }

        /** =========================
         *  Scheduling (Ebbinghaus)
         *  ========================= */
        function retentionR(tDays, stabilityDays) {
            stabilityDays = Math.max(SETTINGS.minStab, stabilityDays || SETTINGS.minStab);
            return Math.exp(-tDays / stabilityDays);
        }
        function targetRForRate(rate) {
            // Again: very high target retention => short interval
            // Hard: slightly higher than Good
            // Good: SETTINGS.targetR
            // Easy: lower target => longer interval
            if (rate === "again") return 0.98;
            if (rate === "hard") return clamp(SETTINGS.targetR + 0.05, 0.75, 0.93);
            if (rate === "good") return clamp(SETTINGS.targetR, 0.72, 0.92);
            if (rate === "easy") return clamp(SETTINGS.targetR - 0.07, 0.70, 0.90);
            return SETTINGS.targetR;
        }
        function stabilityUpdate(prevStab, prevDiff, rate) {
            // simple, stable, predictable (not a full FSRS)
            let s = Math.max(SETTINGS.minStab, prevStab || SETTINGS.minStab);
            let d = clamp(prevDiff ?? 0.35, 0.05, 0.95);

            if (rate === "again") { s *= 0.72; d = clamp(d + 0.08, 0.05, 0.95); }
            if (rate === "hard") { s *= 1.08; d = clamp(d + 0.02, 0.05, 0.95); }
            if (rate === "good") { s *= 1.22; d = clamp(d - 0.01, 0.05, 0.95); }
            if (rate === "easy") { s *= 1.45; d = clamp(d - 0.05, 0.05, 0.95); }

            // difficulty dampen
            s *= (1.0 - d * 0.10); // hard cards grow slower
            s = clamp(s, SETTINGS.minStab, 3650); // up to ~10 years
            return { stability: s, difficulty: d };
        }
        function nextIntervalDays(stabilityDays, rate) {
            const tR = targetRForRate(rate);
            // t = -s * ln(R)
            const days = -stabilityDays * Math.log(tR);
            // cap min interval so you don't get weird 0
            return clamp(days, (rate === "again" ? 0.006 : 0.02), 3650);
        }

        /** =========================
         *  App State
         *  ========================= */
        let ACTIVE_VIEW = "review";
        let draft = { frontAssets: [], backAssets: [] }; // store asset IDs
        let activePasteSide = "front"; // which dropzone is active
        let dueQueue = [];
        let currentCard = null;
        let showingBack = false;

        // charts
        let chartReviews14 = null;
        let chartDue7 = null;
        let chartRatesToday = null;

        /** =========================
         *  Navigation
         *  ========================= */
        function showView(name) {
            ACTIVE_VIEW = name;
            const ids = ["review", "add", "library", "stats", "settings"];
            for (const id of ids) {
                const v = $("#view-" + id);
                v.style.display = (id === name) ? "" : "none";
            }
            $$(".nav .btn").forEach(b => {
                const on = b.dataset.nav === name;
                b.classList.toggle("primary", on);
            });
            if (name === "library") refreshLibrary();
            if (name === "review") refreshDue();
            if (name === "stats") refreshStats();
            if (name === "settings") reflectSettings();
        }
        $$("[data-nav]").forEach(b => b.addEventListener("click", () => showView(b.dataset.nav)));

        /** =========================
         *  Draft (Add)
         *  ========================= */
        function clearDraftUI() {
            $("#inpFront").value = "";
            $("#inpBack").value = "";
            $("#inpTags").value = "";
            draft.frontAssets = [];
            draft.backAssets = [];
            $("#frontThumbs").innerHTML = "";
            $("#backThumbs").innerHTML = "";
            toast("å·²æ¸…ç©ºè‰ç¨¿");
        }

        async function addFilesToSide(files, side) {
            const maxBytes = SETTINGS.maxKB * 1024;
            const maxDim = SETTINGS.maxDim;

            for (const f of files) {
                if (!f || !f.type || !f.type.startsWith("image/")) continue;

                toast("å›¾ç‰‡å‹ç¼©ä¸­â€¦");
                const { blob, mime } = await compressImageToLimit(f, maxBytes, maxDim);
                const thumb = await makeThumbnail(blob, 320, 14 * 1024);

                const assetId = uuid();
                await putAsset({
                    id: assetId,
                    mime,
                    size: blob.size,
                    createdAt: now(),
                    blob,
                    thumbMime: thumb.mime,
                    thumbSize: thumb.blob.size,
                    thumbBlob: thumb.blob
                });

                if (side === "front") draft.frontAssets.push(assetId);
                else draft.backAssets.push(assetId);

                await renderDraftThumbs();
                toast(`å·²åŠ å…¥ ${side === "front" ? "æ­£é¢" : "èƒŒé¢"}ï¼š${Math.round(blob.size / 1024)}KB`);
            }
        }

        async function renderDraftThumbs() {
            const frontEl = $("#frontThumbs");
            const backEl = $("#backThumbs");
            frontEl.innerHTML = "";
            backEl.innerHTML = "";

            async function addThumb(el, assetId, side) {
                const a = await getAsset(assetId);
                if (!a) return;
                const url = URL.createObjectURL(a.thumbBlob || a.blob);
                const box = document.createElement("div");
                box.className = "thumb";
                box.innerHTML = `<img alt="thumb"/><div class="x">Ã—</div>`;
                box.querySelector("img").src = url;
                box.querySelector(".x").addEventListener("click", async () => {
                    // remove from draft + delete asset (since not yet referenced)
                    if (side === "front") draft.frontAssets = draft.frontAssets.filter(x => x !== assetId);
                    else draft.backAssets = draft.backAssets.filter(x => x !== assetId);
                    // delete asset record
                    const t = tx(["assets"], "readwrite");
                    t.objectStore("assets").delete(assetId);
                    await new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
                    URL.revokeObjectURL(url);
                    renderDraftThumbs();
                });
                el.appendChild(box);
            }

            for (const id of draft.frontAssets) await addThumb(frontEl, id, "front");
            for (const id of draft.backAssets) await addThumb(backEl, id, "back");
        }

        // Dropzone focus
        $("#dropFront").addEventListener("click", () => { activePasteSide = "front"; toast("ç²˜è´´å°†è¿›å…¥ï¼šæ­£é¢"); });
        $("#dropBack").addEventListener("click", () => { activePasteSide = "back"; toast("ç²˜è´´å°†è¿›å…¥ï¼šèƒŒé¢"); });

        // Drag & drop
        function bindDrop(el, side) {
            el.addEventListener("dragover", (e) => { e.preventDefault(); el.style.borderColor = "rgba(110,231,255,.55)"; });
            el.addEventListener("dragleave", () => { el.style.borderColor = "rgba(110,231,255,.30)"; });
            el.addEventListener("drop", async (e) => {
                e.preventDefault();
                el.style.borderColor = "rgba(110,231,255,.30)";
                const files = Array.from(e.dataTransfer.files || []);
                await addFilesToSide(files, side);
            });
        }
        bindDrop($("#dropFront"), "front");
        bindDrop($("#dropBack"), "back");

        // File inputs
        $("#fileFront").addEventListener("change", async (e) => {
            await addFilesToSide(Array.from(e.target.files || []), "front");
            e.target.value = "";
        });
        $("#fileBack").addEventListener("change", async (e) => {
            await addFilesToSide(Array.from(e.target.files || []), "back");
            e.target.value = "";
        });

        $("#btnClearDraft").addEventListener("click", clearDraftUI);

        $("#btnTestPaste").addEventListener("click", () => {
            toast("å…ˆç‚¹ä¸€ä¸‹æ­£é¢æˆ–èƒŒé¢çš„å¯¼å…¥åŒºï¼Œå† Ctrl/âŒ˜+V ç²˜è´´æˆªå›¾å³å¯");
        });

        // Paste handler (global)
        window.addEventListener("paste", async (e) => {
            if (ACTIVE_VIEW !== "add") return;
            const items = e.clipboardData?.items;
            if (!items) return;

            const files = [];
            for (const it of items) {
                if (it.kind === "file") {
                    const f = it.getAsFile();
                    if (f && f.type && f.type.startsWith("image/")) files.push(f);
                }
            }
            if (files.length) {
                e.preventDefault();
                await addFilesToSide(files, activePasteSide);
            }
        });

        /** =========================
         *  Create Card
         *  ========================= */
        $("#btnSaveCard").addEventListener("click", async () => {
            const frontText = $("#inpFront").value.trim();
            const backText = $("#inpBack").value.trim();
            const tags = $("#inpTags").value.split(",").map(s => s.trim()).filter(Boolean);

            if (!frontText && draft.frontAssets.length === 0) {
                toast("è‡³å°‘å†™ç‚¹æ­£é¢æ–‡æœ¬ï¼Œæˆ–ç²˜è´´/ä¸Šä¼ ä¸€å¼ æ­£é¢å›¾ç‰‡");
                return;
            }
            const id = uuid();
            const createdAt = now();

            const card = {
                id,
                frontText,
                backText,
                tags,
                createdAt,
                updatedAt: createdAt,
                frontAssets: [...draft.frontAssets],
                backAssets: [...draft.backAssets],
                stability: SETTINGS.minStab,
                difficulty: 0.35,
                reps: 0,
                lapses: 0,
                lastReviewedAt: null,
                nextDueAt: createdAt, // new cards due now
            };

            await putCard(card);
            clearDraftUI();
            toast("å·²ä¿å­˜å¡ç‰‡ âœ…");
            showView("review");
        });

        /** =========================
         *  Review Queue
         *  ========================= */
        async function refreshDue() {
            dueQueue = await listDueCards();
            dueQueue.sort((a, b) => (a.nextDueAt || 0) - (b.nextDueAt || 0));
            $("#duePill").textContent = `Due: ${dueQueue.length}`;
            $("#kpiDueNow").textContent = dueQueue.length;

            // today done
            const today = dateKey(now());
            const rs = await listReviewsByDate(today);
            $("#kpiTodayDone").textContent = rs.length;

            if (!dueQueue.length) {
                $("#reviewEmpty").style.display = "";
                $("#reviewWrap").style.display = "none";
                currentCard = null;
                return;
            }
            $("#reviewEmpty").style.display = "none";
            $("#reviewWrap").style.display = "";

            await showNextCard();
            await renderSuggestions();
        }

        $("#btnReloadDue").addEventListener("click", refreshDue);
        $("#btnStartDue").addEventListener("click", () => showView("review"));

        async function showNextCard() {
            currentCard = dueQueue[0] || null;
            showingBack = false;

            $("#btnShowFront").classList.add("active");
            $("#btnShowBack").classList.remove("active");
            $("#btnShowBack").disabled = true;

            $("#rateButtons").style.display = "none";
            $("#btnReveal").style.display = "";

            if (!currentCard) return;

            const dueIn = currentCard.nextDueAt ? (currentCard.nextDueAt - now()) : 0;
            const meta = [
                `ID: ${currentCard.id.slice(0, 8)}`,
                `reps: ${currentCard.reps || 0}`,
                `stability: ${(currentCard.stability || SETTINGS.minStab).toFixed(2)}d`,
                `due: ${fmt(currentCard.nextDueAt)}`,
                dueIn > 0 ? `ï¼ˆè¿˜æœ‰ ${Math.round(dueIn / 60000)} åˆ†é’Ÿåˆ°æœŸï¼‰` : "ï¼ˆå·²åˆ°æœŸï¼‰"
            ].join(" Â· ");
            $("#reviewMeta").textContent = meta;

            await renderReviewFace();
        }

        async function renderReviewFace() {
            const c = currentCard;
            if (!c) return;

            const isBack = showingBack;
            const text = isBack ? (c.backText || "") : (c.frontText || "");
            const assetIds = isBack ? (c.backAssets || []) : (c.frontAssets || []);

            $("#reviewText").textContent = text || (assetIds.length ? "" : "ï¼ˆæ— å†…å®¹ï¼‰");
            const imgs = $("#reviewImgs");
            imgs.innerHTML = "";

            for (const aid of assetIds) {
                const a = await getAsset(aid);
                if (!a) continue;
                const url = URL.createObjectURL(a.blob);
                const img = document.createElement("img");
                img.src = url;
                img.alt = "asset";
                img.loading = "lazy";
                img.addEventListener("load", () => {/* keep */ });
                imgs.appendChild(img);
            }
        }

        $("#btnReveal").addEventListener("click", () => {
            if (!currentCard) return;
            showingBack = true;
            $("#btnShowBack").disabled = false;
            $("#btnShowBack").classList.add("active");
            $("#btnShowFront").classList.remove("active");
            renderReviewFace();
            $("#rateButtons").style.display = "grid";
            $("#btnReveal").style.display = "none";
        });

        $("#btnShowFront").addEventListener("click", () => {
            if (!currentCard) return;
            showingBack = false;
            $("#btnShowFront").classList.add("active");
            $("#btnShowBack").classList.remove("active");
            renderReviewFace();
        });
        $("#btnShowBack").addEventListener("click", () => {
            if (!currentCard) return;
            showingBack = true;
            $("#btnShowBack").classList.add("active");
            $("#btnShowFront").classList.remove("active");
            renderReviewFace();
        });

        async function rateCurrent(rate) {
            const c = currentCard;
            if (!c) return;

            const ts = now();
            const prevStab = c.stability || SETTINGS.minStab;
            const prevDiff = c.difficulty ?? 0.35;
            const prevLast = c.lastReviewedAt;

            const tDays = prevLast ? ((ts - prevLast) / msDay) : 999;
            const predicted = prevLast ? retentionR(tDays, prevStab) : null;

            // update stability/difficulty
            const upd = stabilityUpdate(prevStab, prevDiff, rate);
            c.stability = upd.stability;
            c.difficulty = upd.difficulty;

            // reps/lapses
            c.reps = (c.reps || 0) + 1;
            if (rate === "again") c.lapses = (c.lapses || 0) + 1;

            // next due
            const intervalDays = nextIntervalDays(c.stability, rate);
            c.lastReviewedAt = ts;
            c.nextDueAt = ts + intervalDays * msDay;
            c.updatedAt = ts;

            await putCard(c);

            // add review event
            await addReviewEvent({
                date: dateKey(ts),
                ts,
                cardId: c.id,
                rate,
                predictedR: predicted,
                prevStability: prevStab,
                prevLastReviewedAt: prevLast
            });

            // pop from queue
            dueQueue.shift();
            toast(`å·²è¯„åˆ†ï¼š${rate.toUpperCase()} Â· ä¸‹æ¬¡åˆ°æœŸï¼š${new Date(c.nextDueAt).toLocaleString()}`);
            await refreshDue();
        }

        $("#rateButtons").addEventListener("click", async (e) => {
            const btn = e.target.closest("button[data-rate]");
            if (!btn) return;
            await rateCurrent(btn.dataset.rate);
        });

        // Keyboard shortcuts
        window.addEventListener("keydown", (e) => {
            if (ACTIVE_VIEW !== "review") return;
            if (!currentCard) return;

            if (e.code === "Space") {
                e.preventDefault();
                if (!showingBack) $("#btnReveal").click();
            }
            if (showingBack) {
                if (e.key === "1") rateCurrent("again");
                if (e.key === "2") rateCurrent("hard");
                if (e.key === "3") rateCurrent("good");
                if (e.key === "4") rateCurrent("easy");
            }
        });

        /** =========================
         *  Suggestions / Quick Report
         *  ========================= */
        async function renderSuggestions() {
            const wrap = $("#suggestions");
            wrap.innerHTML = "";

            const cards = await listCards();
            if (!cards.length) {
                wrap.innerHTML = `<div class="muted">æš‚æ— æ•°æ®ã€‚</div>`;
                return;
            }
            const ts = now();

            // 1) High risk soon: predicted R tomorrow below target
            const soon = [];
            for (const c of cards) {
                if (!c.lastReviewedAt) continue;
                const tDays = (ts - c.lastReviewedAt) / msDay;
                const rNow = retentionR(tDays, c.stability || SETTINGS.minStab);
                // estimate at 1 day later
                const rTomorrow = retentionR(tDays + 1, c.stability || SETTINGS.minStab);
                if (rTomorrow < SETTINGS.targetR) soon.push({ c, rNow, rTomorrow });
            }
            soon.sort((a, b) => a.rTomorrow - b.rTomorrow);

            const top = soon.slice(0, 6);
            if (top.length) {
                const box = document.createElement("div");
                box.className = "box";
                box.style.border = "1px solid var(--line)";
                box.style.borderRadius = "16px";
                box.style.background = "rgba(255,255,255,.03)";
                box.style.padding = "12px";
                box.innerHTML = `<div style="font-weight:800; margin-bottom:8px">âš ï¸ æ˜å¤©å®¹æ˜“æ‰çº¿çš„å¡ï¼ˆä¼˜å…ˆè¡¥ï¼‰</div>`;
                const ul = document.createElement("div");
                ul.className = "col";
                ul.style.gap = "8px";
                for (const it of top) {
                    const c = it.c;
                    const tags = (c.tags || []).slice(0, 3).map(t => `<span class="chip">${t}</span>`).join(" ");
                    const line = document.createElement("div");
                    line.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
          <div>
            <div style="font-weight:750">${shortText(c.frontText || c.backText, 44)}</div>
            <div class="muted" style="font-size:12px; margin-top:3px">
              R(æ˜å¤©)â‰ˆ${(it.rTomorrow * 100).toFixed(0)}% Â· stability=${(c.stability || SETTINGS.minStab).toFixed(2)}d
            </div>
            <div style="margin-top:6px">${tags}</div>
          </div>
          <button class="btn small" data-bump="${c.id}">è®¾ä¸ºä»Šæ—¥åˆ°æœŸ</button>
        </div>
      `;
                    ul.appendChild(line);
                }
                box.appendChild(ul);
                wrap.appendChild(box);

                box.addEventListener("click", async (e) => {
                    const b = e.target.closest("button[data-bump]");
                    if (!b) return;
                    const id = b.dataset.bump;
                    const c = await getCard(id);
                    if (!c) return;
                    c.nextDueAt = now(); c.updatedAt = now();
                    await putCard(c);
                    toast("å·²æå‰åˆ°æœŸï¼šè¯¥å¡ä¼šå‡ºç°åœ¨å¤ä¹ é˜Ÿåˆ—");
                    refreshDue();
                });
            } else {
                wrap.innerHTML = `<div class="muted">âœ… æš‚æœªå‘ç°â€œæ˜å¤©æ˜¾è‘—æ‰çº¿â€çš„å¡ã€‚ç»§ç»­ä¿æŒèŠ‚å¥ã€‚</div>`;
            }
        }

        $("#btnQuickReport").addEventListener("click", async () => {
            // â€œ20:30 æŠ¥å‘Šâ€ç®€åŒ–ï¼šéšæ—¶ç‚¹å‡»ç”Ÿæˆï¼ˆä½ å¯è‡ªè¡Œåœ¨ 20:30 æ‰“å¼€å®ƒï¼‰
            await refreshStats();
            toast("å·²åˆ·æ–°ï¼šä»Šæ—¥æŠ¥å‘Šï¼ˆå¯åœ¨ç»Ÿè®¡é¡µæŸ¥çœ‹å›¾è¡¨ï¼‰");
        });

        /** =========================
         *  Library
         *  ========================= */
        async function refreshLibrary() {
            const listEl = $("#libList");
            const emptyEl = $("#libEmpty");
            listEl.innerHTML = "";
            emptyEl.style.display = "none";

            const q = ($("#inpSearch").value || "").trim().toLowerCase();
            const filter = $("#selFilter").value;
            let cards = await listCards();

            const ts = now();
            cards.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

            // filter
            cards = cards.filter(c => {
                if (filter === "due" && (c.nextDueAt || 0) > ts) return false;
                if (filter === "new" && (c.reps || 0) > 0) return false;

                if (!q) return true;
                const hay = [
                    c.frontText || "", c.backText || "", (c.tags || []).join(",")
                ].join(" ").toLowerCase();
                return hay.includes(q);
            });

            if (!cards.length) {
                emptyEl.style.display = "";
                return;
            }

            for (const c of cards) {
                const firstAsset = (c.frontAssets && c.frontAssets[0]) || (c.backAssets && c.backAssets[0]) || null;
                let imgUrl = null;
                if (firstAsset) {
                    const a = await getAsset(firstAsset);
                    if (a) {
                        imgUrl = URL.createObjectURL(a.thumbBlob || a.blob);
                    }
                }
                const due = (c.nextDueAt || 0) <= ts ? "åˆ°æœŸ" : "æœªåˆ°æœŸ";
                const tags = (c.tags || []).slice(0, 4).map(t => `<span class="chip">${t}</span>`).join(" ");

                const div = document.createElement("div");
                div.className = "item";
                div.innerHTML = `
      <div class="img">${imgUrl ? `<img alt="thumb" src="${imgUrl}">` : ""}</div>
      <div>
        <div class="t">${shortText(c.frontText || c.backText, 60)}</div>
        <div class="s">
          ${due} Â· reps=${c.reps || 0} Â· stability=${(c.stability || SETTINGS.minStab).toFixed(2)}d Â· next=${fmt(c.nextDueAt)}
        </div>
        <div style="margin-top:8px">${tags}</div>
      </div>
      <div class="actions" style="display:flex; gap:8px; justify-content:flex-end">
        <button class="btn small" data-edit="${c.id}">ç¼–è¾‘</button>
        <button class="btn small" data-due="${c.id}">è®¾ä¸ºåˆ°æœŸ</button>
      </div>
    `;
                listEl.appendChild(div);
            }

            // actions
            listEl.addEventListener("click", async (e) => {
                const ed = e.target.closest("button[data-edit]");
                const du = e.target.closest("button[data-due]");
                if (ed) {
                    await openEdit(ed.dataset.edit);
                }
                if (du) {
                    const id = du.dataset.due;
                    const c = await getCard(id);
                    if (!c) return;
                    c.nextDueAt = now(); c.updatedAt = now();
                    await putCard(c);
                    toast("å·²è®¾ä¸ºåˆ°æœŸ");
                    refreshLibrary();
                }
            }, { once: true }); // avoid duplicate binding
        }

        $("#btnRefreshLib").addEventListener("click", refreshLibrary);
        $("#inpSearch").addEventListener("input", () => refreshLibrary());
        $("#selFilter").addEventListener("change", () => refreshLibrary());

        /** =========================
         *  Edit Modal
         *  ========================= */
        let editCardId = null;

        async function openEdit(id) {
            editCardId = id;
            const c = await getCard(id);
            if (!c) return;
            $("#editId").textContent = "ID: " + c.id;
            $("#editFront").value = c.frontText || "";
            $("#editBack").value = c.backText || "";
            $("#editTags").value = (c.tags || []).join(", ");
            $("#editNextDue").value = c.nextDueAt ? new Date(c.nextDueAt).toISOString().slice(0, 19) : "";
            $("#editModal").style.display = "block";
        }
        function closeEdit() {
            $("#editModal").style.display = "none";
            editCardId = null;
        }
        $("#btnCloseEdit").addEventListener("click", closeEdit);
        $("#editModal").addEventListener("click", (e) => {
            if (e.target === $("#editModal")) closeEdit();
        });

        $("#btnSaveEdit").addEventListener("click", async () => {
            if (!editCardId) return;
            const c = await getCard(editCardId);
            if (!c) return;

            c.frontText = $("#editFront").value.trim();
            c.backText = $("#editBack").value.trim();
            c.tags = $("#editTags").value.split(",").map(s => s.trim()).filter(Boolean);

            const nd = $("#editNextDue").value.trim();
            if (nd) {
                const t = Date.parse(nd);
                if (!Number.isNaN(t)) c.nextDueAt = t;
                else toast("nextDueAt æ ¼å¼ä¸æ­£ç¡®ï¼Œå°†å¿½ç•¥");
            }
            c.updatedAt = now();
            await putCard(c);
            toast("å·²ä¿å­˜ä¿®æ”¹");
            closeEdit();
            refreshLibrary();
            refreshDue();
        });

        $("#btnDeleteCard").addEventListener("click", async () => {
            if (!editCardId) return;
            if (!confirm("ç¡®è®¤åˆ é™¤è¯¥å¡ç‰‡ï¼Ÿï¼ˆä¼šåŒæ—¶åˆ é™¤å®ƒçš„å›¾ç‰‡èµ„æºï¼‰")) return;
            await deleteCard(editCardId);
            toast("å·²åˆ é™¤å¡ç‰‡");
            closeEdit();
            refreshLibrary();
            refreshDue();
        });

        /** =========================
         *  Stats + Charts
         *  ========================= */
        async function refreshStats() {
            const cards = await listCards();
            const ts = now();
            const today = dateKey(ts);

            $("#statTotalCards").textContent = cards.length;

            // due today
            const start = new Date(); start.setHours(0, 0, 0, 0);
            const end = new Date(); end.setHours(23, 59, 59, 999);
            const dueToday = cards.filter(c => (c.nextDueAt || 0) <= end.getTime()).length;
            $("#statDueToday").textContent = dueToday;

            // reviews today
            const reviewsToday = await listReviewsByDate(today);
            const success = reviewsToday.filter(r => r.rate !== "again").length;
            const successRate = reviewsToday.length ? (success / reviewsToday.length) : 0;
            $("#statSuccessToday").textContent = (successRate * 100).toFixed(0) + "%";

            // predicted today (average predictedR from events where available)
            const preds = reviewsToday.map(r => r.predictedR).filter(v => typeof v === "number");
            const predAvg = preds.length ? preds.reduce((a, b) => a + b, 0) / preds.length : null;
            $("#statPredictedToday").textContent = (predAvg == null) ? "â€”" : (predAvg * 100).toFixed(0) + "%";

            await drawCharts(cards, reviewsToday);
        }

        function destroyChart(ch) {
            if (ch) { try { ch.destroy(); } catch (e) { } }
        }

        async function drawCharts(cards, reviewsToday) {
            // 1) Reviews per day last 14 days
            const allReviews = await listReviewsAll();
            const days = [];
            for (let i = 13; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                days.push(dateKey(d.getTime()));
            }
            const cnt = new Map();
            for (const r of allReviews) {
                cnt.set(r.date, (cnt.get(r.date) || 0) + 1);
            }
            const series = days.map(d => cnt.get(d) || 0);

            destroyChart(chartReviews14);
            chartReviews14 = new Chart($("#chartReviews14"), {
                type: "line",
                data: {
                    labels: days.map(d => d.slice(5)),
                    datasets: [{
                        label: "å¤ä¹ æ¬¡æ•°",
                        data: series,
                        tension: 0.28,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: "rgba(255,255,255,.06)" } },
                        y: { grid: { color: "rgba(255,255,255,.06)" }, beginAtZero: true }
                    }
                }
            });

            // 2) Due forecast next 7 days
            const buckets = new Array(7).fill(0);
            const labels7 = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + i);
                labels7.push(dateKey(d.getTime()).slice(5));
            }

            const base = new Date(); base.setHours(0, 0, 0, 0);
            for (const c of cards) {
                const due = c.nextDueAt || 0;
                if (!due) continue;
                const idx = Math.floor((due - base.getTime()) / msDay);
                if (idx >= 0 && idx < 7) buckets[idx]++;
            }

            destroyChart(chartDue7);
            chartDue7 = new Chart($("#chartDue7"), {
                type: "bar",
                data: {
                    labels: labels7,
                    datasets: [{ label: "åˆ°æœŸå¡æ•°é‡", data: buckets }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: "rgba(255,255,255,.06)" } },
                        y: { grid: { color: "rgba(255,255,255,.06)" }, beginAtZero: true }
                    }
                }
            });

            // 3) Rating distribution today
            const dist = { again: 0, hard: 0, good: 0, easy: 0 };
            for (const r of reviewsToday) {
                if (dist[r.rate] != null) dist[r.rate]++;
            }
            destroyChart(chartRatesToday);
            chartRatesToday = new Chart($("#chartRatesToday"), {
                type: "doughnut",
                data: {
                    labels: ["Again", "Hard", "Good", "Easy"],
                    datasets: [{ data: [dist.again, dist.hard, dist.good, dist.easy] }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: "bottom" } }
                }
            });
        }

        $("#btnRefreshStats").addEventListener("click", refreshStats);

        /** =========================
         *  Export / Import
         *  ========================= */
        async function exportZip() {
            const zip = new JSZip();
            const cards = await listCards();
            const reviews = await listReviewsAll();

            zip.file("cards.json", JSON.stringify({
                version: 1,
                exportedAt: new Date().toISOString(),
                cards
            }, null, 2));

            zip.file("reviews.json", JSON.stringify({
                version: 1,
                exportedAt: new Date().toISOString(),
                reviews
            }, null, 2));

            // assets: gather all referenced asset IDs
            const assetIds = new Set();
            for (const c of cards) {
                for (const id of (c.frontAssets || [])) assetIds.add(id);
                for (const id of (c.backAssets || [])) assetIds.add(id);
            }

            const assetsFolder = zip.folder("assets");
            let i = 0;
            for (const id of assetIds) {
                i++;
                const a = await getAsset(id);
                if (!a) continue;
                const ext = (a.mime === "image/webp") ? "webp" : "jpg";
                const tExt = (a.thumbMime === "image/webp") ? "webp" : "jpg";
                assetsFolder.file(`${id}.${ext}`, a.blob);
                assetsFolder.file(`${id}_thumb.${tExt}`, a.thumbBlob || a.blob);
            }

            const blob = await zip.generateAsync({ type: "blob", compression: "DEFLATE", compressionOptions: { level: 6 } });
            const a = document.createElement("a");
            const name = `anki-ebbinghaus-backup-${dateKey(now())}.zip`;
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
            setTimeout(() => URL.revokeObjectURL(a.href), 1500);
            toast("å·²å¯¼å‡º ZIP âœ…");
        }

        $("#btnExportZip").addEventListener("click", exportZip);

        async function importZip(file) {
            const buf = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(buf);

            const cardsTxt = await zip.file("cards.json")?.async("string");
            const reviewsTxt = await zip.file("reviews.json")?.async("string");

            if (!cardsTxt) throw new Error("ZIP ä¸­ç¼ºå°‘ cards.json");

            const cardsObj = JSON.parse(cardsTxt);
            const cards = cardsObj.cards || [];
            const reviewsObj = reviewsTxt ? JSON.parse(reviewsTxt) : { reviews: [] };
            const reviews = reviewsObj.reviews || [];

            // Replace: clear first
            await clearAll();

            // restore cards
            for (const c of cards) {
                // ensure required fields
                c.updatedAt = c.updatedAt || c.createdAt || now();
                c.stability = c.stability || SETTINGS.minStab;
                c.difficulty = (c.difficulty == null) ? 0.35 : c.difficulty;
                c.frontAssets = c.frontAssets || [];
                c.backAssets = c.backAssets || [];
                await putCard(c);
            }

            // restore assets
            const assetsFolder = zip.folder("assets");
            if (assetsFolder) {
                const files = [];
                assetsFolder.forEach((path, file) => files.push({ path, file }));
                // group by id
                const byId = new Map();
                for (const f of files) {
                    const name = f.path.split("/").pop();
                    if (!name) continue;
                    // id_thumb.ext or id.ext
                    const isThumb = name.includes("_thumb.");
                    const id = name.replace("_thumb", "").split(".")[0];
                    const ext = name.split(".").pop().toLowerCase();
                    const mime = ext === "webp" ? "image/webp" : "image/jpeg";

                    if (!byId.has(id)) byId.set(id, {});
                    const obj = byId.get(id);
                    if (isThumb) obj.thumb = { file: f.file, mime };
                    else obj.main = { file: f.file, mime };
                }

                for (const [id, obj] of byId.entries()) {
                    const mainBlob = obj.main ? await obj.main.file.async("blob") : null;
                    const thumbBlob = obj.thumb ? await obj.thumb.file.async("blob") : null;
                    if (!mainBlob) continue;
                    await putAsset({
                        id,
                        mime: obj.main.mime,
                        size: mainBlob.size,
                        createdAt: now(),
                        blob: mainBlob,
                        thumbMime: obj.thumb?.mime || obj.main.mime,
                        thumbSize: thumbBlob ? thumbBlob.size : mainBlob.size,
                        thumbBlob: thumbBlob || mainBlob
                    });
                }
            }

            // restore reviews
            if (reviews.length) {
                const t = tx(["reviews"], "readwrite");
                const os = t.objectStore("reviews");
                for (const r of reviews) {
                    // keep original id? reviews store is autoIncrement; just add without id
                    const copy = { ...r };
                    delete copy.id;
                    os.add(copy);
                }
                await new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); });
            }

            toast("å·²å¯¼å…¥å¹¶æ¢å¤ âœ…");
            await refreshDue();
            await refreshLibrary();
            await refreshStats();
        }

        $("#fileImportZip").addEventListener("change", async (e) => {
            const f = e.target.files?.[0];
            e.target.value = "";
            if (!f) return;
            if (!confirm("å¯¼å…¥ä¼šè¦†ç›–å½“å‰å…¨éƒ¨æ•°æ®ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ")) return;
            try {
                toast("å¯¼å…¥ä¸­â€¦");
                await importZip(f);
            } catch (err) {
                console.error(err);
                toast("å¯¼å…¥å¤±è´¥ï¼š" + (err?.message || String(err)), 4000);
            }
        });

        /** =========================
         *  Settings UI
         *  ========================= */
        function reflectSettings() {
            $("#setMaxKB").value = SETTINGS.maxKB;
            $("#setMaxDim").value = SETTINGS.maxDim;
            $("#setTargetR").value = SETTINGS.targetR;
            $("#setMinStab").value = SETTINGS.minStab;
        }
        $("#btnSaveSettings").addEventListener("click", async () => {
            const maxKB = clamp(parseInt($("#setMaxKB").value, 10) || 200, 50, 800);
            const maxDim = clamp(parseInt($("#setMaxDim").value, 10) || 1600, 640, 4096);
            const targetR = clamp(parseFloat($("#setTargetR").value) || 0.85, 0.70, 0.95);
            const minStab = clamp(parseFloat($("#setMinStab").value) || 0.30, 0.05, 5);

            SETTINGS.maxKB = maxKB;
            SETTINGS.maxDim = maxDim;
            SETTINGS.targetR = targetR;
            SETTINGS.minStab = minStab;

            await setSetting("maxKB", maxKB);
            await setSetting("maxDim", maxDim);
            await setSetting("targetR", targetR);
            await setSetting("minStab", minStab);

            $("#kpiMaxKB").textContent = SETTINGS.maxKB;
            $("#kpiMaxDim").textContent = SETTINGS.maxDim;

            toast("è®¾ç½®å·²ä¿å­˜ âœ…");
        });

        $("#btnResetAll").addEventListener("click", async () => {
            if (!confirm("ç¡®è®¤æ¸…ç©ºæ•°æ®åº“ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ˆé™¤éä½ æœ‰ ZIP å¤‡ä»½ï¼‰ã€‚")) return;
            await clearAll();
            toast("å·²æ¸…ç©ºæœ¬åœ°æ•°æ®");
            await refreshDue();
            await refreshLibrary();
            await refreshStats();
        });

        /** =========================
         *  Boot
         *  ========================= */
        async function boot() {
            await openDB();
            await loadSettings();
            await renderDraftThumbs();
            showView("review");
        }
        boot().catch(err => {
            console.error(err);
            toast("åˆå§‹åŒ–å¤±è´¥ï¼š" + (err?.message || String(err)), 5000);
        });
    </script>
</body>

</html>