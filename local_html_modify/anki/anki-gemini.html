<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ebbinghaus Anki Lite</title>
    <!-- 引入 Chart.js 用于图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #ca8a04;
            --danger: #dc2626;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3b82f6;
                --bg: #111827;
                --card-bg: #1f2937;
                --text: #f9fafb;
            }
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 布局 */
        header {
            padding: 1rem;
            background: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        /* 底部导航 */
        nav {
            display: flex;
            justify-content: space-around;
            background: var(--card-bg);
            padding: 0.8rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        nav button {
            background: none;
            border: none;
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.6;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        nav button.active {
            opacity: 1;
            color: var(--primary);
            font-weight: bold;
        }

        nav button svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            fill: currentColor;
        }

        /* 卡片通用样式 */
        .card-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* 按钮通用 */
        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            width: 100%;
            margin-top: 0.5rem;
            font-size: 1rem;
        }

        .btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            border: 1px solid var(--text);
            background: transparent;
            color: var(--text);
        }

        /* 添加页面 */
        .input-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            background: var(--bg);
            color: var(--text);
            min-height: 80px;
            resize: vertical;
        }

        #paste-area {
            border: 2px dashed #ccc;
            padding: 2rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            color: #888;
            margin-top: 0.5rem;
        }

        #paste-area.highlight {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .preview-img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
            display: block;
        }

        /* 复习页面 */
        .flashcard {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }

        .flashcard img {
            max-width: 100%;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 8px;
            margin: 10px 0;
            cursor: zoom-in;
        }

        .flashcard-content {
            width: 100%;
        }

        .answer-section {
            border-top: 1px solid #eee;
            padding-top: 1rem;
            margin-top: 1rem;
            width: 100%;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 1rem;
        }

        .cram-mode-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--warning);
            color: white;
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
        }

        /* 统计页面 */
        .stat-card {
            text-align: center;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .stat-big {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 1rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }

        /* 设置 */
        .file-controls {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <header>
        <h1 id="page-title">仪表盘</h1>
        <span id="header-stat" style="font-size: 0.8rem; opacity: 0.8;"></span>
    </header>

    <main id="app">
        <!-- 1. 仪表盘 (Home) -->
        <div id="view-home" class="view">
            <div class="card-panel" style="text-align: center;">
                <p>今日待复习</p>
                <div class="stat-big" id="due-count">0</div>
                <button class="btn btn-primary" onclick="startSession('normal')">开始今日复习</button>
            </div>

            <div class="card-panel">
                <h3>摸鱼突击模式</h3>
                <p style="font-size: 0.9rem; color: #888;">不记录进度，随机抽取卡片进行快速记忆。</p>
                <button class="btn btn-warning" onclick="startSession('cram')">⚡ 临时突击 (Cram)</button>
            </div>

            <div class="card-panel">
                <h3>数据概览</h3>
                <canvas id="miniChart" height="100"></canvas>
            </div>
        </div>

        <!-- 2. 添加卡片 (Add) -->
        <div id="view-add" class="view hidden">
            <div class="card-panel">
                <div class="input-group">
                    <label>问题 (Front)</label>
                    <textarea id="inp-question" placeholder="输入问题..."></textarea>
                    <!-- 粘贴区域 -->
                    <div id="paste-area" tabindex="0">
                        点击此处后 Ctrl+V 粘贴图片<br>
                        (会自动压缩至 200KB 内)
                    </div>
                    <img id="preview-q" class="preview-img hidden">
                </div>
                <div class="input-group">
                    <label>答案 (Back)</label>
                    <textarea id="inp-answer" placeholder="输入答案..."></textarea>
                    <img id="preview-a" class="preview-img hidden">
                </div>
                <button class="btn btn-primary" onclick="saveCard()">保存卡片</button>
            </div>
        </div>

        <!-- 3. 复习界面 (Review) -->
        <div id="view-review" class="view hidden">
            <div class="card-panel flashcard" id="flashcard">
                <!-- 内容动态填充 -->
            </div>
        </div>

        <!-- 4. 统计 (Stats) -->
        <div id="view-stats" class="view hidden">
            <div class="card-panel">
                <h3>记忆状态 (20:30 快照)</h3>
                <p style="font-size:0.8rem; color:#666">艾宾浩斯曲线对比</p>
                <div class="chart-container">
                    <canvas id="retentionChart"></canvas>
                </div>
            </div>
            <div class="card-panel">
                <h3>未来复习压力</h3>
                <div class="chart-container">
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 5. 设置/数据 (Settings) -->
        <div id="view-settings" class="view hidden">
            <div class="card-panel">
                <h3>数据管理</h3>
                <div class="stat-card">
                    总卡片数: <span id="total-cards-num">0</span>
                </div>
                <div class="file-controls">
                    <button class="btn btn-outline" onclick="exportData()">导出数据 (JSON)</button>
                    <button class="btn btn-outline"
                        onclick="document.getElementById('import-file').click()">导入数据</button>
                    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
                    <button class="btn btn-danger" onclick="clearDb()">清空所有数据</button>
                </div>
            </div>
            <div class="card-panel">
                <h3>关于</h3>
                <p>基于本地 IndexedDB 存储。图片经 Canvas 压缩存储。无需联网即可使用。</p>
            </div>
        </div>
    </main>

    <nav>
        <button onclick="switchView('home')" id="nav-home" class="active">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            首页
        </button>
        <button onclick="switchView('add')" id="nav-add">
            <svg viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </svg>
            添加
        </button>
        <button onclick="switchView('stats')" id="nav-stats">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
            </svg>
            统计
        </button>
        <button onclick="switchView('settings')" id="nav-settings">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .34.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.22 0-.45-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
            </svg>
            数据
        </button>
    </nav>

    <script>
        /**
         * 数据库与核心逻辑
         */
        const DB_NAME = 'EbbinghausAnkiDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'cards';

        let db;
        let currentSession = [];
        let currentCardIndex = 0;
        let isCramming = false;
        let currentImageBlob = null; // 临时存储待保存图片

        // 1. 初始化数据库
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject(e);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('nextReview', 'nextReview', { unique: false });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    updateHomeStats();
                    resolve(db);
                };
            });
        }

        // 2. 图片压缩逻辑
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // 尺寸限制 (比如最大宽度 1000)
                        const MAX_WIDTH = 1000;
                        if (width > MAX_WIDTH) {
                            height = Math.round(height * (MAX_WIDTH / width));
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // 质量循环递减直到 < 200KB
                        let quality = 0.8;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);

                        while (dataUrl.length > 200 * 1024 * 1.37 && quality > 0.1) { // Base64 大约是原大小的 1.37 倍
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        resolve(dataUrl);
                    };
                };
            });
        }

        // 3. 粘贴事件监听
        document.getElementById('paste-area').addEventListener('paste', async (e) => {
            e.preventDefault();
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    document.getElementById('paste-area').innerText = "处理中...";
                    const compressedDataUrl = await compressImage(blob);
                    currentImageBlob = compressedDataUrl;

                    const imgPreview = document.getElementById('preview-q');
                    imgPreview.src = compressedDataUrl;
                    imgPreview.classList.remove('hidden');
                    document.getElementById('paste-area').innerText = "图片已就绪 (点击可替换)";
                    return;
                }
            }
        });

        // 点击区域也可以触发文件选择（模拟粘贴体验不足时的补充）
        document.getElementById('paste-area').addEventListener('click', () => {
            // 实际场景移动端很难触发paste，这里为了简化，移动端建议直接用Input File，但为了保持单文件简洁，暂略。
            // 如果需要支持移动端上传图片，可添加一个隐藏的 input type="file"
        });

        // 4. 卡片操作
        function addCardToDB(card) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(card);
                request.onsuccess = () => resolve();
                request.onerror = () => reject();
            });
        }

        async function saveCard() {
            const q = document.getElementById('inp-question').value;
            const a = document.getElementById('inp-answer').value;

            if (!q && !currentImageBlob) { alert('请输入问题或粘贴图片'); return; }

            const card = {
                question: q,
                answer: a,
                image: currentImageBlob,
                created: Date.now(),
                nextReview: Date.now(), // 立即复习
                interval: 0, // 天数
                reps: 0, // 复习次数
                ease: 2.5, // 难度系数
                history: []
            };

            await addCardToDB(card);

            // Reset UI
            document.getElementById('inp-question').value = '';
            document.getElementById('inp-answer').value = '';
            document.getElementById('preview-q').src = '';
            document.getElementById('preview-q').classList.add('hidden');
            document.getElementById('paste-area').innerText = "点击此处后 Ctrl+V 粘贴图片\n(会自动压缩至 200KB 内)";
            currentImageBlob = null;
            alert('卡片已添加');
            updateHomeStats();
        }

        // 5. SM-2 算法实现
        function calculateSM2(card, quality) {
            // quality: 0=Again, 3=Hard, 4=Good, 5=Easy (简化映射: Again->0, Hard->3, Good->4, Easy->5)
            // 实际按钮映射: Again(重来), Hard(困难), Good(一般), Easy(简单)

            let valQuality;
            if (quality === 'again') valQuality = 0;
            else if (quality === 'hard') valQuality = 3;
            else if (quality === 'good') valQuality = 4;
            else if (quality === 'easy') valQuality = 5;

            // 更新 ease
            let newEase = card.ease + (0.1 - (5 - valQuality) * (0.08 + (5 - valQuality) * 0.02));
            if (newEase < 1.3) newEase = 1.3;

            let newInterval;
            let newReps = card.reps;

            if (valQuality < 3) {
                newReps = 0;
                newInterval = 0; // 重置为今天 (0天后)
            } else {
                newReps += 1;
                if (newReps === 1) newInterval = 1;
                else if (newReps === 2) newInterval = 6;
                else newInterval = Math.round(card.interval * newEase);
            }

            return {
                ...card,
                ease: newEase,
                reps: newReps,
                interval: newInterval,
                nextReview: Date.now() + (newInterval * 24 * 60 * 60 * 1000),
                history: [...(card.history || []), { date: Date.now(), quality: valQuality }]
            };
        }

        // 6. 复习流程控制
        async function startSession(mode) {
            isCramming = (mode === 'cram');
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                const allCards = request.result;
                if (isCramming) {
                    // 随机乱序所有卡片
                    currentSession = allCards.sort(() => 0.5 - Math.random());
                } else {
                    // 筛选到期卡片
                    const now = Date.now();
                    currentSession = allCards.filter(c => c.nextReview <= now);
                }

                if (currentSession.length === 0) {
                    alert(isCramming ? "没有卡片可以背诵，请先添加。" : "恭喜！今日复习已完成。");
                    return;
                }

                currentCardIndex = 0;
                switchView('review');
                showCard();
            };
        }

        function showCard() {
            if (currentCardIndex >= currentSession.length) {
                alert('本轮复习结束！');
                switchView('home');
                updateHomeStats();
                return;
            }

            const card = currentSession[currentCardIndex];
            const container = document.getElementById('flashcard');

            // 渲染正面
            let html = `
            ${isCramming ? '<div class="cram-mode-badge">突击模式</div>' : ''}
            <div class="flashcard-content">
                ${card.image ? `<img src="${card.image}" />` : ''}
                <div style="font-size:1.2rem; font-weight:bold; white-space: pre-wrap;">${card.question || '(图片题)'}</div>
            </div>
            <div id="btn-show-answer" style="margin-top:2rem; width:100%">
                <button class="btn btn-primary" onclick="flipCard()">显示答案</button>
            </div>
            <div id="answer-area" class="answer-section hidden">
                <div style="white-space: pre-wrap; color: var(--primary); margin-bottom:1rem;">${card.answer}</div>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="rateCard('again')">重来<br><span style="font-size:0.7rem">1min</span></button>
                    <button class="btn btn-warning" onclick="rateCard('hard')">困难<br><span style="font-size:0.7rem">2d</span></button>
                    <button class="btn btn-success" onclick="rateCard('good')">一般<br><span style="font-size:0.7rem">4d</span></button>
                    <button class="btn btn-primary" onclick="rateCard('easy')">简单<br><span style="font-size:0.7rem">7d</span></button>
                </div>
            </div>
        `;
            container.innerHTML = html;
        }

        function flipCard() {
            document.getElementById('btn-show-answer').classList.add('hidden');
            document.getElementById('answer-area').classList.remove('hidden');
        }

        function rateCard(quality) {
            if (!isCramming) {
                const card = currentSession[currentCardIndex];
                const updatedCard = calculateSM2(card, quality);

                // 更新数据库
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.put(updatedCard);
            }

            currentCardIndex++;
            showCard();
        }

        // 7. 统计与视图逻辑
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewName).classList.remove('hidden');

            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            if (document.getElementById('nav-' + viewName)) {
                document.getElementById('nav-' + viewName).classList.add('active');
            }

            if (viewName === 'stats') renderStats();
            if (viewName === 'settings') updateSettingsInfo();

            // 标题更新
            const titles = { 'home': '仪表盘', 'add': '添加卡片', 'stats': '记忆统计', 'settings': '数据管理', 'review': '正在记忆...' };
            document.getElementById('page-title').innerText = titles[viewName] || 'Anki';
        }

        async function updateHomeStats() {
            if (!db) return;
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                const cards = request.result;
                const now = Date.now();
                const due = cards.filter(c => c.nextReview <= now).length;
                document.getElementById('due-count').innerText = due;
                document.getElementById('total-cards-num').innerText = cards.length;
            };
        }

        function updateSettingsInfo() {
            updateHomeStats();
        }

        // 8. 图表渲染 (晚上8点半逻辑主要体现在这里)
        function renderStats() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                const cards = request.result;
                renderForecastChart(cards);
                renderRetentionChart(cards);
            };
        }

        // 预测未来复习压力
        let chartInstanceForecast = null;
        function renderForecastChart(cards) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            const days = 7;
            const data = new Array(days).fill(0);
            const labels = [];
            const now = new Date();

            for (let i = 0; i < days; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + i);
                labels.push(`${date.getMonth() + 1}/${date.getDate()}`);

                const startOfDay = new Date(date.setHours(0, 0, 0, 0)).getTime();
                const endOfDay = new Date(date.setHours(23, 59, 59, 999)).getTime();

                data[i] = cards.filter(c => c.nextReview >= startOfDay && c.nextReview <= endOfDay).length;

                // 把已经过期的加到第一天（今天）
                if (i === 0) {
                    data[i] += cards.filter(c => c.nextReview < startOfDay).length;
                }
            }

            if (chartInstanceForecast) chartInstanceForecast.destroy();
            chartInstanceForecast = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '待复习卡片数',
                        data: data,
                        backgroundColor: 'rgba(37, 99, 235, 0.5)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 记忆保留率对比 (可视化当前记忆 vs 艾宾浩斯)
        let chartInstanceRetention = null;
        function renderRetentionChart(cards) {
            const ctx = document.getElementById('retentionChart').getContext('2d');

            // 简单的分类：
            // 新卡片 (Reps=0)
            // 遗忘危险区 (Interval <= 2天)
            // 稳固期 (Interval > 2 且 <= 14)
            // 永久记忆 (Interval > 14)

            let stats = [0, 0, 0, 0];
            cards.forEach(c => {
                if (c.reps === 0) stats[0]++;
                else if (c.interval <= 2) stats[1]++;
                else if (c.interval <= 14) stats[2]++;
                else stats[3]++;
            });

            if (chartInstanceRetention) chartInstanceRetention.destroy();
            chartInstanceRetention = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['新卡片', '短期(易忘)', '中期(稳固)', '长期(永久)'],
                    datasets: [{
                        data: stats,
                        backgroundColor: ['#9ca3af', '#dc2626', '#f59e0b', '#16a34a']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '当前记忆分布情况'
                        }
                    }
                }
            });
        }

        // 9. 导入导出功能
        function exportData() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const data = JSON.stringify(request.result);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `anki_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            };
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error('格式错误');

                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);

                    let count = 0;
                    data.forEach(item => {
                        // 删除旧id防止冲突，或者保留覆盖
                        delete item.id;
                        store.add(item);
                        count++;
                    });

                    transaction.oncomplete = () => {
                        alert(`成功导入 ${count} 条数据！`);
                        updateHomeStats();
                        input.value = ''; // reset
                    };
                } catch (err) {
                    alert('导入失败：文件格式不正确');
                }
            };
            reader.readAsText(file);
        }

        function clearDb() {
            if (confirm("确定清空所有数据吗？此操作不可恢复！")) {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.clear();
                transaction.oncomplete = () => {
                    alert("数据已清空");
                    updateHomeStats();
                }
            }
        }

        // 启动
        window.onload = initDB;

    </script>
</body>

</html>