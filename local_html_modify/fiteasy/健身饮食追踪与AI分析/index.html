<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>FitBreezy - å¥èº«é¥®é£Ÿè®°å½•</title>
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #6366f1;
      --secondary: #ec4899;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px)
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent
    }

    body {
      font-family: 'Inter', 'Noto Sans SC', -apple-system, sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
      padding-top: var(--safe-top);
      padding-bottom: calc(80px + var(--safe-bottom))
    }

    .skeleton {
      background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
      background-size: 200% 100%;
      animation: skeleton 1.5s infinite
    }

    @keyframes skeleton {
      0% {
        background-position: 200% 0
      }

      100% {
        background-position: -200% 0
      }
    }

    .page {
      display: none;
      opacity: 0;
      transition: opacity .3s
    }

    .page.active {
      display: block;
      opacity: 1
    }

    ::-webkit-scrollbar {
      width: 4px;
      height: 4px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    ::-webkit-scrollbar-thumb {
      background: #c7d2fe;
      border-radius: 2px
    }

    .glass {
      background: rgba(255, 255, 255, .85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px)
    }

    .gradient-text {
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(1);
        opacity: 1
      }

      100% {
        transform: scale(1.5);
        opacity: 0
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    .slide-up {
      animation: slideUp .3s ease-out
    }

    .food-slider {
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, #6366f1 0%, #6366f1 var(--progress), #e2e8f0 var(--progress))
    }

    .food-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 2px 8px rgba(99, 102, 241, .4);
      cursor: pointer
    }

    .chat-bubble {
      position: relative;
      max-width: 85%
    }

    .chat-bubble.user {
      background: var(--bg-gradient);
      color: white;
      margin-left: auto;
      border-radius: 20px 20px 4px 20px
    }

    .chat-bubble.ai {
      background: white;
      border-radius: 20px 20px 20px 4px;
      box-shadow: 0 4px 20px rgba(99, 102, 241, .15)
    }

    /* Multi-step ReAct container */
    .step-container {
      position: relative;
      padding-left: 20px;
    }

    .step-container::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 0;
      bottom: 0;
      width: 2px;
      border-left: 2px dashed #c7d2fe;
    }

    .step-bubble {
      position: relative;
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(99, 102, 241, .1);
      transition: all 0.3s ease;
    }

    .step-bubble::before {
      content: '';
      position: absolute;
      left: -16px;
      top: 16px;
      width: 8px;
      height: 8px;
      background: #c7d2fe;
      border-radius: 50%;
    }

    .step-bubble.collapsed {
      padding: 8px 12px;
      cursor: pointer;
      opacity: 0.8;
    }

    .step-bubble.collapsed:hover {
      opacity: 1;
      background: #f8fafc;
    }

    .step-bubble.current {
      border-left: 3px solid var(--primary);
    }

    .step-bubble.current::before {
      background: var(--primary);
    }

    .step-summary {
      font-size: 12px;
      color: #64748b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-icon {
      font-size: 16px;
      min-width: 20px;
      text-align: center;
    }

    .timeline-line {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, #c7d2fe 0%, #ddd6fe 100%);
      transform: translateX(-50%)
    }

    .loader {
      width: 24px;
      height: 24px;
      border: 3px solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .toast {
      position: fixed;
      top: calc(20px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 500;
      z-index: 9999;
      transition: transform .3s
    }

    .toast.show {
      transform: translateX(-50%) translateY(0)
    }

    .toast.success {
      background: #10b981;
      color: white
    }

    .toast.error {
      background: #ef4444;
      color: white
    }

    .toast.info {
      background: #6366f1;
      color: white
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 1000;
      display: none;
      align-items: flex-end;
      justify-content: center
    }

    .modal-overlay.show {
      display: flex
    }

    .modal-content {
      background: white;
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding-bottom: var(--safe-bottom)
    }

    .img-preview {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 16px
    }

    .nutrition-bar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: #e2e8f0
    }

    .nutrition-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width .5s
    }

    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none
    }

    .nav-item.active {
      color: #6366f1
    }

    .nav-item {
      color: #9ca3af;
      transition: color .2s
    }

    /* Compact input style */
    .compact-input {
      padding: 6px 10px;
      font-size: 13px;
    }

    /* Dual-handle macro slider */
    .macro-slider-container {
      position: relative;
      height: 28px;
      margin: 8px 0;
    }

    .macro-slider-track {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 12px;
      transform: translateY(-50%);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
    }

    .macro-segment {
      height: 100%;
      transition: width 0.15s;
    }

    .macro-segment.protein {
      background: #10b981;
    }

    .macro-segment.carbs {
      background: #f59e0b;
    }

    .macro-segment.fat {
      background: #3b82f6;
    }

    .macro-slider-handle {
      position: absolute;
      top: 50%;
      width: 18px;
      height: 18px;
      background: white;
      border: 2px solid #6366f1;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: ew-resize;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: transform 0.1s;
    }

    .macro-slider-handle:hover {
      transform: translate(-50%, -50%) scale(1.15);
    }

    .macro-slider-handle:active {
      transform: translate(-50%, -50%) scale(1.2);
    }

    /* Quick Edit Agent styles */
    .item-selectable {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .item-selectable:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }

    .item-selected {
      border: 2px solid #6366f1 !important;
      background-color: #eef2ff !important;
      position: relative;
    }

    .item-selected::after {
      content: 'âœ“';
      position: absolute;
      top: -8px;
      right: -8px;
      background: #6366f1;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .diff-old {
      opacity: 0.6;
      border: 2px dashed #9ca3af !important;
      background: #f3f4f6 !important;
      filter: grayscale(0.5);
    }

    .diff-new {
      border: 2px solid #10b981 !important;
      background: #ecfdf5 !important;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }

    .quick-edit-panel {
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
    }

    .quick-edit-panel.show {
      transform: translateY(0);
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0);
        opacity: 0;
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .animate-bounce-in {
      animation: bounceIn 0.3s ease-out;
    }
  </style>
</head>

<body class="text-gray-800">
  <div id="app" class="relative">
    <header class="sticky top-0 z-50 glass border-b border-white/20" style="padding-top:var(--safe-top)">
      <div class="flex items-center justify-between px-4 py-3">
        <div>
          <h1 class="text-xl font-bold gradient-text">FitBreezy</h1>
          <p id="currentDate" class="text-xs text-gray-500"></p>
        </div>
        <button id="goalToggle"
          class="px-3 py-1.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-600 transition-all">å¢è‚Œæ¨¡å¼</button>
      </div>
    </header>
    <main class="pb-24">
      <section id="page-home" class="page active p-4">
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">æˆ‘çš„è®°å½•</h2>
            <div class="flex items-center gap-2 text-sm text-gray-500">
              <button id="prevMonth" class="p-1 hover:bg-gray-100 rounded"><svg class="w-5 h-5" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg></button>
              <span id="monthDisplay">12æœˆ 2024</span>
              <button id="nextMonth" class="p-1 hover:bg-gray-100 rounded"><svg class="w-5 h-5" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg></button>
            </div>
          </div>
          <div id="timeline" class="relative">
            <div class="timeline-line"></div>
            <div id="timelineContent" class="space-y-4">
              <div class="skeleton-timeline">
                <div class="grid grid-cols-2 gap-4 relative z-10">
                  <div class="skeleton h-40 rounded-2xl"></div>
                  <div class="skeleton h-40 rounded-2xl"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-6">
          <div class="bg-white rounded-2xl p-4 shadow-sm">
            <div class="text-2xl mb-1">ğŸ‹ï¸</div>
            <div id="statTrainings" class="text-xl font-bold text-indigo-600">-</div>
            <div class="text-xs text-gray-500">æœ¬å‘¨è®­ç»ƒ</div>
          </div>
          <div class="bg-white rounded-2xl p-4 shadow-sm">
            <div class="text-2xl mb-1">ğŸ”¥</div>
            <div id="statCalories" class="text-xl font-bold text-pink-500">-</div>
            <div class="text-xs text-gray-500">ä»Šæ—¥çƒ­é‡</div>
          </div>
          <div class="bg-white rounded-2xl p-4 shadow-sm">
            <div class="text-2xl mb-1">ğŸ’ª</div>
            <div id="statProtein" class="text-xl font-bold text-emerald-500">-</div>
            <div class="text-xs text-gray-500">ä»Šæ—¥è›‹ç™½</div>
          </div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm">
          <h3 class="font-semibold mb-3">æœ¬å‘¨æ¦‚è§ˆ</h3>
          <div class="flex items-center gap-4 mb-2 text-xs"><span class="flex items-center gap-1"><span
                class="w-3 h-3 rounded bg-indigo-500"></span>è®­ç»ƒ</span><span class="flex items-center gap-1"><span
                class="w-3 h-3 rounded bg-pink-500"></span>çƒ­é‡</span></div>
          <div id="weeklyChart" class="flex items-end justify-between h-32 gap-1"></div>
          <div class="flex justify-between mt-2 text-xs text-gray-400">
            <span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span><span>æ—¥</span>
          </div>
        </div>
      </section>
      <section id="page-training" class="page p-4">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold">è®­ç»ƒè®°å½•</h2>
          <button id="addTraining"
            class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl text-sm font-medium shadow-lg shadow-indigo-200"><svg
              class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>æ·»åŠ è®°å½•</button>
        </div>
        <div id="trainingList" class="space-y-4"></div>
      </section>
      <section id="page-nutrition" class="page p-4">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold">é¥®é£Ÿè®°å½•</h2>
          <button id="addMeal"
            class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl text-sm font-medium shadow-lg shadow-pink-200"><svg
              class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>è®°å½•é¥®é£Ÿ</button>
        </div>
        <div class="bg-gradient-to-br from-pink-50 to-rose-50 rounded-2xl p-4 mb-6">
          <div class="flex items-center justify-between mb-3"><span class="font-medium">ä»Šæ—¥è¥å…»æ‘„å…¥</span><span
              id="todayDate" class="text-sm text-gray-500"></span></div>
          <div class="grid grid-cols-4 gap-3 text-center">
            <div>
              <div id="todayCalories" class="text-xl font-bold text-gray-800">0</div>
              <div class="text-xs text-gray-500">åƒå¡</div>
              <div class="nutrition-bar mt-1">
                <div id="calBar" class="nutrition-bar-fill bg-pink-500" style="width:0%"></div>
              </div>
            </div>
            <div>
              <div id="todayProtein" class="text-xl font-bold text-emerald-600">0g</div>
              <div class="text-xs text-gray-500">è›‹ç™½è´¨</div>
              <div class="nutrition-bar mt-1">
                <div id="protBar" class="nutrition-bar-fill bg-emerald-500" style="width:0%"></div>
              </div>
            </div>
            <div>
              <div id="todayCarbs" class="text-xl font-bold text-amber-600">0g</div>
              <div class="text-xs text-gray-500">ç¢³æ°´</div>
              <div class="nutrition-bar mt-1">
                <div id="carbBar" class="nutrition-bar-fill bg-amber-500" style="width:0%"></div>
              </div>
            </div>
            <div>
              <div id="todayFat" class="text-xl font-bold text-blue-600">0g</div>
              <div class="text-xs text-gray-500">è„‚è‚ª</div>
              <div class="nutrition-bar mt-1">
                <div id="fatBar" class="nutrition-bar-fill bg-blue-500" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>
        <div id="mealList" class="space-y-4"></div>
      </section>
      <section id="page-stats" class="page p-4">
        <h2 class="text-lg font-semibold mb-6">æ•°æ®ç»Ÿè®¡</h2>
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-medium">èº«ä½“å˜åŒ–</h3><button id="addBodyPhoto" class="text-sm text-indigo-600 font-medium">+
              æ·»åŠ ç…§ç‰‡</button>
          </div>
          <div id="bodyProgressGallery" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2"></div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
          <h3 class="font-medium mb-4">è®­ç»ƒå®¹é‡è¶‹åŠ¿</h3>
          <div id="volumeChart" class="h-40 flex items-end justify-between gap-2"></div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm">
          <h3 class="font-medium mb-4">ä½“é‡è¶‹åŠ¿</h3>
          <div id="weightChart" class="h-40 flex items-end justify-between gap-2"></div>
        </div>
      </section>
      <section id="page-settings" class="page p-4">
        <h2 class="text-lg font-semibold mb-6">è®¾ç½®</h2>
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
          <h3 class="font-medium mb-4 flex items-center gap-2"><svg class="w-5 h-5 text-indigo-500" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>AI é…ç½®</h3>
          <div class="space-y-4">
            <div><label class="block text-sm text-gray-600 mb-1">ä¸»è¦ API</label><input type="text" id="apiUrl1"
                placeholder="API Base URL"
                class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm"><input
                type="password" id="apiKey1" placeholder="API Key"
                class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm mt-2"><input
                type="text" id="apiModel1" placeholder="Model Name"
                class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm mt-2">
            </div>
            <div><label class="block text-sm text-gray-600 mb-1">å¤‡ç”¨ API</label><input type="text" id="apiUrl2"
                placeholder="API Base URL (å¤‡ç”¨)"
                class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm"><input
                type="password" id="apiKey2" placeholder="API Key (å¤‡ç”¨)"
                class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm mt-2"><input
                type="text" id="apiModel2" placeholder="Model Name (å¤‡ç”¨)"
                class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm mt-2">
            </div>
            <button id="saveApiConfig"
              class="w-full py-2.5 bg-indigo-500 text-white rounded-xl font-medium">ä¿å­˜é…ç½®</button>
          </div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
          <h3 class="font-medium mb-4 flex items-center gap-2"><svg class="w-5 h-5 text-emerald-500" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>å…³æ³¨çš„è¥å…»ç´ </h3>
          <div id="nutrientTags" class="flex flex-wrap gap-2 mb-3"></div>
          <div class="flex gap-2"><input type="text" id="newNutrient" placeholder="æ·»åŠ è¥å…»ç´ "
              class="flex-1 px-4 py-2 rounded-xl border border-gray-200 outline-none text-sm"><button id="addNutrient"
              class="px-4 py-2 bg-emerald-500 text-white rounded-xl text-sm font-medium">æ·»åŠ </button></div>
        </div>
        <div class="bg-white rounded-2xl p-3 shadow-sm mb-4">
          <h3 class="font-medium mb-2 flex items-center gap-2 text-sm"><svg class="w-4 h-4 text-pink-500" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>æ¯æ—¥ç›®æ ‡</h3>
          <!-- ä¸ªäººä¿¡æ¯è¾“å…¥ - æ›´ç´§å‡‘ -->
          <div class="grid grid-cols-5 gap-1.5 mb-2">
            <div><label class="text-[10px] text-gray-400">èº«é«˜cm</label><input type="number" id="userHeight"
                class="w-full compact-input rounded border text-center" placeholder="170"></div>
            <div><label class="text-[10px] text-gray-400">ä½“é‡kg</label><input type="number" id="userWeight"
                class="w-full compact-input rounded border text-center" placeholder="65"></div>
            <div><label class="text-[10px] text-gray-400">å¹´é¾„</label><input type="number" id="userAge"
                class="w-full compact-input rounded border text-center" placeholder="25"></div>
            <div><label class="text-[10px] text-gray-400">æ€§åˆ«</label><select id="userGender"
                class="w-full compact-input rounded border">
                <option value="male">ç”·</option>
                <option value="female">å¥³</option>
              </select></div>
            <div><label class="text-[10px] text-gray-400">æ´»åŠ¨é‡</label><select id="activityLevel"
                class="w-full compact-input rounded border text-xs">
                <option value="1.2">ä¹…å</option>
                <option value="1.375">è½»åº¦</option>
                <option value="1.55" selected>ä¸­åº¦</option>
                <option value="1.725">é‡åº¦</option>
              </select></div>
          </div>
          <button id="calculateTargetsBtn"
            class="w-full py-1.5 mb-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg text-xs font-medium">âš¡ï¸
            æ™ºèƒ½è®¡ç®—</button>
          <!-- çƒ­é‡è¾“å…¥ -->
          <div class="flex items-center gap-2 mb-2 bg-gray-50 rounded-lg p-2">
            <span class="text-xs text-gray-500 whitespace-nowrap">çƒ­é‡</span>
            <input type="number" id="targetCalories"
              class="flex-1 px-2 py-1 rounded border text-sm font-medium text-center" placeholder="2200">
            <span class="text-xs text-gray-400">kcal</span>
          </div>
          <!-- å®é‡æ»‘æ† -->
          <div class="mb-2">
            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-emerald-500"></span>è›‹ç™½ <span
                  id="proteinPercent" class="font-medium text-emerald-600">27%</span></span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-amber-500"></span>ç¢³æ°´ <span
                  id="carbsPercent" class="font-medium text-amber-600">45%</span></span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-blue-500"></span>è„‚è‚ª <span
                  id="fatPercent" class="font-medium text-blue-600">28%</span></span>
            </div>
            <div id="macroSlider" class="macro-slider-container">
              <div class="macro-slider-track">
                <div id="segmentProtein" class="macro-segment protein" style="width:27%"></div>
                <div id="segmentCarbs" class="macro-segment carbs" style="width:45%"></div>
                <div id="segmentFat" class="macro-segment fat" style="width:28%"></div>
              </div>
              <div id="handleProtein" class="macro-slider-handle" style="left:27%"></div>
              <div id="handleCarbs" class="macro-slider-handle" style="left:72%"></div>
            </div>
          </div>
          <!-- å®é‡æ•°å€¼ - 4åˆ—ç´§å‡‘ -->
          <div class="grid grid-cols-4 gap-1.5 text-center mb-2">
            <div class="bg-emerald-50 rounded-lg py-1.5">
              <input type="number" id="targetProtein"
                class="w-full bg-transparent text-sm font-bold text-emerald-600 text-center outline-none"
                placeholder="150">
              <div class="text-[10px] text-gray-400">è›‹ç™½g</div>
            </div>
            <div class="bg-amber-50 rounded-lg py-1.5">
              <input type="number" id="targetCarbs"
                class="w-full bg-transparent text-sm font-bold text-amber-600 text-center outline-none"
                placeholder="250">
              <div class="text-[10px] text-gray-400">ç¢³æ°´g</div>
            </div>
            <div class="bg-blue-50 rounded-lg py-1.5">
              <input type="number" id="targetFat"
                class="w-full bg-transparent text-sm font-bold text-blue-600 text-center outline-none" placeholder="70">
              <div class="text-[10px] text-gray-400">è„‚è‚ªg</div>
            </div>
            <button id="saveTargets" class="bg-pink-500 text-white rounded-lg text-xs font-medium">ä¿å­˜</button>
          </div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
          <h3 class="font-medium mb-4 flex items-center gap-2"><svg class="w-5 h-5 text-amber-500" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
            </svg>æ•°æ®ç®¡ç†</h3>
          <div class="space-y-3">
            <button id="exportData"
              class="w-full py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-medium flex items-center justify-center gap-2"><svg
                class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>å¯¼å‡ºæ•°æ® (ZIP)</button>
            <div class="grid grid-cols-2 gap-3"><button id="importFull"
                class="py-2.5 bg-blue-500 text-white rounded-xl font-medium text-sm">å…¨é‡å¯¼å…¥</button><button
                id="importIncr" class="py-2.5 bg-teal-500 text-white rounded-xl font-medium text-sm">å¢é‡å¯¼å…¥</button></div>
            <input type="file" id="importFile" accept=".zip" class="hidden">
            <button id="clearData"
              class="w-full py-2.5 bg-red-50 text-red-500 rounded-xl font-medium border border-red-200">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
          </div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm">
          <h3 class="font-medium mb-2">å…³äº</h3>
          <p class="text-sm text-gray-500">FitBreezy v1.0.0</p>
          <p class="text-xs text-gray-400 mt-1">AIé©±åŠ¨çš„å¥èº«é¥®é£Ÿè®°å½•åŠ©æ‰‹</p>
        </div>
      </section>
    </main>
    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/20 z-50"
      style="padding-bottom:var(--safe-bottom)">
      <div class="flex justify-around py-2">
        <button class="nav-item active flex flex-col items-center py-2 px-4" data-page="home"><svg class="w-6 h-6"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg><span class="text-xs mt-1">é¦–é¡µ</span></button>
        <button class="nav-item flex flex-col items-center py-2 px-4" data-page="training"><svg class="w-6 h-6"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg><span class="text-xs mt-1">è®­ç»ƒ</span></button>
        <button class="nav-item flex flex-col items-center py-2 px-4" data-page="nutrition"><svg class="w-6 h-6"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg><span class="text-xs mt-1">é¥®é£Ÿ</span></button>
        <button class="nav-item flex flex-col items-center py-2 px-4" data-page="stats"><svg class="w-6 h-6" fill="none"
            stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg><span class="text-xs mt-1">ç»Ÿè®¡</span></button>
        <button class="nav-item flex flex-col items-center py-2 px-4" data-page="settings"><svg class="w-6 h-6"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg><span class="text-xs mt-1">è®¾ç½®</span></button>
      </div>
    </nav>
    <button id="aiAssistantBtn"
      class="fixed z-50 w-14 h-14 rounded-full shadow-lg shadow-indigo-300 flex items-center justify-center transition-transform hover:scale-110 active:scale-95"
      style="right:20px;bottom:calc(100px + var(--safe-bottom));background:var(--bg-gradient);">
      <svg viewBox="0 0 40 40" class="w-8 h-8">
        <circle cx="20" cy="20" r="16" fill="white" opacity="0.9" />
        <circle cx="14" cy="17" r="3" fill="#6366f1" />
        <circle cx="26" cy="17" r="3" fill="#6366f1" />
        <circle cx="15" cy="16" r="1" fill="white" />
        <circle cx="27" cy="16" r="1" fill="white" />
        <path d="M14 26 Q20 30 26 26" stroke="#6366f1" stroke-width="2" fill="none" stroke-linecap="round" />
        <ellipse cx="20" cy="6" rx="4" ry="2" fill="#a78bfa" />
        <circle cx="20" cy="4" r="2" fill="#c4b5fd" />
      </svg>
      <span class="absolute inset-0 rounded-full bg-indigo-400 opacity-30"
        style="animation:pulse-ring 2s ease-out infinite;"></span>
    </button>
    <div id="chatModal" class="modal-overlay">
      <div class="modal-content slide-up">
        <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between z-10">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background:var(--bg-gradient);">
              <svg viewBox="0 0 40 40" class="w-6 h-6">
                <circle cx="20" cy="20" r="16" fill="white" opacity="0.9" />
                <circle cx="14" cy="17" r="3" fill="#6366f1" />
                <circle cx="26" cy="17" r="3" fill="#6366f1" />
                <path d="M14 26 Q20 30 26 26" stroke="#6366f1" stroke-width="2" fill="none" stroke-linecap="round" />
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">FitBreezy AI</h3>
              <p class="text-xs text-gray-500">ä½ çš„æ™ºèƒ½å¥èº«åŠ©æ‰‹</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="flex items-center bg-gray-100 rounded-2xl p-1">
              <button id="modeFast"
                class="px-2 py-1 rounded-xl text-xs font-medium transition-all bg-white shadow text-indigo-600">
                âš¡å¿«é€Ÿ
              </button>
              <button id="modeDeep"
                class="px-2 py-1 rounded-xl text-xs font-medium text-gray-500 transition-all hover:text-indigo-600">
                ğŸ§ æ·±åº¦
              </button>
            </div>
            <button id="closeChatModal" class="p-2 hover:bg-gray-100 rounded-full"><svg class="w-6 h-6" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg></button>
          </div>
        </div>
        <div id="chatMessages" class="p-4 space-y-4 min-h-[300px] max-h-[60vh] overflow-y-auto">
          <div class="chat-bubble ai p-4">
            <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½å¥èº«åŠ©æ‰‹ã€‚</p>
            <p class="mt-2 text-sm text-gray-600">ä½ å¯ä»¥é—®æˆ‘ï¼š</p>
            <ul class="mt-1 text-sm text-gray-600 space-y-1">
              <li>â€¢ æœ€è¿‘çš„é¥®é£ŸçŠ¶æ€å¦‚ä½•ï¼Ÿ</li>
              <li>â€¢ æœ€è¿‘4æ¬¡è®­ç»ƒå®¹é‡åˆ†æ</li>
              <li>â€¢ æ€æ ·æ‰èƒ½ç˜¦åˆ°60kgï¼Ÿ</li>
            </ul>
          </div>
        </div>
        <div class="sticky bottom-0 bg-white border-t p-4" style="padding-bottom:calc(16px + var(--safe-bottom));">
          <div class="flex gap-2 items-center">
            <button id="resetChat"
              class="p-3 rounded-2xl text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors" title="é‡ç½®å¯¹è¯">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
            <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
              class="flex-1 px-4 py-3 rounded-2xl border border-gray-200 focus:border-indigo-500 outline-none">
            <button id="sendChat" class="px-4 py-3 rounded-2xl text-white font-medium"
              style="background:var(--bg-gradient);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="trainingModal" class="modal-overlay">
      <div class="modal-content slide-up">
        <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between z-10">
          <h3 class="font-semibold">æ·»åŠ è®­ç»ƒè®°å½•</h3><button class="close-modal p-2 hover:bg-gray-100 rounded-full"><svg
              class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg></button>
        </div>
        <div class="p-4">
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šä¼ "è®­è®°"æˆªå›¾</label>
            <div id="trainingDropzone"
              class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center cursor-pointer hover:border-indigo-500 transition">
              <input type="file" id="trainingImageInput" accept="image/*" class="hidden"><svg
                class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-gray-600">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æˆªå›¾</p>
            </div>
            <div id="trainingImagePreview" class="hidden mt-4"><img id="trainingPreviewImg" class="img-preview"></div>
          </div>
          <div id="trainingParseResult" class="hidden">
            <div class="bg-indigo-50 rounded-2xl p-4 mb-4">
              <div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸ‹ï¸</span><span id="parsedTrainingDate"
                  class="font-medium"></span><span id="parsedTrainingMuscle"
                  class="px-2 py-0.5 bg-indigo-200 text-indigo-700 rounded-full text-xs"></span></div>
              <div class="grid grid-cols-3 gap-2 text-center text-sm">
                <div class="bg-white rounded-xl p-2">
                  <div id="parsedDuration" class="font-bold text-indigo-600">-</div>
                  <div class="text-xs text-gray-500">æ—¶é•¿</div>
                </div>
                <div class="bg-white rounded-xl p-2">
                  <div id="parsedVolume" class="font-bold text-indigo-600">-</div>
                  <div class="text-xs text-gray-500">æ€»å®¹é‡</div>
                </div>
                <div class="bg-white rounded-xl p-2">
                  <div id="parsedCalories" class="font-bold text-indigo-600">-</div>
                  <div class="text-xs text-gray-500">æ¶ˆè€—</div>
                </div>
              </div>
            </div>
            <div id="exerciseList" class="space-y-2 mb-4 max-h-64 overflow-y-auto"></div>
            <!-- Training Quick Edit Mascot -->
            <button id="trainingModalAiBtn"
              class="hidden w-full py-2 mb-3 rounded-xl bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-600 text-sm font-medium flex items-center justify-center gap-2 transition-all hover:shadow-md animate-bounce-in">
              <span class="text-lg">âœ¨</span>AI å¿«é€Ÿå¾®è°ƒ
            </button>
          </div>
          <div id="trainingLoading" class="hidden text-center py-8">
            <div class="loader mx-auto mb-3"></div>
            <p class="text-gray-600">AI æ­£åœ¨è¯†åˆ«è®­ç»ƒæ•°æ®...</p>
          </div>
          <button id="saveTraining"
            class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-medium disabled:opacity-50"
            disabled>ä¿å­˜è®°å½•</button>
        </div>
      </div>
    </div>
    <div id="mealModal" class="modal-overlay">
      <div class="modal-content slide-up">
        <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between z-10">
          <h3 class="font-semibold">è®°å½•é¥®é£Ÿ</h3><button class="close-modal p-2 hover:bg-gray-100 rounded-full"><svg
              class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg></button>
        </div>
        <div class="p-4">
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">æ‹ç…§æˆ–ä¸Šä¼ é£Ÿç‰©ç…§ç‰‡</label>
            <div id="mealDropzone"
              class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center cursor-pointer hover:border-pink-500 transition">
              <input type="file" id="mealImageInput" accept="image/*" capture="environment" class="hidden"><svg
                class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <p class="text-gray-600">ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©ç…§ç‰‡</p>
            </div>
            <div id="mealImagePreview" class="hidden mt-4"><img id="mealPreviewImg" class="img-preview"></div>
          </div>
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">é¤æ¬¡</label>
            <div class="grid grid-cols-4 gap-2"><button
                class="meal-type-btn px-3 py-2 rounded-xl border-2 border-gray-200 text-sm" data-type="breakfast">â˜€ï¸
                æ—©é¤</button><button class="meal-type-btn px-3 py-2 rounded-xl border-2 border-gray-200 text-sm"
                data-type="lunch">ğŸŒ¤ï¸ åˆé¤</button><button
                class="meal-type-btn px-3 py-2 rounded-xl border-2 border-gray-200 text-sm" data-type="dinner">ğŸŒ™
                æ™šé¤</button><button class="meal-type-btn px-3 py-2 rounded-xl border-2 border-gray-200 text-sm"
                data-type="snack">ğŸª åŠ é¤</button></div>
          </div>
          <div id="mealParseResult" class="hidden">
            <div class="bg-pink-50 rounded-2xl p-4 mb-4">
              <div class="flex items-center justify-between mb-2"><span class="font-medium">è¥å…»æ‘˜è¦</span><span
                  id="mealTotalCalories" class="text-pink-600 font-bold">0 åƒå¡</span></div>
              <div class="grid grid-cols-3 gap-2 text-center text-sm">
                <div class="bg-white rounded-xl p-2">
                  <div id="mealTotalProtein" class="font-bold text-emerald-600">0g</div>
                  <div class="text-xs text-gray-500">è›‹ç™½è´¨</div>
                </div>
                <div class="bg-white rounded-xl p-2">
                  <div id="mealTotalCarbs" class="font-bold text-amber-600">0g</div>
                  <div class="text-xs text-gray-500">ç¢³æ°´</div>
                </div>
                <div class="bg-white rounded-xl p-2">
                  <div id="mealTotalFat" class="font-bold text-blue-600">0g</div>
                  <div class="text-xs text-gray-500">è„‚è‚ª</div>
                </div>
              </div>
            </div>
            <div id="foodList" class="space-y-3 mb-4 max-h-64 overflow-y-auto"></div>
            <!-- Meal Quick Edit Mascot -->
            <button id="mealModalAiBtn"
              class="hidden w-full py-2 mb-3 rounded-xl bg-gradient-to-r from-pink-100 to-rose-100 text-pink-600 text-sm font-medium flex items-center justify-center gap-2 transition-all hover:shadow-md animate-bounce-in">
              <span class="text-lg">âœ¨</span>AI å¿«é€Ÿå¾®è°ƒ
            </button>
          </div>
          <div id="mealLoading" class="hidden text-center py-8">
            <div class="loader mx-auto mb-3"></div>
            <p class="text-gray-600">AI æ­£åœ¨è¯†åˆ«é£Ÿç‰©...</p>
          </div>
          <button id="saveMeal"
            class="w-full py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl font-medium disabled:opacity-50"
            disabled>ä¿å­˜è®°å½•</button>
        </div>
      </div>
    </div>
    <div id="bodyPhotoModal" class="modal-overlay">
      <div class="modal-content slide-up">
        <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between z-10">
          <h3 class="font-semibold">æ·»åŠ èº«ä½“ç…§ç‰‡</h3><button class="close-modal p-2 hover:bg-gray-100 rounded-full"><svg
              class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg></button>
        </div>
        <div class="p-4">
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šä¼ ç…§ç‰‡</label>
            <div id="bodyDropzone"
              class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center cursor-pointer hover:border-emerald-500 transition">
              <input type="file" id="bodyImageInput" accept="image/*" class="hidden"><svg
                class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <p class="text-gray-600">ä¸Šä¼ èº«ä½“ç…§ç‰‡</p>
            </div>
            <div id="bodyImagePreview" class="hidden mt-4"><img id="bodyPreviewImg" class="img-preview"></div>
          </div>
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">å½“å‰ä½“é‡ (kg)</label><input
              type="number" id="bodyWeight" step="0.1" placeholder="ä¾‹å¦‚ï¼š65.5"
              class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 outline-none"></div>
          <button id="saveBodyPhoto"
            class="w-full py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-medium disabled:opacity-50"
            disabled>ä¿å­˜è®°å½•</button>
        </div>
      </div>
    </div>
    <!-- Quick Edit Panel (Shared) -->
    <div id="quickEditPanel"
      class="fixed inset-x-0 bottom-0 z-[1001] bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.15)] quick-edit-panel"
      style="padding-bottom:var(--safe-bottom);">
      <div class="p-4">
        <div class="flex justify-between items-center mb-3">
          <h4 class="font-semibold text-gray-700 text-sm flex items-center gap-2">
            <span class="text-lg">âœ¨</span>AI å¿«é€Ÿå¾®è°ƒ
          </h4>
          <button id="closeEditPanel" class="text-gray-400 p-1 hover:bg-gray-100 rounded-full">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Selection hint -->
        <div id="editSelectionHint" class="text-xs text-gray-500 mb-2 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>ç‚¹å‡»ä¸Šæ–¹é¡¹ç›®é€‰ä¸­ï¼ˆå¯å¤šé€‰ï¼‰ï¼Œç„¶åè¾“å…¥ä¿®æ”¹æŒ‡ä»¤</span>
        </div>

        <!-- Diff container -->
        <div id="editDiffContainer"
          class="hidden mb-3 max-h-48 overflow-y-auto bg-gray-50 rounded-xl p-3 text-xs space-y-2">
        </div>

        <!-- Input area -->
        <div class="flex gap-2 items-center">
          <input type="text" id="editInput" placeholder="ä¾‹: ç‰›è‚‰æ”¹æˆ200g / åˆ é™¤é¸¡è›‹ / æ‹†åˆ†æˆä¸¤ä»½"
            class="flex-1 bg-gray-100 border-0 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
          <button id="submitEdit"
            class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-3 rounded-xl shadow-md disabled:opacity-50 transition-transform hover:scale-105 active:scale-95">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </button>
        </div>

        <!-- Loading indicator -->
        <div id="editLoading" class="hidden flex items-center justify-center gap-2 py-2 mt-2">
          <div class="loader" style="width:16px;height:16px;border-width:2px;"></div>
          <span class="text-sm text-gray-500">AI æ­£åœ¨å¤„ç†...</span>
        </div>

        <!-- Confirm/Retry buttons -->
        <div id="editActions" class="hidden grid grid-cols-2 gap-3 mt-3">
          <button id="retryEdit"
            class="py-2.5 rounded-xl bg-gray-200 text-gray-600 text-sm font-medium flex items-center justify-center gap-1 transition-all hover:bg-gray-300">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            é‡è¯•
          </button>
          <button id="confirmEdit"
            class="py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-sm font-medium flex items-center justify-center gap-1 shadow-lg shadow-emerald-200 transition-all hover:shadow-xl">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            ç¡®è®¤æ›¿æ¢
          </button>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>

  </div>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"></script>
  <script>
    const db = new Dexie('FitBreezyDB');
    db.version(1).stores({ trainings: '++id,date,targetMuscle,totalVolume', meals: '++id,date,mealType,totalCalories', bodyProgress: '++id,date,weight', config: 'key' });

    const state = { currentPage: 'home', currentMonth: new Date(), goal: 'bulk', selectedMealType: null, parsedTraining: null, parsedMeal: null, currentTrainingImage: null, currentMealImage: null, currentBodyImage: null, chatHistory: [], aiMode: 'fast' };
    // Quick Edit Agent state
    const editState = { isActive: false, context: null, selectedIndices: [], tempResult: null, lastInstruction: '' };
    const defaultConfig = { api1: { url: 'https://b.apiyi.com/v1', key: '', model: 'gpt-4.1-mini' }, api2: { url: 'https://b.apiyi.com/v1', key: '', model: 'gpt-4.1-mini' }, trackedNutrients: ['è›‹ç™½è´¨', 'ç»´ç”Ÿç´ D', 'é±¼æ²¹Omega-3', 'è¾…é…¶Q10'], nutritionTargets: { calories: 2200, protein: 150, carbs: 250, fat: 70 }, userProfile: { height: null, weight: null, age: null, gender: 'male', activityLevel: 1.55 } };

    const formatDate = (date, fmt = 'YYYY-MM-DD') => { const d = new Date(date), y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0'); if (fmt === 'YYYY-MM-DD') return `${y}-${m}-${day}`; if (fmt === 'MM-DD') return `${m}-${day}`; if (fmt === 'display') return `${m}æœˆ${day}æ—¥`; if (fmt === 'month') return `${y}å¹´${m}æœˆ`; return `${y}-${m}-${day}`; };
    const getWeekDates = () => { const today = new Date(), dow = today.getDay() || 7, mon = new Date(today); mon.setDate(today.getDate() - dow + 1); return Array.from({ length: 7 }, (_, i) => { const d = new Date(mon); d.setDate(mon.getDate() + i); return formatDate(d); }); };
    const getMealTypeByTime = () => { const h = new Date().getHours(); if (h >= 5 && h < 10) return 'breakfast'; if (h >= 10 && h < 14) return 'lunch'; if (h >= 14 && h < 17) return 'snack'; if (h >= 17 && h < 21) return 'dinner'; return 'snack'; };
    const mealIcons = { breakfast: 'â˜€ï¸', lunch: 'ğŸŒ¤ï¸', dinner: 'ğŸŒ™', snack: 'ğŸª' };
    const mealNames = { breakfast: 'æ—©é¤', lunch: 'åˆé¤', dinner: 'æ™šé¤', snack: 'åŠ é¤' };
    const muscleIcons = { 'èƒŒ': 'ğŸ”™', 'èƒ¸': 'ğŸ’ª', 'è‚©': 'ğŸ‹ï¸', 'è…¿': 'ğŸ¦µ', 'æ‰‹è‡‚': 'ğŸ’ª', 'æ ¸å¿ƒ': 'ğŸ¯' };

    const showToast = (msg, type = 'info') => { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3000); };
    const compressImage = async (file, maxKB = 200) => { try { return await imageCompression(file, { maxSizeMB: maxKB / 1024, maxWidthOrHeight: 1920, useWebWorker: true }); } catch (e) { return file; } };
    const createThumbnail = (file, maxSize = 100) => new Promise(resolve => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d'); let w = img.width, h = img.height; if (w > h) { if (w > maxSize) { h = Math.round(h * maxSize / w); w = maxSize; } } else { if (h > maxSize) { w = Math.round(w * maxSize / h); h = maxSize; } } canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h); let q = 0.7, data = canvas.toDataURL('image/jpeg', q); while (data.length > 13333 && q > 0.1) { q -= 0.1; data = canvas.toDataURL('image/jpeg', q); } resolve(data); }; img.src = e.target.result; }; reader.readAsDataURL(file); });
    const imageToBase64 = file => new Promise(r => { const fr = new FileReader(); fr.onload = e => r(e.target.result); fr.readAsDataURL(file); });
    const getConfig = async () => (await db.config.get('settings'))?.value || defaultConfig;
    const saveConfig = async cfg => await db.config.put({ key: 'settings', value: cfg });

    const callAI = async (messages, retry = true) => {
      const cfg = await getConfig();
      const tryAPI = async api => {
        if (!api.key) throw new Error('API Key æœªé…ç½®');
        const r = await fetch(`${api.url}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${api.key}` }, body: JSON.stringify({ model: api.model, messages, max_tokens: 4096, stream: true }) });
        if (!r.ok) throw new Error(`API Error: ${r.status}`);
        return r;
      };
      try { return await tryAPI(cfg.api1); } catch (e) { console.warn('Primary API failed:', e); if (retry && cfg.api2.key) return await tryAPI(cfg.api2); throw e; }
    };

    const streamAI = async (response, onChunk) => {
      const reader = response.body.getReader(), decoder = new TextDecoder(); let buf = '', full = '';
      while (true) {
        const { done, value } = await reader.read(); if (done) break; buf += decoder.decode(value, { stream: true }); const lines = buf.split('\n'); buf = lines.pop();
        for (const line of lines) { if (line.startsWith('data: ') && line !== 'data: [DONE]') { try { const c = JSON.parse(line.slice(6)).choices?.[0]?.delta?.content || ''; if (c) { full += c; onChunk(c, full); } } catch { } } }
      }
      return full;
    };

    const parseTraining = async base64 => {
      const prompt = `è¯·è¯†åˆ«è¿™å¼ "è®­è®°"APPçš„è®­ç»ƒæˆªå›¾ã€‚é‡è¦ï¼šåªå…³æ³¨**åŠ ç²—é»‘è‰²æ–‡å­—**ï¼ˆå®é™…è®­ç»ƒæ•°æ®ï¼‰ï¼Œå¿½ç•¥æµ…è‰²ç°è‰²æ–‡å­—ï¼ˆæ¨¡æ¿ï¼‰ã€‚è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼ˆæ— å…¶ä»–æ–‡å­—ï¼‰ï¼š{"date":"YYYY-MM-DD","targetMuscle":"èƒŒ/èƒ¸/è‚©/è…¿","duration":"1h18m","caloriesBurned":278,"totalVolume":10490,"exercises":[{"name":"åŠ¨ä½œå","sets":[{"weight":100,"reps":12}]}]}`;
      const r = await callAI([{ role: 'user', content: [{ type: 'text', text: prompt }, { type: 'image_url', image_url: { url: base64 } }] }]);
      let result = ''; await streamAI(r, (_, f) => result = f); const m = result.match(/\{[\s\S]*\}/); if (m) return JSON.parse(m[0]); throw new Error('æ— æ³•è§£æè®­ç»ƒæ•°æ®');
    };

    const parseMeal = async (base64, nutrients) => {
      const prompt = `è¯·è¯†åˆ«è¿™å¼ é£Ÿç‰©ç…§ç‰‡ï¼Œåˆ†æé£Ÿç‰©å’Œè¥å…»ã€‚ä»¥JSONæ ¼å¼è¿”å›ï¼š{"foods":[{"name":"é£Ÿç‰©å","grams":100,"calories":150,"protein":10,"carbs":20,"fat":5,"customNutrients":{"ç»´ç”Ÿç´ D":"0.5Î¼g"}}],"summary":{"totalCalories":500,"totalProtein":30,"totalCarbs":60,"totalFat":15}}ã€‚ç”¨æˆ·å…³æ³¨è¥å…»ç´ ï¼š${nutrients.join('ã€')}`;
      const r = await callAI([{ role: 'user', content: [{ type: 'text', text: prompt }, { type: 'image_url', image_url: { url: base64 } }] }]);
      let result = ''; await streamAI(r, (_, f) => result = f); const m = result.match(/\{[\s\S]*\}/); if (m) return JSON.parse(m[0]); throw new Error('æ— æ³•è¯†åˆ«é£Ÿç‰©');
    };

    const agentTools = {
      getTrainingRecords: async p => { let q = db.trainings.orderBy('date').reverse(); if (p.dateRange) q = q.filter(t => t.date >= p.dateRange.start && t.date <= p.dateRange.end); if (p.muscle) q = q.filter(t => t.targetMuscle === p.muscle); return await q.limit(p.limit || 10).toArray(); },
      getMealRecords: async p => { let q = db.meals.orderBy('date').reverse(); if (p.dateRange) q = q.filter(m => m.date >= p.dateRange.start && m.date <= p.dateRange.end); return await q.limit(p.limit || 10).toArray(); },
      getBodyProgress: async p => { let q = db.bodyProgress.orderBy('date').reverse(); if (p.dateRange) q = q.filter(b => b.date >= p.dateRange.start && b.date <= p.dateRange.end); return await q.limit(p.limit || 10).toArray(); },
      calculateStats: async p => {
        const today = new Date(); let start = new Date(today); if (p.period === 'month') start.setMonth(today.getMonth() - 1); else start.setDate(today.getDate() - 7); const range = { start: formatDate(start), end: formatDate(today) };
        if (p.metric === 'avgCalories') { const meals = await db.meals.where('date').between(range.start, range.end).toArray(); const total = meals.reduce((s, m) => s + (m.totalCalories || 0), 0); const days = new Set(meals.map(m => m.date)).size || 1; return { avgCalories: Math.round(total / days), days }; }
        if (p.metric === 'avgProtein') { const meals = await db.meals.where('date').between(range.start, range.end).toArray(); const total = meals.reduce((s, m) => s + (m.totalProtein || 0), 0); const days = new Set(meals.map(m => m.date)).size || 1; return { avgProtein: Math.round(total / days), days }; }
        if (p.metric === 'totalVolume') { const tr = await db.trainings.where('date').between(range.start, range.end).toArray(); return { totalVolume: tr.reduce((s, t) => s + (t.totalVolume || 0), 0), sessions: tr.length }; }
        return {};
      },
      predictGoal: async p => { const recs = await db.bodyProgress.orderBy('date').reverse().limit(10).toArray(); if (recs.length < 2) return { prediction: 'æ•°æ®ä¸è¶³' }; const oldest = recs[recs.length - 1], newest = recs[0]; const days = (new Date(newest.date) - new Date(oldest.date)) / 86400000; const wDiff = newest.weight - oldest.weight; const weeklyChange = (wDiff / days) * 7; const current = p.currentWeight || newest.weight; const toGo = current - p.targetWeight; if (weeklyChange >= 0 && toGo > 0) return { prediction: 'å½“å‰è¶‹åŠ¿æ˜¯å¢é‡ï¼Œéœ€è°ƒæ•´è®¡åˆ’' }; const weeks = Math.abs(toGo / weeklyChange); const target = new Date(); target.setDate(target.getDate() + weeks * 7); return { currentWeight: current, targetWeight: p.targetWeight, weeklyChange: weeklyChange.toFixed(2), weeksNeeded: Math.round(weeks), predictedDate: formatDate(target, 'display') }; },
      getUserTargets: async () => { const cfg = await getConfig(); return { nutritionTargets: cfg.nutritionTargets, userProfile: cfg.userProfile || null, currentGoal: state.goal }; },
      getTrackedNutrients: async () => { const cfg = await getConfig(); return { trackedNutrients: cfg.trackedNutrients, description: 'ç”¨æˆ·ç‰¹åˆ«å…³æ³¨çš„å¾®é‡è¥å…»ç´ /è¡¥å‰‚' }; }
    };

    const runAgent = async question => {
      const isDeep = state.aiMode === 'deep';
      const maxTurns = isDeep ? 5 : 2;

      // Build system prompt based on mode
      let sysPrompt = `ä½ æ˜¯FitBreezy AIå¥èº«åŠ©æ‰‹ã€‚ä»Šå¤©æ˜¯${formatDate(new Date())}ã€‚`;

      if (isDeep) {
        sysPrompt += `
å½“å‰ä¸ºã€æ·±åº¦åˆ†ææ¨¡å¼ã€‘ã€‚ç”¨æˆ·è¯¢é—®å¥åº·/å¥èº«é—®é¢˜æ—¶ï¼Œä½ å¿…é¡»å…¨é¢åˆ†æã€‚

é‡è¦è§„åˆ™ï¼š
1. ä¸è¦é‡å¤è°ƒç”¨åŒä¸€ä¸ªå·¥å…·
2. æ¯æ¬¡æ”¶åˆ°å·¥å…·ç»“æœåï¼Œè®°ä½è¿™äº›æ•°æ®
3. æ”¶é›†å®Œå¿…è¦æ•°æ®åï¼ˆé€šå¸¸2-4ä¸ªå·¥å…·ï¼‰ï¼Œç«‹å³ç»™å‡ºç»¼åˆå»ºè®®
4. å³ä½¿æ•°æ®ä¸å®Œæ•´ï¼Œä¹Ÿè¦åŸºäºå·²æœ‰æ•°æ®ç»™å‡ºæœ‰ç”¨çš„å»ºè®®
5. æä¾›é¥®é£Ÿå»ºè®®å‰ï¼Œå¿…é¡»å…ˆè°ƒç”¨ getUserTargets è·å–ç”¨æˆ·ç›®æ ‡
6. å¦‚æ¶‰åŠè¡¥å‰‚/å¾®é‡è¥å…»ç´ å»ºè®®ï¼Œéœ€è°ƒç”¨ getTrackedNutrients æŸ¥çœ‹ç”¨æˆ·å…³æ³¨ç‚¹

å¯ç”¨å·¥å…·ï¼š
- getUserTargets(): è·å–ç”¨æˆ·è®¾ç½®çš„æ¯æ—¥çƒ­é‡/è›‹ç™½è´¨/ç¢³æ°´/è„‚è‚ªç›®æ ‡åŠèº«ä½“æ•°æ®
- getTrackedNutrients(): è·å–ç”¨æˆ·å…³æ³¨çš„å¾®é‡è¥å…»ç´ åˆ—è¡¨
- getBodyProgress(limit): æŸ¥ä½“é‡è®°å½•
- calculateStats(metric:'avgCalories'|'avgProtein'|'totalVolume', period:'week'): ç»Ÿè®¡
- getTrainingRecords(limit): æŸ¥è®­ç»ƒè®°å½•
- getMealRecords(limit): æŸ¥é¥®é£Ÿè¯¦æƒ…
- predictGoal(targetWeight, currentWeight): é¢„æµ‹

ReActæ ¼å¼(æ¯æ­¥å¿…é¡»åŒ…å«å›¾æ ‡):
å›¾æ ‡: [é€‰ä¸€ä¸ªè¡¨æƒ…: ä½“é‡ç”¨âš–ï¸ é¥®é£Ÿç”¨ğŸ½ï¸ è®­ç»ƒç”¨ğŸ’ª ç»Ÿè®¡ç”¨ğŸ“Š ç›®æ ‡ç”¨ğŸ¯ åˆ†æç”¨ğŸ” è¥å…»ç”¨ğŸ’Š]
æ€è€ƒ: [å½“å‰åˆ†æ]
å·¥å…·: [å·¥å…·å]
å‚æ•°: {å‚æ•°}
---
å›ç­”: [ç»¼åˆå»ºè®®]`;
      } else {
        sysPrompt += `
å½“å‰ä¸ºã€å¿«é€Ÿå›å¤æ¨¡å¼ã€‘ã€‚è¯·ç®€çŸ­ç›´æ¥åœ°å›ç­”ã€‚ä»…åœ¨å¿…è¦æ—¶è°ƒç”¨æœ€ç›¸å…³çš„1ä¸ªå·¥å…·ã€‚
å¯ç”¨å·¥å…·ï¼šgetUserTargets, getTrackedNutrients, getTrainingRecords, getMealRecords, getBodyProgress, calculateStats, predictGoal
æ ¼å¼ï¼šæ€è€ƒ:[åˆ†æ] å·¥å…·:[tool] å‚æ•°:{...} --- å›ç­”:[ç»“æœ]`;
      }

      // Initialize messages with chat history
      let messages = [
        { role: 'system', content: sysPrompt },
        ...state.chatHistory.map(m => ({ role: m.role, content: m.content })),
        { role: 'user', content: question }
      ];

      const fixJsonString = (str) => str.replace(/([{,]\s*)(\w+)\s*:/g, '$1"$2":').replace(/'/g, '"');

      const extractJson = (text, startIdx) => {
        const jsonStart = text.indexOf('{', startIdx);
        if (jsonStart === -1) return null;
        let braceCount = 0, jsonEnd = jsonStart;
        for (let i = jsonStart; i < text.length; i++) {
          if (text[i] === '{') braceCount++;
          else if (text[i] === '}') braceCount--;
          if (braceCount === 0) { jsonEnd = i + 1; break; }
        }
        return text.slice(jsonStart, jsonEnd);
      };

      return {
        stream: async function* () {
          const decoder = new TextDecoder();
          let turn = 0;

          while (turn < maxTurns) {
            turn++;
            console.log(`--- Turn ${turn}/${maxTurns} (${state.aiMode} mode) ---`);

            // Call LLM
            const response = await callAI(messages);
            const reader = response.body.getReader();
            let buf = '', fullContent = '';

            // Stream response
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              buf += decoder.decode(value, { stream: true });
              const lines = buf.split('\n');
              buf = lines.pop() || '';
              for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed === 'data: [DONE]') continue;
                if (trimmed.startsWith('data: ')) {
                  try {
                    const parsed = JSON.parse(trimmed.slice(6));
                    const c = parsed.choices?.[0]?.delta?.content || '';
                    if (c) {
                      fullContent += c;
                      yield { type: 'content', content: c, full: fullContent, turn };
                    }
                  } catch (e) { }
                }
              }
            }

            console.log('LLM Output (Turn ' + turn + '):', fullContent);

            // Check for tool call
            const toolMatch = fullContent.match(/å·¥å…·[:ï¼š]\s*(\w+)/);
            const paramIdx = fullContent.search(/å‚æ•°[:ï¼š]/);

            if (toolMatch && agentTools[toolMatch[1]] && paramIdx !== -1) {
              const toolName = toolMatch[1];
              const jsonStr = extractJson(fullContent, paramIdx);

              if (jsonStr) {
                let params = {};
                try {
                  params = JSON.parse(fixJsonString(jsonStr));
                } catch (e) {
                  console.error('JSON parse error:', e);
                }

                console.log(`>>> Tool call: ${toolName}`, params);
                yield { type: 'tool_call', tool: toolName, params, turn };

                // Execute tool
                let result;
                try {
                  result = await agentTools[toolName](params);
                } catch (e) {
                  result = { error: e.message };
                }

                console.log('>>> Tool result:', result);
                yield { type: 'tool_result', tool: toolName, result, turn };

                // Add to message history for next turn
                messages.push({ role: 'assistant', content: fullContent });
                const resultSummary = JSON.stringify(result, null, 2).slice(0, 2500);
                messages.push({
                  role: 'user',
                  content: `å·¥å…· ${toolName} è¿”å›:\n${resultSummary}\n\nè¯·è®°ä½è¿™ä¸ªç»“æœã€‚å¦‚æœå·²æœ‰è¶³å¤Ÿä¿¡æ¯å¯ä»¥å›ç­”ç”¨æˆ·ï¼Œç›´æ¥è¾“å‡º"å›ç­”:"ç»™å‡ºç»¼åˆå»ºè®®ï¼›å¦åˆ™ç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªä¸åŒçš„å·¥å…·ã€‚æ³¨æ„ï¼šä¸è¦é‡å¤è°ƒç”¨åŒä¸€å·¥å…·ã€‚`
                });

                // Continue loop for next tool call
                continue;
              }
            }

            // No tool call detected - this is the final answer
            // Check if we need to extract the "å›ç­”:" part
            const answerMatch = fullContent.match(/å›ç­”[:ï¼š]\s*([\s\S]*?)$/);
            const finalText = answerMatch ? answerMatch[1].trim() : fullContent;

            yield { type: 'done', full: finalText };
            return;
          }

          // Max turns reached
          yield { type: 'final_content', content: '\n(å·²è¾¾åˆ°æœ€å¤§åˆ†ææ­¥æ•°)', full: '' };
          yield { type: 'done', full: 'åˆ†æå·²å®Œæˆï¼Œä½†å¯èƒ½éœ€è¦æ›´å¤šä¿¡æ¯æ‰èƒ½ç»™å‡ºå®Œæ•´å»ºè®®ã€‚' };
        }
      };
    };

    const renderTimeline = async () => {
      const container = document.getElementById('timelineContent'); const start = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), 1); const end = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + 1, 0);
      const [trainings, meals] = await Promise.all([db.trainings.where('date').between(formatDate(start), formatDate(end)).toArray(), db.meals.where('date').between(formatDate(start), formatDate(end)).toArray()]);
      const dateMap = new Map(); trainings.forEach(t => { if (!dateMap.has(t.date)) dateMap.set(t.date, { trainings: [], meals: [] }); dateMap.get(t.date).trainings.push(t); }); meals.forEach(m => { if (!dateMap.has(m.date)) dateMap.set(m.date, { trainings: [], meals: [] }); dateMap.get(m.date).meals.push(m); });
      const dates = Array.from(dateMap.keys()).sort((a, b) => b.localeCompare(a));
      if (!dates.length) { container.innerHTML = `<div class="text-center py-12"><div class="text-6xl mb-4">ğŸ“</div><p class="text-gray-500">æœ¬æœˆè¿˜æ²¡æœ‰è®°å½•</p></div>`; return; }
      container.innerHTML = dates.map(date => {
        const data = dateMap.get(date); const d = new Date(date); const dayName = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][d.getDay()];
        return `<div class="grid grid-cols-2 gap-4 relative z-10 py-2">
      <div class="flex flex-col items-end">${data.trainings.length ? data.trainings.map(t => `<div class="bg-white rounded-2xl shadow-sm overflow-hidden w-full cursor-pointer" onclick="viewTraining(${t.id})">${t.thumbnail ? `<img src="${t.thumbnail}" class="w-full h-24 object-cover">` : `<div class="w-full h-24 bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center"><span class="text-4xl">${muscleIcons[t.targetMuscle] || 'ğŸ‹ï¸'}</span></div>`}<div class="p-3"><div class="flex items-center gap-2 mb-1"><span class="text-xs font-medium text-indigo-600">${t.targetMuscle}</span><span class="text-xs text-gray-400">${t.duration || ''}</span></div><div class="text-sm font-bold text-gray-800">${(t.totalVolume / 1000).toFixed(1)}t</div></div></div>`).join('') : `<div class="w-full h-24 rounded-2xl border-2 border-dashed border-gray-200 flex items-center justify-center"><span class="text-gray-400 text-sm">æ— è®­ç»ƒ</span></div>`}</div>
      <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20"><div class="bg-white rounded-full px-3 py-1 shadow-sm border text-center"><div class="text-xs font-medium">${formatDate(date, 'MM-DD')}</div><div class="text-xs text-gray-400">${dayName}</div></div></div>
      <div class="flex flex-col items-start">${data.meals.length ? `<div class="bg-white rounded-2xl shadow-sm overflow-hidden w-full"><div class="flex gap-1 overflow-x-auto hide-scrollbar p-2">${data.meals.map(m => `<div class="flex-shrink-0 w-16 text-center cursor-pointer" onclick="viewMeal(${m.id})">${m.thumbnail ? `<img src="${m.thumbnail}" class="w-16 h-16 rounded-xl object-cover">` : `<div class="w-16 h-16 rounded-xl bg-gradient-to-br from-pink-100 to-rose-100 flex items-center justify-center"><span class="text-2xl">${mealIcons[m.mealType]}</span></div>`}<div class="text-xs mt-1">${mealIcons[m.mealType]}</div></div>`).join('')}</div><div class="px-3 pb-2 border-t"><div class="text-sm font-bold text-pink-600">${data.meals.reduce((s, m) => s + (m.totalCalories || 0), 0)} kcal</div></div></div>` : `<div class="w-full h-24 rounded-2xl border-2 border-dashed border-gray-200 flex items-center justify-center"><span class="text-gray-400 text-sm">æ— é¥®é£Ÿè®°å½•</span></div>`}</div>
    </div>`;
      }).join('');
    };

    const renderQuickStats = async () => {
      const today = formatDate(new Date()), weekDates = getWeekDates();
      const count = await db.trainings.where('date').anyOf(weekDates).count(); document.getElementById('statTrainings').textContent = count;
      const meals = await db.meals.where('date').equals(today).toArray();
      const cal = meals.reduce((s, m) => s + (m.totalCalories || 0), 0), prot = meals.reduce((s, m) => s + (m.totalProtein || 0), 0);
      document.getElementById('statCalories').textContent = cal || '-'; document.getElementById('statProtein').textContent = prot ? `${prot}g` : '-';
    };

    const renderWeeklyChart = async () => {
      const weekDates = getWeekDates(); const [trainings, meals] = await Promise.all([db.trainings.where('date').anyOf(weekDates).toArray(), db.meals.where('date').anyOf(weekDates).toArray()]);
      const tByDate = {}, mByDate = {}; trainings.forEach(t => tByDate[t.date] = (tByDate[t.date] || 0) + (t.totalVolume || 0)); meals.forEach(m => mByDate[m.date] = (mByDate[m.date] || 0) + (m.totalCalories || 0));
      const maxVol = Math.max(...Object.values(tByDate), 1), maxCal = Math.max(...Object.values(mByDate), 1);
      document.getElementById('weeklyChart').innerHTML = weekDates.map(date => {
        const vol = tByDate[date] || 0, cal = mByDate[date] || 0; const volH = Math.max((vol / maxVol) * 100, 5), calH = Math.max((cal / maxCal) * 100, 5); const isToday = date === formatDate(new Date());
        return `<div class="flex-1 flex gap-0.5 items-end ${isToday ? 'opacity-100' : 'opacity-70'}"><div class="flex-1 rounded-t transition-all" style="height:${volH}%;background:linear-gradient(180deg,#818cf8 0%,#6366f1 100%);"></div><div class="flex-1 rounded-t transition-all" style="height:${calH}%;background:linear-gradient(180deg,#f472b6 0%,#ec4899 100%);"></div></div>`;
      }).join('');
    };

    const renderTrainingList = async () => {
      const container = document.getElementById('trainingList'); const trainings = await db.trainings.orderBy('date').reverse().limit(20).toArray();
      if (!trainings.length) { container.innerHTML = `<div class="text-center py-12"><div class="text-6xl mb-4">ğŸ‹ï¸</div><p class="text-gray-500">è¿˜æ²¡æœ‰è®­ç»ƒè®°å½•</p></div>`; return; }
      container.innerHTML = trainings.map(t => `<div class="bg-white rounded-2xl shadow-sm overflow-hidden cursor-pointer" onclick="viewTraining(${t.id})"><div class="flex">${t.thumbnail ? `<img src="${t.thumbnail}" class="w-24 h-24 object-cover">` : `<div class="w-24 h-24 bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center"><span class="text-4xl">${muscleIcons[t.targetMuscle] || 'ğŸ‹ï¸'}</span></div>`}<div class="flex-1 p-3"><div class="flex items-center gap-2 mb-1"><span class="text-sm font-medium">${formatDate(t.date, 'display')}</span><span class="px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded-full text-xs">${t.targetMuscle}</span></div><div class="text-lg font-bold text-indigo-600">${(t.totalVolume / 1000).toFixed(1)}t</div><div class="text-xs text-gray-500">${t.duration || ''} Â· ${t.exercises?.length || 0}ä¸ªåŠ¨ä½œ</div></div></div></div>`).join('');
    };

    const renderMealList = async () => {
      const container = document.getElementById('mealList'), today = formatDate(new Date()), cfg = await getConfig(); document.getElementById('todayDate').textContent = formatDate(new Date(), 'display');
      const meals = await db.meals.orderBy('date').reverse().limit(20).toArray(); const todayMeals = meals.filter(m => m.date === today);
      const sum = todayMeals.reduce((a, m) => ({ cal: a.cal + (m.totalCalories || 0), prot: a.prot + (m.totalProtein || 0), carb: a.carb + (m.totalCarbs || 0), fat: a.fat + (m.totalFat || 0) }), { cal: 0, prot: 0, carb: 0, fat: 0 });
      const targets = cfg.nutritionTargets;
      document.getElementById('todayCalories').textContent = sum.cal; document.getElementById('todayProtein').textContent = `${sum.prot}g`; document.getElementById('todayCarbs').textContent = `${sum.carb}g`; document.getElementById('todayFat').textContent = `${sum.fat}g`;
      document.getElementById('calBar').style.width = `${Math.min(100, sum.cal / targets.calories * 100)}%`; document.getElementById('protBar').style.width = `${Math.min(100, sum.prot / targets.protein * 100)}%`; document.getElementById('carbBar').style.width = `${Math.min(100, sum.carb / targets.carbs * 100)}%`; document.getElementById('fatBar').style.width = `${Math.min(100, sum.fat / targets.fat * 100)}%`;
      if (!meals.length) { container.innerHTML = `<div class="text-center py-12"><div class="text-6xl mb-4">ğŸ½ï¸</div><p class="text-gray-500">è¿˜æ²¡æœ‰é¥®é£Ÿè®°å½•</p></div>`; return; }
      container.innerHTML = meals.map(m => `<div class="bg-white rounded-2xl shadow-sm overflow-hidden cursor-pointer" onclick="viewMeal(${m.id})"><div class="flex">${m.thumbnail ? `<img src="${m.thumbnail}" class="w-24 h-24 object-cover">` : `<div class="w-24 h-24 bg-gradient-to-br from-pink-100 to-rose-100 flex items-center justify-center"><span class="text-4xl">${mealIcons[m.mealType]}</span></div>`}<div class="flex-1 p-3"><div class="flex items-center gap-2 mb-1"><span class="text-sm font-medium">${formatDate(m.date, 'display')}</span><span class="px-2 py-0.5 bg-pink-100 text-pink-600 rounded-full text-xs">${mealNames[m.mealType]}</span></div><div class="text-lg font-bold text-pink-600">${m.totalCalories} kcal</div><div class="text-xs text-gray-500">è›‹ç™½ ${m.totalProtein}g Â· ç¢³æ°´ ${m.totalCarbs}g Â· è„‚è‚ª ${m.totalFat}g</div></div></div></div>`).join('');
    };

    const renderBodyProgress = async () => {
      const container = document.getElementById('bodyProgressGallery'); const recs = await db.bodyProgress.orderBy('date').reverse().limit(10).toArray();
      if (!recs.length) { container.innerHTML = `<div class="flex-shrink-0 w-24 h-32 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>`; return; }
      container.innerHTML = recs.map(r => `<div class="flex-shrink-0 w-24">${r.thumbnail ? `<img src="${r.thumbnail}" class="w-24 h-32 rounded-xl object-cover">` : `<div class="w-24 h-32 rounded-xl bg-gradient-to-br from-emerald-100 to-teal-100 flex items-center justify-center"><span class="text-3xl">ğŸ“·</span></div>`}<div class="text-center mt-1"><div class="text-xs font-medium">${r.weight}kg</div><div class="text-xs text-gray-400">${formatDate(r.date, 'MM-DD')}</div></div></div>`).join('');
      // Volume chart
      const trainings = await db.trainings.orderBy('date').reverse().limit(7).toArray(); const maxVol = Math.max(...trainings.map(t => t.totalVolume || 0), 1);
      document.getElementById('volumeChart').innerHTML = trainings.reverse().map(t => `<div class="flex-1 flex flex-col items-center"><div class="w-full rounded-t transition-all bg-gradient-to-t from-indigo-500 to-indigo-300" style="height:${Math.max((t.totalVolume / maxVol) * 100, 10)}%"></div><div class="text-xs text-gray-400 mt-1">${formatDate(t.date, 'MM-DD')}</div></div>`).join('');
      // Weight chart
      if (recs.length) {
        const minW = Math.min(...recs.map(r => r.weight)), maxW = Math.max(...recs.map(r => r.weight)), range = maxW - minW || 1;
        document.getElementById('weightChart').innerHTML = recs.slice().reverse().map(r => `<div class="flex-1 flex flex-col items-center"><div class="w-full rounded-t transition-all bg-gradient-to-t from-emerald-500 to-emerald-300" style="height:${Math.max(((r.weight - minW) / range) * 100, 10)}%"></div><div class="text-xs text-gray-400 mt-1">${r.weight}</div></div>`).join('');
      }
    };

    const renderSettings = async () => {
      const cfg = await getConfig();
      document.getElementById('apiUrl1').value = cfg.api1.url; document.getElementById('apiKey1').value = cfg.api1.key; document.getElementById('apiModel1').value = cfg.api1.model;
      document.getElementById('apiUrl2').value = cfg.api2.url; document.getElementById('apiKey2').value = cfg.api2.key; document.getElementById('apiModel2').value = cfg.api2.model;
      document.getElementById('targetCalories').value = cfg.nutritionTargets.calories; document.getElementById('targetProtein').value = cfg.nutritionTargets.protein; document.getElementById('targetCarbs').value = cfg.nutritionTargets.carbs; document.getElementById('targetFat').value = cfg.nutritionTargets.fat;
      renderNutrientTags(cfg.trackedNutrients);
      // Load user profile
      if (cfg.userProfile) {
        if (cfg.userProfile.height) document.getElementById('userHeight').value = cfg.userProfile.height;
        if (cfg.userProfile.weight) document.getElementById('userWeight').value = cfg.userProfile.weight;
        if (cfg.userProfile.age) document.getElementById('userAge').value = cfg.userProfile.age;
        document.getElementById('userGender').value = cfg.userProfile.gender || 'male';
        document.getElementById('activityLevel').value = cfg.userProfile.activityLevel || 1.55;
      }
      // Initialize pie chart
      const t = cfg.nutritionTargets;
      updateMacroPieChart(t.protein * 4, t.carbs * 4, t.fat * 9, t.calories);
    };

    const renderNutrientTags = nutrients => { document.getElementById('nutrientTags').innerHTML = nutrients.map((n, i) => `<span class="inline-flex items-center gap-1 px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-sm">${n}<button onclick="removeNutrient(${i})" class="ml-1 hover:text-emerald-900">Ã—</button></span>`).join(''); };
    const removeNutrient = async i => { const cfg = await getConfig(); cfg.trackedNutrients.splice(i, 1); await saveConfig(cfg); renderNutrientTags(cfg.trackedNutrients); };
    const addNutrientHandler = async () => { const input = document.getElementById('newNutrient'), name = input.value.trim(); if (!name) return; const cfg = await getConfig(); if (!cfg.trackedNutrients.includes(name)) { cfg.trackedNutrients.push(name); await saveConfig(cfg); renderNutrientTags(cfg.trackedNutrients); } input.value = ''; };

    const updateMacroPieChart = (protCal, carbCal, fatCal, total) => {
      if (!total || total <= 0) return;
      const protPct = Math.round(protCal / total * 100);
      const carbPct = Math.round(carbCal / total * 100);
      const fatPct = Math.max(0, 100 - protPct - carbPct);
      // Update slider segments
      const segProt = document.getElementById('segmentProtein');
      const segCarbs = document.getElementById('segmentCarbs');
      const segFat = document.getElementById('segmentFat');
      if (segProt) segProt.style.width = protPct + '%';
      if (segCarbs) segCarbs.style.width = carbPct + '%';
      if (segFat) segFat.style.width = fatPct + '%';
      // Update handles
      const handleProt = document.getElementById('handleProtein');
      const handleCarbs = document.getElementById('handleCarbs');
      if (handleProt) handleProt.style.left = protPct + '%';
      if (handleCarbs) handleCarbs.style.left = (protPct + carbPct) + '%';
      // Update labels
      const protEl = document.getElementById('proteinPercent'); if (protEl) protEl.textContent = protPct + '%';
      const carbEl = document.getElementById('carbsPercent'); if (carbEl) carbEl.textContent = carbPct + '%';
      const fatEl = document.getElementById('fatPercent'); if (fatEl) fatEl.textContent = fatPct + '%';
    };

    const initMacroSlider = () => {
      const slider = document.getElementById('macroSlider');
      if (!slider) return;
      const handleProt = document.getElementById('handleProtein');
      const handleCarbs = document.getElementById('handleCarbs');
      let activeHandle = null;

      const getSliderPercent = (e) => {
        const rect = slider.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        return Math.max(5, Math.min(95, ((clientX - rect.left) / rect.width) * 100));
      };

      const updateFromSlider = (protPct, carbEndPct) => {
        const carbPct = carbEndPct - protPct;
        const fatPct = 100 - carbEndPct;
        // Update segments
        document.getElementById('segmentProtein').style.width = protPct + '%';
        document.getElementById('segmentCarbs').style.width = carbPct + '%';
        document.getElementById('segmentFat').style.width = fatPct + '%';
        // Update handles
        handleProt.style.left = protPct + '%';
        handleCarbs.style.left = carbEndPct + '%';
        // Update labels
        document.getElementById('proteinPercent').textContent = Math.round(protPct) + '%';
        document.getElementById('carbsPercent').textContent = Math.round(carbPct) + '%';
        document.getElementById('fatPercent').textContent = Math.round(fatPct) + '%';
        // Recalculate grams based on calories
        const calories = parseInt(document.getElementById('targetCalories').value) || 2200;
        const protein = Math.round((protPct / 100) * calories / 4);
        const carbs = Math.round((carbPct / 100) * calories / 4);
        const fat = Math.round((fatPct / 100) * calories / 9);
        document.getElementById('targetProtein').value = protein;
        document.getElementById('targetCarbs').value = carbs;
        document.getElementById('targetFat').value = fat;
      };

      const getCurrentPositions = () => {
        const protPct = parseFloat(handleProt.style.left) || 27;
        const carbEndPct = parseFloat(handleCarbs.style.left) || 72;
        return { protPct, carbEndPct };
      };

      const onMove = (e) => {
        if (!activeHandle) return;
        e.preventDefault();
        const percent = getSliderPercent(e);
        const { protPct, carbEndPct } = getCurrentPositions();
        if (activeHandle === handleProt) {
          updateFromSlider(Math.min(percent, carbEndPct - 10), carbEndPct);
        } else {
          updateFromSlider(protPct, Math.max(percent, protPct + 10));
        }
      };

      const onEnd = () => { activeHandle = null; };

      handleProt.addEventListener('mousedown', () => activeHandle = handleProt);
      handleCarbs.addEventListener('mousedown', () => activeHandle = handleCarbs);
      handleProt.addEventListener('touchstart', () => activeHandle = handleProt);
      handleCarbs.addEventListener('touchstart', () => activeHandle = handleCarbs);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('mouseup', onEnd);
      document.addEventListener('touchend', onEnd);
    };

    const calculateTargets = () => {
      const height = parseFloat(document.getElementById('userHeight').value);
      const weight = parseFloat(document.getElementById('userWeight').value);
      const age = parseInt(document.getElementById('userAge').value);
      const gender = document.getElementById('userGender').value;
      const activity = parseFloat(document.getElementById('activityLevel').value);
      if (!height || !weight || !age) { showToast('è¯·å¡«å†™å®Œæ•´çš„ä¸ªäººä¿¡æ¯', 'error'); return; }
      // Mifflin-St Jeor formula
      let bmr = 10 * weight + 6.25 * height - 5 * age;
      bmr = gender === 'male' ? bmr + 5 : bmr - 161;
      // TDEE = BMR Ã— activity factor
      let tdee = Math.round(bmr * activity);
      // Adjust based on goal
      if (state.goal === 'bulk') tdee += 300;
      else tdee -= 400;
      // Macro distribution
      const protein = Math.round(weight * 1.8);
      const proteinCal = protein * 4;
      const fatCal = Math.round(tdee * 0.25);
      const fat = Math.round(fatCal / 9);
      const carbsCal = tdee - proteinCal - fatCal;
      const carbs = Math.round(carbsCal / 4);
      // Fill in inputs
      document.getElementById('targetCalories').value = tdee;
      document.getElementById('targetProtein').value = protein;
      document.getElementById('targetCarbs').value = carbs;
      document.getElementById('targetFat').value = fat;
      // Update pie chart
      updateMacroPieChart(proteinCal, carbsCal, fatCal, tdee);
      showToast(`å·²è®¡ç®—ï¼šBMR ${Math.round(bmr)} kcal, TDEE ${tdee} kcal`, 'success');
    };

    const switchPage = name => {
      state.currentPage = name; document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(`page-${name}`).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => { n.classList.toggle('active', n.dataset.page === name); });
      if (name === 'home') { renderTimeline(); renderQuickStats(); renderWeeklyChart(); }
      else if (name === 'training') renderTrainingList();
      else if (name === 'nutrition') renderMealList();
      else if (name === 'stats') renderBodyProgress();
      else if (name === 'settings') renderSettings();
    };

    const openModal = id => { document.getElementById(id).classList.add('show'); document.body.style.overflow = 'hidden'; };
    const closeModal = id => { document.getElementById(id).classList.remove('show'); document.body.style.overflow = ''; };

    const handleTrainingImage = async file => {
      const compressed = await compressImage(file), thumbnail = await createThumbnail(file), base64 = await imageToBase64(compressed);
      state.currentTrainingImage = { compressed, thumbnail, base64 };
      document.getElementById('trainingImagePreview').classList.remove('hidden'); document.getElementById('trainingPreviewImg').src = base64;
      document.getElementById('trainingLoading').classList.remove('hidden'); document.getElementById('trainingParseResult').classList.add('hidden');
      try {
        const result = await parseTraining(base64); state.parsedTraining = result;
        let totalVol = 0; result.exercises?.forEach(ex => ex.sets?.forEach(s => totalVol += (s.weight || 0) * (s.reps || 0))); result.totalVolume = totalVol;
        document.getElementById('parsedTrainingDate').textContent = formatDate(result.date, 'display'); document.getElementById('parsedTrainingMuscle').textContent = result.targetMuscle;
        document.getElementById('parsedDuration').textContent = result.duration || '-'; document.getElementById('parsedVolume').textContent = `${(totalVol / 1000).toFixed(1)}t`; document.getElementById('parsedCalories').textContent = `${result.caloriesBurned || 0}kcal`;
        document.getElementById('exerciseList').innerHTML = result.exercises?.map((ex, i) => { const exVol = ex.sets?.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0) || 0; return `<div class="bg-white rounded-xl p-3 border item-selectable" data-exercise-index="${i}" onclick="handleExerciseItemClick(${i})"><div class="flex items-center justify-between mb-2"><span class="font-medium text-sm">${ex.name}</span><span class="text-xs text-gray-500">${(exVol / 1000).toFixed(1)}t</span></div><div class="flex flex-wrap gap-1">${ex.sets?.map(s => `<span class="px-2 py-0.5 bg-gray-100 rounded text-xs">${s.weight}kgÃ—${s.reps}</span>`).join('') || ''}</div></div>`; }).join('') || '';
        document.getElementById('trainingLoading').classList.add('hidden'); document.getElementById('trainingParseResult').classList.remove('hidden'); document.getElementById('saveTraining').disabled = false;
        // Show quick edit mascot button
        document.getElementById('trainingModalAiBtn').classList.remove('hidden');
      } catch (e) { console.error(e); showToast('è¯†åˆ«å¤±è´¥: ' + e.message, 'error'); document.getElementById('trainingLoading').classList.add('hidden'); }
    };

    const handleMealImage = async file => {
      const compressed = await compressImage(file), thumbnail = await createThumbnail(file), base64 = await imageToBase64(compressed);
      state.currentMealImage = { compressed, thumbnail, base64 };
      document.getElementById('mealImagePreview').classList.remove('hidden'); document.getElementById('mealPreviewImg').src = base64;
      document.getElementById('mealLoading').classList.remove('hidden'); document.getElementById('mealParseResult').classList.add('hidden');
      selectMealType(getMealTypeByTime());
      try {
        const cfg = await getConfig(), result = await parseMeal(base64, cfg.trackedNutrients); state.parsedMeal = result; renderParsedMeal(result);
        document.getElementById('mealLoading').classList.add('hidden'); document.getElementById('mealParseResult').classList.remove('hidden'); document.getElementById('saveMeal').disabled = false;
        // Show quick edit mascot button
        document.getElementById('mealModalAiBtn').classList.remove('hidden');
      } catch (e) { console.error(e); showToast('è¯†åˆ«å¤±è´¥: ' + e.message, 'error'); document.getElementById('mealLoading').classList.add('hidden'); }
    };

    const renderParsedMeal = result => {
      const sum = result.summary || {}; document.getElementById('mealTotalCalories').textContent = `${sum.totalCalories || 0} åƒå¡`; document.getElementById('mealTotalProtein').textContent = `${sum.totalProtein || 0}g`; document.getElementById('mealTotalCarbs').textContent = `${sum.totalCarbs || 0}g`; document.getElementById('mealTotalFat').textContent = `${sum.totalFat || 0}g`;
      document.getElementById('foodList').innerHTML = result.foods?.map((f, i) => `<div class="bg-white rounded-xl p-4 border item-selectable ${editState.selectedIndices.includes(i) ? 'item-selected' : ''}" data-food-index="${i}" onclick="handleFoodItemClick(${i})"><div class="flex items-center justify-between mb-3"><span class="font-medium">${f.name}</span><span class="text-sm text-pink-600 font-bold">${f.calories} kcal</span></div><div class="mb-3"><div class="flex items-center justify-between mb-1"><span class="text-sm text-gray-500">å…‹æ•°</span><span class="text-sm font-medium food-grams">${f.grams}g</span></div><input type="range" class="food-slider w-full" min="${Math.max(0, f.grams - 100)}" max="${f.grams + 100}" value="${f.grams}" step="5" style="--progress:${((f.grams - Math.max(0, f.grams - 100)) / 200) * 100}%" oninput="adjustFoodGrams(${i},this.value)" onclick="event.stopPropagation()"></div><div class="grid grid-cols-3 gap-2 text-center text-xs"><div class="bg-emerald-50 rounded-lg p-1"><div class="font-medium text-emerald-600 food-protein">${f.protein}g</div><div class="text-gray-500">è›‹ç™½</div></div><div class="bg-amber-50 rounded-lg p-1"><div class="font-medium text-amber-600 food-carbs">${f.carbs}g</div><div class="text-gray-500">ç¢³æ°´</div></div><div class="bg-blue-50 rounded-lg p-1"><div class="font-medium text-blue-600 food-fat">${f.fat}g</div><div class="text-gray-500">è„‚è‚ª</div></div></div></div>`).join('') || '';
    };

    const adjustFoodGrams = (i, newGrams) => {
      if (!state.parsedMeal?.foods?.[i]) return; const f = state.parsedMeal.foods[i], orig = f.originalGrams || f.grams; f.originalGrams = orig; const ratio = newGrams / orig;
      f.grams = parseInt(newGrams); f.calories = Math.round((f.originalCalories || f.calories) * ratio); f.protein = Math.round((f.originalProtein || f.protein) * ratio); f.carbs = Math.round((f.originalCarbs || f.carbs) * ratio); f.fat = Math.round((f.originalFat || f.fat) * ratio);
      f.originalCalories = f.originalCalories || f.calories / ratio; f.originalProtein = f.originalProtein || f.protein / ratio; f.originalCarbs = f.originalCarbs || f.carbs / ratio; f.originalFat = f.originalFat || f.fat / ratio;
      const c = document.querySelector(`[data-food-index="${i}"]`); if (c) { c.querySelector('.food-grams').textContent = `${f.grams}g`; c.querySelector('.food-protein').textContent = `${f.protein}g`; c.querySelector('.food-carbs').textContent = `${f.carbs}g`; c.querySelector('.food-fat').textContent = `${f.fat}g`; const sl = c.querySelector('.food-slider'), min = parseInt(sl.min), max = parseInt(sl.max); sl.style.setProperty('--progress', `${((newGrams - min) / (max - min)) * 100}%`); }
      const sum = state.parsedMeal.foods.reduce((a, fd) => ({ totalCalories: a.totalCalories + fd.calories, totalProtein: a.totalProtein + fd.protein, totalCarbs: a.totalCarbs + fd.carbs, totalFat: a.totalFat + fd.fat }), { totalCalories: 0, totalProtein: 0, totalCarbs: 0, totalFat: 0 }); state.parsedMeal.summary = sum;
      document.getElementById('mealTotalCalories').textContent = `${sum.totalCalories} åƒå¡`; document.getElementById('mealTotalProtein').textContent = `${sum.totalProtein}g`; document.getElementById('mealTotalCarbs').textContent = `${sum.totalCarbs}g`; document.getElementById('mealTotalFat').textContent = `${sum.totalFat}g`;
    };

    const selectMealType = type => { state.selectedMealType = type; document.querySelectorAll('.meal-type-btn').forEach(b => { b.classList.toggle('border-pink-500', b.dataset.type === type); b.classList.toggle('bg-pink-50', b.dataset.type === type); b.classList.toggle('border-gray-200', b.dataset.type !== type); }); };

    // ========== Quick Edit Agent Functions ==========
    const handleFoodItemClick = (index) => {
      if (!editState.isActive) return; // Only handle clicks in edit mode
      const idx = editState.selectedIndices.indexOf(index);
      if (idx === -1) { editState.selectedIndices.push(index); }
      else { editState.selectedIndices.splice(idx, 1); }
      // Re-render to show selection
      renderParsedMeal(state.parsedMeal);
      updateSelectionHint();
    };

    const handleExerciseItemClick = (index) => {
      if (!editState.isActive) return;
      const el = document.querySelector(`[data-exercise-index="${index}"]`);
      if (!el) return;
      const idx = editState.selectedIndices.indexOf(index);
      if (idx === -1) {
        editState.selectedIndices.push(index);
        el.classList.add('item-selected');
      } else {
        editState.selectedIndices.splice(idx, 1);
        el.classList.remove('item-selected');
      }
      updateSelectionHint();
    };

    const updateSelectionHint = () => {
      const count = editState.selectedIndices.length;
      const hint = document.getElementById('editSelectionHint');
      if (count > 0) {
        hint.innerHTML = `<span class="text-indigo-600 font-medium">å·²é€‰ä¸­ ${count} é¡¹</span><span class="text-gray-400 ml-2">è¾“å…¥æŒ‡ä»¤åç‚¹å‡»å‘é€</span>`;
      } else {
        hint.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span>ç‚¹å‡»ä¸Šæ–¹é¡¹ç›®é€‰ä¸­ï¼ˆå¯å¤šé€‰ï¼‰ï¼Œç„¶åè¾“å…¥ä¿®æ”¹æŒ‡ä»¤</span>`;
      }
    };

    const openQuickEditPanel = (context) => {
      editState.isActive = true;
      editState.context = context;
      editState.selectedIndices = [];
      editState.tempResult = null;
      // Show panel
      document.getElementById('quickEditPanel').classList.add('show');
      document.getElementById('editDiffContainer').classList.add('hidden');
      document.getElementById('editActions').classList.add('hidden');
      document.getElementById('editLoading').classList.add('hidden');
      document.getElementById('editInput').value = '';
      updateSelectionHint();
      // Refresh lists to show selectable state
      if (context === 'meal') renderParsedMeal(state.parsedMeal);
      showToast('ç‚¹å‡»é£Ÿç‰©é¡¹é€‰ä¸­åè¾“å…¥ä¿®æ”¹æŒ‡ä»¤', 'info');
    };

    const closeQuickEditPanel = () => {
      editState.isActive = false;
      editState.selectedIndices = [];
      editState.tempResult = null;
      document.getElementById('quickEditPanel').classList.remove('show');
      // Refresh to remove selection state
      if (editState.context === 'meal' && state.parsedMeal) renderParsedMeal(state.parsedMeal);
      else if (editState.context === 'training' && state.parsedTraining) {
        document.querySelectorAll('[data-exercise-index]').forEach(el => el.classList.remove('item-selected'));
      }
      editState.context = null;
    };

    const runQuickEdit = async () => {
      const instruction = document.getElementById('editInput').value.trim();
      if (!instruction) { showToast('è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤', 'error'); return; }
      if (editState.selectedIndices.length === 0) { showToast('è¯·å…ˆé€‰ä¸­è¦ä¿®æ”¹çš„é¡¹ç›®', 'error'); return; }

      editState.lastInstruction = instruction;
      const sourceData = editState.context === 'meal' ? state.parsedMeal.foods : state.parsedTraining.exercises;
      const selectedItems = editState.selectedIndices.map(i => sourceData[i]);

      // Show loading
      document.getElementById('editLoading').classList.remove('hidden');
      document.getElementById('editDiffContainer').classList.add('hidden');
      document.getElementById('editActions').classList.add('hidden');

      const itemType = editState.context === 'meal' ? 'é£Ÿç‰©' : 'è®­ç»ƒåŠ¨ä½œ';
      const prompt = `ä½ æ˜¯ä¸€ä¸ªæ•°æ®ä¿®æ­£åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·æŒ‡ä»¤ä¿®æ”¹${itemType}æ•°æ®ã€‚

å½“å‰${itemType}æ•°æ®:
${JSON.stringify(selectedItems, null, 2)}

ç”¨æˆ·æŒ‡ä»¤: "${instruction}"

è¯·æ ¹æ®æŒ‡ä»¤ä¿®æ”¹æ•°æ®ã€‚è§„åˆ™ï¼š
1. å¦‚æœæ˜¯ä¿®æ”¹ï¼Œè¿”å›ä¿®æ”¹åçš„JSONæ•°ç»„
2. å¦‚æœæ˜¯åˆ é™¤ï¼Œè¿”å›ç©ºæ•°ç»„ []
3. å¦‚æœæ˜¯æ‹†åˆ†ï¼Œè¿”å›å¤šä¸ªé¡¹çš„æ•°ç»„
4. ä¿æŒæ•°æ®ç»“æ„ä¸å˜ï¼Œåªä¿®æ”¹ç›¸å…³å­—æ®µ
${editState.context === 'meal' ? '5. é£Ÿç‰©æ•°æ®åŒ…å«: name, grams, calories, protein, carbs, fat å­—æ®µ' : '5. è®­ç»ƒæ•°æ®åŒ…å«: name, sets (åŒ…å« weight, reps) å­—æ®µ'}

åªè¿”å›çº¯JSONæ•°ç»„ï¼Œä¸è¦ä»»ä½•è§£é‡Šæˆ–markdownæ ¼å¼ã€‚`;

      try {
        const response = await callAI([{ role: 'user', content: prompt }]);
        let result = '';
        await streamAI(response, (_, full) => result = full);

        // Extract JSON from response
        const jsonMatch = result.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error('æœªèƒ½è§£æAIè¿”å›ç»“æœ');

        editState.tempResult = JSON.parse(jsonMatch[0]);
        document.getElementById('editLoading').classList.add('hidden');
        renderDiffView(selectedItems, editState.tempResult);
      } catch (e) {
        console.error(e);
        showToast('AIå¤„ç†å¤±è´¥: ' + e.message, 'error');
        document.getElementById('editLoading').classList.add('hidden');
      }
    };

    const renderDiffView = (oldItems, newItems) => {
      const container = document.getElementById('editDiffContainer');
      const isMeal = editState.context === 'meal';

      let html = '<div class="font-medium text-gray-600 mb-2">ä¿®æ”¹å¯¹æ¯”</div>';

      // Old items (gray)
      html += '<div class="space-y-1">';
      oldItems.forEach(item => {
        if (isMeal) {
          html += `<div class="bg-gray-100 rounded-lg p-2 diff-old"><span class="text-gray-500 line-through">${item.name}</span> <span class="text-gray-400">${item.grams}g Â· ${item.calories}kcal</span></div>`;
        } else {
          const vol = item.sets?.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0) || 0;
          html += `<div class="bg-gray-100 rounded-lg p-2 diff-old"><span class="text-gray-500 line-through">${item.name}</span> <span class="text-gray-400">${(vol / 1000).toFixed(1)}t</span></div>`;
        }
      });
      html += '</div>';

      // Arrow
      html += '<div class="text-center py-1 text-indigo-500 font-bold">â†“</div>';

      // New items (green) or delete message
      html += '<div class="space-y-1">';
      if (newItems.length === 0) {
        html += '<div class="bg-red-50 rounded-lg p-2 text-red-600 text-center">ğŸ—‘ï¸ å°†åˆ é™¤é€‰ä¸­é¡¹</div>';
      } else {
        newItems.forEach(item => {
          if (isMeal) {
            html += `<div class="bg-green-50 rounded-lg p-2 diff-new"><span class="font-medium text-green-700">${item.name}</span> <span class="text-green-600">${item.grams}g Â· ${item.calories}kcal</span></div>`;
          } else {
            const vol = item.sets?.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0) || 0;
            html += `<div class="bg-green-50 rounded-lg p-2 diff-new"><span class="font-medium text-green-700">${item.name}</span> <span class="text-green-600">${(vol / 1000).toFixed(1)}t</span></div>`;
          }
        });
      }
      html += '</div>';

      container.innerHTML = html;
      container.classList.remove('hidden');
      document.getElementById('editActions').classList.remove('hidden');
    };

    const confirmQuickEdit = () => {
      if (!editState.tempResult) return;

      const sourceData = editState.context === 'meal' ? state.parsedMeal.foods : state.parsedTraining.exercises;
      // Sort indices descending for safe removal
      const sortedIndices = [...editState.selectedIndices].sort((a, b) => b - a);

      // Remove old items
      sortedIndices.forEach(i => sourceData.splice(i, 1));

      // Insert new items at the first removed position (smallest index)
      const insertAt = Math.min(...editState.selectedIndices);
      sourceData.splice(insertAt, 0, ...editState.tempResult);

      // Recalculate summary if meal
      if (editState.context === 'meal') {
        const sum = sourceData.reduce((a, f) => ({
          totalCalories: a.totalCalories + (f.calories || 0),
          totalProtein: a.totalProtein + (f.protein || 0),
          totalCarbs: a.totalCarbs + (f.carbs || 0),
          totalFat: a.totalFat + (f.fat || 0)
        }), { totalCalories: 0, totalProtein: 0, totalCarbs: 0, totalFat: 0 });
        state.parsedMeal.summary = sum;
        renderParsedMeal(state.parsedMeal);
      } else {
        // Recalculate training volume
        let totalVol = 0;
        sourceData.forEach(ex => ex.sets?.forEach(s => totalVol += (s.weight || 0) * (s.reps || 0)));
        state.parsedTraining.totalVolume = totalVol;
        document.getElementById('parsedVolume').textContent = `${(totalVol / 1000).toFixed(1)}t`;
        // Re-render exercise list
        document.getElementById('exerciseList').innerHTML = sourceData.map((ex, i) => {
          const exVol = ex.sets?.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0) || 0;
          return `<div class="bg-white rounded-xl p-3 border item-selectable" data-exercise-index="${i}" onclick="handleExerciseItemClick(${i})"><div class="flex items-center justify-between mb-2"><span class="font-medium text-sm">${ex.name}</span><span class="text-xs text-gray-500">${(exVol / 1000).toFixed(1)}t</span></div><div class="flex flex-wrap gap-1">${ex.sets?.map(s => `<span class="px-2 py-0.5 bg-gray-100 rounded text-xs">${s.weight}kgÃ—${s.reps}</span>`).join('') || ''}</div></div>`;
        }).join('') || '';
      }

      showToast('å·²æ›´æ–°æ•°æ®', 'success');
      closeQuickEditPanel();
    };

    const retryQuickEdit = () => {
      editState.tempResult = null;
      document.getElementById('editDiffContainer').classList.add('hidden');
      document.getElementById('editActions').classList.add('hidden');
      document.getElementById('editInput').value = editState.lastInstruction;
      document.getElementById('editInput').focus();
    };
    // ========== End Quick Edit Agent Functions ==========

    const saveTrainingRecord = async () => {

      if (!state.parsedTraining || !state.currentTrainingImage) return;
      const rec = { date: state.parsedTraining.date || formatDate(new Date()), targetMuscle: state.parsedTraining.targetMuscle, duration: state.parsedTraining.duration, caloriesBurned: state.parsedTraining.caloriesBurned, totalVolume: state.parsedTraining.totalVolume, exercises: state.parsedTraining.exercises, thumbnail: state.currentTrainingImage.thumbnail, createdAt: new Date().toISOString() };
      await db.trainings.add(rec); showToast('è®­ç»ƒè®°å½•å·²ä¿å­˜', 'success'); closeModal('trainingModal');
      state.parsedTraining = null; state.currentTrainingImage = null; document.getElementById('trainingImagePreview').classList.add('hidden'); document.getElementById('trainingParseResult').classList.add('hidden'); document.getElementById('saveTraining').disabled = true; switchPage('training');
    };

    const saveMealRecord = async () => {
      if (!state.parsedMeal || !state.selectedMealType) return; const sum = state.parsedMeal.summary || {};
      const rec = { date: formatDate(new Date()), mealType: state.selectedMealType, foods: state.parsedMeal.foods, totalCalories: sum.totalCalories || 0, totalProtein: sum.totalProtein || 0, totalCarbs: sum.totalCarbs || 0, totalFat: sum.totalFat || 0, thumbnail: state.currentMealImage?.thumbnail, createdAt: new Date().toISOString() };
      await db.meals.add(rec); showToast('é¥®é£Ÿè®°å½•å·²ä¿å­˜', 'success'); closeModal('mealModal');
      state.parsedMeal = null; state.currentMealImage = null; state.selectedMealType = null; document.getElementById('mealImagePreview').classList.add('hidden'); document.getElementById('mealParseResult').classList.add('hidden'); document.getElementById('saveMeal').disabled = true; switchPage('nutrition');
    };

    const saveBodyPhotoRecord = async () => {
      const weight = parseFloat(document.getElementById('bodyWeight').value); if (!weight || !state.currentBodyImage) return;
      const rec = { date: formatDate(new Date()), weight, thumbnail: state.currentBodyImage.thumbnail, createdAt: new Date().toISOString() };
      await db.bodyProgress.add(rec); showToast('èº«ä½“è®°å½•å·²ä¿å­˜', 'success'); closeModal('bodyPhotoModal');
      state.currentBodyImage = null; document.getElementById('bodyImagePreview').classList.add('hidden'); document.getElementById('bodyWeight').value = ''; document.getElementById('saveBodyPhoto').disabled = true; renderBodyProgress();
    };

    const exportData = async () => {
      showToast('æ­£åœ¨å¯¼å‡ºæ•°æ®...', 'info');
      try {
        const zip = new JSZip(); const data = { trainings: await db.trainings.toArray(), meals: await db.meals.toArray(), bodyProgress: await db.bodyProgress.toArray(), config: await db.config.toArray(), exportDate: new Date().toISOString() };
        zip.file('data.json', JSON.stringify(data, null, 2)); const imgFolder = zip.folder('imgs'); let idx = 0;
        for (const t of data.trainings) if (t.thumbnail) { const b64 = t.thumbnail.split(',')[1]; imgFolder.file(`training_${t.date}_${idx++}.jpg`, b64, { base64: true }); }
        for (const m of data.meals) if (m.thumbnail) { const b64 = m.thumbnail.split(',')[1]; imgFolder.file(`meal_${m.date}_${m.mealType}_${idx++}.jpg`, b64, { base64: true }); }
        for (const b of data.bodyProgress) if (b.thumbnail) { const b64 = b.thumbnail.split(',')[1]; imgFolder.file(`body_${b.date}_${idx++}.jpg`, b64, { base64: true }); }
        const blob = await zip.generateAsync({ type: 'blob' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `FitBreezy_backup_${formatDate(new Date())}.zip`; a.click(); URL.revokeObjectURL(url); showToast('å¯¼å‡ºæˆåŠŸ', 'success');
      } catch (e) { console.error(e); showToast('å¯¼å‡ºå¤±è´¥: ' + e.message, 'error'); }
    };

    const importData = async (file, mode = 'full') => {
      showToast('æ­£åœ¨å¯¼å…¥æ•°æ®...', 'info');
      try {
        const zip = await JSZip.loadAsync(file); const dataFile = zip.file('data.json'); if (!dataFile) throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶');
        const data = JSON.parse(await dataFile.async('string'));
        if (mode === 'full') { await db.trainings.clear(); await db.meals.clear(); await db.bodyProgress.clear(); }
        for (const t of data.trainings || []) { if (mode === 'incremental') { const ex = await db.trainings.where('date').equals(t.date).first(); if (ex) continue; } delete t.id; await db.trainings.add(t); }
        for (const m of data.meals || []) { if (mode === 'incremental') { const ex = await db.meals.where({ date: m.date, mealType: m.mealType }).first(); if (ex) continue; } delete m.id; await db.meals.add(m); }
        for (const b of data.bodyProgress || []) { if (mode === 'incremental') { const ex = await db.bodyProgress.where('date').equals(b.date).first(); if (ex) continue; } delete b.id; await db.bodyProgress.add(b); }
        if (mode === 'full' && data.config) for (const c of data.config) await db.config.put(c);
        showToast('å¯¼å…¥æˆåŠŸ', 'success'); switchPage('home');
      } catch (e) { console.error(e); showToast('å¯¼å…¥å¤±è´¥: ' + e.message, 'error'); }
    };

    const clearAllData = async () => {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return; if (!confirm('å†æ¬¡ç¡®è®¤ï¼šæ‰€æœ‰æ•°æ®éƒ½å°†è¢«åˆ é™¤ï¼')) return;
      await db.trainings.clear(); await db.meals.clear(); await db.bodyProgress.clear(); showToast('æ•°æ®å·²æ¸…ç©º', 'success'); switchPage('home');
    };

    const sendChatMessage = async () => {
      const input = document.getElementById('chatInput'), msg = input.value.trim();
      if (!msg) return;
      input.value = '';

      const chatMsgs = document.getElementById('chatMessages');
      chatMsgs.innerHTML += `<div class="chat-bubble user p-4"><p>${msg}</p></div>`;

      // Create container for multi-step display
      const containerId = 'steps-' + Date.now();
      const isDeepMode = state.aiMode === 'deep';

      if (isDeepMode) {
        chatMsgs.innerHTML += `<div id="${containerId}" class="step-container max-w-[85%]"></div>`;
      } else {
        chatMsgs.innerHTML += `<div id="${containerId}" class="chat-bubble ai p-4"><div class="flex items-center gap-2"><div class="loader"></div><span class="text-gray-500">æ€è€ƒä¸­...</span></div></div>`;
      }
      chatMsgs.scrollTop = chatMsgs.scrollHeight;

      state.chatHistory.push({ role: 'user', content: msg });

      try {
        const agent = await runAgent(msg);
        const container = document.getElementById(containerId);
        let currentStepId = null;
        let stepCount = 0;
        const stepData = []; // Store step info for collapsing
        const usedIcons = new Set(); // Track used icons to avoid duplicates

        // Tool name to icon mapping
        const toolIconMap = {
          'getBodyProgress': 'âš–ï¸',
          'calculateStats': 'ğŸ“Š',
          'getTrainingRecords': 'ğŸ’ª',
          'getMealRecords': 'ğŸ½ï¸',
          'predictGoal': 'ğŸ¯'
        };
        // Fallback icons when primary icons are used
        const fallbackIcons = ['ğŸ”', 'ğŸ“ˆ', 'ğŸƒ', 'ğŸ’¡', 'ğŸ“', 'ğŸ§®', 'ğŸ“‹', 'ğŸšï¸', 'â±ï¸', 'âœ…'];

        // Store stepData in a global map so event delegation can access it
        if (!window.stepDataMap) window.stepDataMap = {};
        window.stepDataMap[containerId] = stepData;

        // Setup event delegation on container for step clicks
        container.addEventListener('click', function (e) {
          const stepBubble = e.target.closest('.step-bubble.collapsed');
          if (!stepBubble) {
            // Check if clicking on expanded step to collapse
            const expandedStep = e.target.closest('.step-bubble:not(.current)');
            if (expandedStep && !expandedStep.classList.contains('collapsed')) {
              const stepId = expandedStep.id;
              const data = stepData.find(s => s.id === stepId);
              if (data) {
                console.log('[Step Click] Collapsing step:', stepId);
                expandedStep.classList.add('collapsed');
                expandedStep.innerHTML = `<div class="step-summary"><span class="step-icon">${data.stepIcon}</span> ${data.thinkingSummary || 'åˆ†æä¸­'}</div>`;
              }
            }
            return;
          }

          const stepId = stepBubble.id;
          const data = stepData.find(s => s.id === stepId);
          console.log('[Step Click] Clicked:', stepId, 'Data:', data);

          if (data) {
            stepBubble.classList.remove('collapsed');
            stepBubble.innerHTML = data.fullHtml;
          }
        });

        for await (const chunk of agent.stream()) {
          const turn = chunk.turn || 1;

          // Handle multi-step mode
          if (isDeepMode) {
            // Create new step bubble for each turn
            if (turn > stepCount) {
              // Use placeholder icon first, will be updated when tool is called
              const placeholderIcon = fallbackIcons[turn - 1] || 'ğŸ”';

              // Collapse previous step if exists
              if (stepCount > 0 && stepData[stepCount - 1]) {
                const prevStep = document.getElementById(stepData[stepCount - 1].id);
                const prevData = stepData[stepCount - 1];
                if (prevStep) {
                  prevStep.classList.add('collapsed');
                  prevStep.classList.remove('current');
                  const collapsedSummary = prevData.thinkingSummary || 'åˆ†æä¸­';
                  prevStep.innerHTML = `<div class="step-summary"><span class="step-icon">${prevData.stepIcon}</span> ${collapsedSummary}</div>`;
                  // Click handler now managed by event delegation
                }
              }

              stepCount = turn;
              currentStepId = `step-${containerId}-${turn}`;
              container.innerHTML += `<div id="${currentStepId}" class="step-bubble current"><div class="flex items-center gap-2"><span class="step-icon">${placeholderIcon}</span><div class="loader" style="width:12px;height:12px;border-width:2px;"></div><span class="text-gray-500 text-sm">åˆ†æä¸­...</span></div></div>`;
              stepData.push({ id: currentStepId, stepIcon: placeholderIcon, thinkingSummary: '', toolName: '', fullHtml: '' });
            }

            const stepEl = document.getElementById(currentStepId);
            if (!stepEl) continue;

            if (chunk.type === 'content') {
              const c = chunk.full;
              // Parse icon from LLM output (e.g. "å›¾æ ‡: âš–ï¸")
              const iconMatch = c.match(/å›¾æ ‡[:ï¼š]\s*([\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+)/u);
              if (iconMatch) {
                stepData[turn - 1].stepIcon = iconMatch[1].trim();
                console.log('[Icon Parsed]', iconMatch[1]);
              }
              const thinkMatch = c.match(/æ€è€ƒ[:ï¼š]\s*([^\n]+)/);
              const stepIcon = stepData[turn - 1].stepIcon;
              let html = '<div class="space-y-2">';
              if (thinkMatch) {
                const thinkText = thinkMatch[1].trim();
                html += `<div class="text-xs text-gray-600 flex items-center gap-2"><span class="step-icon">${stepIcon}</span><span>${thinkText}</span></div>`;
                // Store thinking for collapsed summary (truncate to 40 chars)
                stepData[turn - 1].thinkingSummary = thinkText.length > 40 ? thinkText.slice(0, 40) + '...' : thinkText;
              }
              html += '</div>';
              stepEl.innerHTML = html;
              stepData[turn - 1].fullHtml = html;
            } else if (chunk.type === 'tool_call') {
              const thinkText = stepData[turn - 1].thinkingSummary || 'åˆ†æä¸­';
              stepData[turn - 1].toolName = chunk.tool;

              // Auto-select icon based on tool name with deduplication
              let selectedIcon = toolIconMap[chunk.tool];
              if (!selectedIcon || usedIcons.has(selectedIcon)) {
                // Find first unused fallback icon
                for (const icon of fallbackIcons) {
                  if (!usedIcons.has(icon)) {
                    selectedIcon = icon;
                    break;
                  }
                }
              }
              // Mark this icon as used
              if (selectedIcon) usedIcons.add(selectedIcon);
              stepData[turn - 1].stepIcon = selectedIcon || 'ğŸ”';

              const html = `<div class="space-y-2"><div class="text-xs text-gray-600 flex items-center gap-2"><span class="step-icon">${stepData[turn - 1].stepIcon}</span><span>${thinkText}</span></div><div class="text-xs bg-indigo-50 rounded-lg p-2 mt-2"><div class="flex items-center gap-1 text-indigo-600"><div class="loader" style="width:10px;height:10px;border-width:2px;"></div><span>è°ƒç”¨ ${chunk.tool}...</span></div></div></div>`;
              stepEl.innerHTML = html;
              stepData[turn - 1].fullHtml = html;
            } else if (chunk.type === 'tool_result') {
              const resultStr = JSON.stringify(chunk.result, null, 2);
              const thinkText = stepData[turn - 1].thinkingSummary || 'åˆ†æä¸­';
              const stepIcon = stepData[turn - 1].stepIcon;
              const html = `<div class="space-y-2"><div class="text-xs text-gray-600 flex items-center gap-2"><span class="step-icon">${stepIcon}</span><span>${thinkText}</span></div><div class="text-xs bg-green-50 rounded-lg p-2 mt-2 text-green-700"><div class="font-medium">OK ${chunk.tool}</div><pre class="mt-1 overflow-x-auto text-xs max-h-20 overflow-y-auto">${resultStr.slice(0, 150)}${resultStr.length > 150 ? '...' : ''}</pre></div></div>`;
              stepEl.innerHTML = html;
              stepData[turn - 1].fullHtml = html;
            } else if (chunk.type === 'done') {
              // Final answer - collapse last step
              const lastData = stepData[turn - 1];
              if (lastData) {
                stepEl.classList.remove('current');
                stepEl.classList.add('collapsed');
                const summary = lastData.thinkingSummary || 'åˆ†æå®Œæˆ';
                stepEl.innerHTML = `<div class="step-summary"><span class="step-icon">${lastData.stepIcon}</span> ${summary}</div>`;
                // Click handler managed by event delegation
              }

              // Add final answer as main bubble
              const finalHtml = `<div class="step-bubble current" style="background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border-left:3px solid #0ea5e9;"><div class="font-medium text-sm text-sky-700 mb-2">ğŸ“‹ ç»¼åˆåˆ†æç»“æœ</div><div class="text-sm">${chunk.full.replace(/\n/g, '<br>')}</div></div>`;
              container.innerHTML += finalHtml;
              state.chatHistory.push({ role: 'assistant', content: chunk.full });
            }
          } else {
            // Simple mode - single bubble
            if (chunk.type === 'content') {
              const c = chunk.full;
              const thinkMatch = c.match(/æ€è€ƒ[:ï¼š]\s*([^\n]+)/g);
              const answerMatch = c.match(/å›ç­”[:ï¼š]\s*([\s\S]*?)$/);
              let html = '<div class="space-y-2">';
              if (thinkMatch) html += `<div class="text-xs text-gray-400 flex items-center gap-1"><span class="text-indigo-400">*</span><span>${thinkMatch[thinkMatch.length - 1].replace(/æ€è€ƒ[:ï¼š]/, '').trim()}</span></div>`;
              if (answerMatch) html += `<p class="mt-2">${answerMatch[1].trim().replace(/\n/g, '<br>')}</p>`;
              else if (!thinkMatch) html += `<p>${c.replace(/\n/g, '<br>')}</p>`;
              html += '</div>';
              container.innerHTML = html;
            } else if (chunk.type === 'tool_call') {
              container.innerHTML = `<div class="text-xs bg-indigo-50 rounded-lg p-2"><div class="flex items-center gap-1 text-indigo-600"><div class="loader" style="width:12px;height:12px;border-width:2px;"></div><span>è°ƒç”¨ ${chunk.tool}...</span></div></div>`;
            } else if (chunk.type === 'tool_result') {
              container.innerHTML = `<div class="text-xs bg-green-50 rounded-lg p-2 text-green-700"><div class="font-medium">OK ${chunk.tool}</div></div><div class="mt-2 flex items-center gap-2"><div class="loader" style="width:12px;height:12px;border-width:2px;"></div><span class="text-sm text-gray-500">ç”Ÿæˆå›ç­”ä¸­...</span></div>`;
            } else if (chunk.type === 'done') {
              container.innerHTML = `<p>${chunk.full.replace(/\n/g, '<br>')}</p>`;
              state.chatHistory.push({ role: 'assistant', content: chunk.full });
            }
          }
          chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }
      } catch (e) {
        console.error(e);
        document.getElementById(containerId).innerHTML = `<p class="text-red-500">æŠ±æ­‰ï¼Œå‡ºé”™äº†: ${e.message}</p><p class="text-sm text-gray-500 mt-1">è¯·æ£€æŸ¥APIé…ç½®</p>`;
      }
    };

    const viewTraining = id => { console.log('View training:', id); };
    const viewMeal = id => { console.log('View meal:', id); };

    const init = () => {
      document.getElementById('currentDate').textContent = formatDate(new Date(), 'display'); document.getElementById('monthDisplay').textContent = formatDate(state.currentMonth, 'month');
      document.querySelectorAll('.nav-item').forEach(b => b.addEventListener('click', () => switchPage(b.dataset.page)));
      document.getElementById('prevMonth').addEventListener('click', () => { state.currentMonth.setMonth(state.currentMonth.getMonth() - 1); document.getElementById('monthDisplay').textContent = formatDate(state.currentMonth, 'month'); renderTimeline(); });
      document.getElementById('nextMonth').addEventListener('click', () => { state.currentMonth.setMonth(state.currentMonth.getMonth() + 1); document.getElementById('monthDisplay').textContent = formatDate(state.currentMonth, 'month'); renderTimeline(); });
      document.getElementById('goalToggle').addEventListener('click', function () { state.goal = state.goal === 'bulk' ? 'cut' : 'bulk'; this.textContent = state.goal === 'bulk' ? 'å¢è‚Œæ¨¡å¼' : 'å‡è„‚æ¨¡å¼'; this.classList.toggle('bg-pink-100', state.goal === 'cut'); this.classList.toggle('text-pink-600', state.goal === 'cut'); this.classList.toggle('bg-indigo-100', state.goal === 'bulk'); this.classList.toggle('text-indigo-600', state.goal === 'bulk'); });
      document.getElementById('addTraining').addEventListener('click', () => openModal('trainingModal'));
      document.getElementById('addMeal').addEventListener('click', () => openModal('mealModal'));
      document.getElementById('addBodyPhoto').addEventListener('click', () => openModal('bodyPhotoModal'));
      document.querySelectorAll('.close-modal').forEach(b => b.addEventListener('click', function () { this.closest('.modal-overlay').classList.remove('show'); document.body.style.overflow = ''; }));
      document.getElementById('aiAssistantBtn').addEventListener('click', () => openModal('chatModal'));
      document.getElementById('closeChatModal').addEventListener('click', () => closeModal('chatModal'));
      document.getElementById('sendChat').addEventListener('click', sendChatMessage);
      document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendChatMessage(); });
      document.getElementById('resetChat').addEventListener('click', () => {
        state.chatHistory = [];
        const chatMsgs = document.getElementById('chatMessages');
        chatMsgs.innerHTML = `<div class="chat-bubble ai p-4"><p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½å¥èº«åŠ©æ‰‹ã€‚</p><p class="mt-2 text-sm text-gray-600">ä½ å¯ä»¥é—®æˆ‘ï¼š</p><ul class="mt-1 text-sm text-gray-600 space-y-1"><li>â€¢ æœ€è¿‘çš„é¥®é£ŸçŠ¶æ€å¦‚ä½•ï¼Ÿ</li><li>â€¢ æœ€è¿‘4æ¬¡è®­ç»ƒå®¹é‡åˆ†æ</li><li>â€¢ æ€æ ·æ‰èƒ½ç˜¦åˆ°60kgï¼Ÿ</li></ul></div>`;
        showToast('å¯¹è¯å·²é‡ç½®', 'info');
      });

      // Mode toggle buttons
      const btnFast = document.getElementById('modeFast');
      const btnDeep = document.getElementById('modeDeep');
      const updateModeUI = () => {
        if (state.aiMode === 'fast') {
          btnFast.className = 'px-3 py-2 rounded-xl text-xs font-medium transition-all bg-white shadow text-indigo-600';
          btnDeep.className = 'px-3 py-2 rounded-xl text-xs font-medium text-gray-500 transition-all hover:text-indigo-600';
        } else {
          btnDeep.className = 'px-3 py-2 rounded-xl text-xs font-medium transition-all bg-white shadow text-indigo-600';
          btnFast.className = 'px-3 py-2 rounded-xl text-xs font-medium text-gray-500 transition-all hover:text-indigo-600';
        }
      };
      btnFast.addEventListener('click', () => { state.aiMode = 'fast'; updateModeUI(); showToast('å·²åˆ‡æ¢åˆ°å¿«é€Ÿæ¨¡å¼', 'info'); });
      btnDeep.addEventListener('click', () => { state.aiMode = 'deep'; updateModeUI(); showToast('å·²åˆ‡æ¢åˆ°æ·±åº¦åˆ†ææ¨¡å¼', 'info'); });
      const tDrop = document.getElementById('trainingDropzone'), tInput = document.getElementById('trainingImageInput');
      tDrop.addEventListener('click', () => tInput.click()); tDrop.addEventListener('dragover', e => { e.preventDefault(); tDrop.classList.add('border-indigo-500', 'bg-indigo-50'); }); tDrop.addEventListener('dragleave', () => tDrop.classList.remove('border-indigo-500', 'bg-indigo-50')); tDrop.addEventListener('drop', e => { e.preventDefault(); tDrop.classList.remove('border-indigo-500', 'bg-indigo-50'); const f = e.dataTransfer.files[0]; if (f?.type.startsWith('image/')) handleTrainingImage(f); }); tInput.addEventListener('change', e => { const f = e.target.files[0]; if (f) handleTrainingImage(f); });
      const mDrop = document.getElementById('mealDropzone'), mInput = document.getElementById('mealImageInput');
      mDrop.addEventListener('click', () => mInput.click()); mDrop.addEventListener('dragover', e => { e.preventDefault(); mDrop.classList.add('border-pink-500', 'bg-pink-50'); }); mDrop.addEventListener('dragleave', () => mDrop.classList.remove('border-pink-500', 'bg-pink-50')); mDrop.addEventListener('drop', e => { e.preventDefault(); mDrop.classList.remove('border-pink-500', 'bg-pink-50'); const f = e.dataTransfer.files[0]; if (f?.type.startsWith('image/')) handleMealImage(f); }); mInput.addEventListener('change', e => { const f = e.target.files[0]; if (f) handleMealImage(f); });
      document.querySelectorAll('.meal-type-btn').forEach(b => b.addEventListener('click', () => selectMealType(b.dataset.type)));
      const bDrop = document.getElementById('bodyDropzone'), bInput = document.getElementById('bodyImageInput');
      bDrop.addEventListener('click', () => bInput.click()); bInput.addEventListener('change', async e => { const f = e.target.files[0]; if (f) { const thumb = await createThumbnail(f); state.currentBodyImage = { thumbnail: thumb }; document.getElementById('bodyImagePreview').classList.remove('hidden'); document.getElementById('bodyPreviewImg').src = thumb; document.getElementById('saveBodyPhoto').disabled = false; } });
      document.getElementById('saveTraining').addEventListener('click', saveTrainingRecord);
      document.getElementById('saveMeal').addEventListener('click', saveMealRecord);
      document.getElementById('saveBodyPhoto').addEventListener('click', saveBodyPhotoRecord);
      document.getElementById('saveApiConfig').addEventListener('click', async () => { const cfg = await getConfig(); cfg.api1 = { url: document.getElementById('apiUrl1').value, key: document.getElementById('apiKey1').value, model: document.getElementById('apiModel1').value }; cfg.api2 = { url: document.getElementById('apiUrl2').value, key: document.getElementById('apiKey2').value, model: document.getElementById('apiModel2').value }; await saveConfig(cfg); showToast('é…ç½®å·²ä¿å­˜', 'success'); });
      document.getElementById('saveTargets').addEventListener('click', async () => {
        const cfg = await getConfig();
        cfg.nutritionTargets = { calories: parseInt(document.getElementById('targetCalories').value) || 2200, protein: parseInt(document.getElementById('targetProtein').value) || 150, carbs: parseInt(document.getElementById('targetCarbs').value) || 250, fat: parseInt(document.getElementById('targetFat').value) || 70 };
        cfg.userProfile = { height: parseFloat(document.getElementById('userHeight').value) || null, weight: parseFloat(document.getElementById('userWeight').value) || null, age: parseInt(document.getElementById('userAge').value) || null, gender: document.getElementById('userGender').value, activityLevel: parseFloat(document.getElementById('activityLevel').value) };
        await saveConfig(cfg);
        updateMacroPieChart(cfg.nutritionTargets.protein * 4, cfg.nutritionTargets.carbs * 4, cfg.nutritionTargets.fat * 9, cfg.nutritionTargets.calories);
        showToast('ç›®æ ‡å·²ä¿å­˜', 'success');
      });
      document.getElementById('calculateTargetsBtn').addEventListener('click', calculateTargets);
      document.getElementById('addNutrient').addEventListener('click', addNutrientHandler); document.getElementById('newNutrient').addEventListener('keypress', e => { if (e.key === 'Enter') addNutrientHandler(); });
      document.getElementById('exportData').addEventListener('click', exportData);
      const impFile = document.getElementById('importFile'); document.getElementById('importFull').addEventListener('click', () => { impFile.dataset.mode = 'full'; impFile.click(); }); document.getElementById('importIncr').addEventListener('click', () => { impFile.dataset.mode = 'incremental'; impFile.click(); }); impFile.addEventListener('change', e => { const f = e.target.files[0]; if (f) { importData(f, impFile.dataset.mode); e.target.value = ''; } });
      document.getElementById('clearData').addEventListener('click', clearAllData);

      // Quick Edit Agent event handlers
      document.getElementById('mealModalAiBtn').addEventListener('click', () => openQuickEditPanel('meal'));
      document.getElementById('trainingModalAiBtn').addEventListener('click', () => openQuickEditPanel('training'));
      document.getElementById('closeEditPanel').addEventListener('click', closeQuickEditPanel);
      document.getElementById('submitEdit').addEventListener('click', runQuickEdit);
      document.getElementById('confirmEdit').addEventListener('click', confirmQuickEdit);
      document.getElementById('retryEdit').addEventListener('click', retryQuickEdit);
      document.getElementById('editInput').addEventListener('keypress', e => { if (e.key === 'Enter') runQuickEdit(); });
      // Reset mascot buttons when modals close
      document.querySelectorAll('.close-modal').forEach(b => b.addEventListener('click', function () {
        const modal = this.closest('.modal-overlay');
        if (modal?.id === 'mealModal') document.getElementById('mealModalAiBtn').classList.add('hidden');
        if (modal?.id === 'trainingModal') document.getElementById('trainingModalAiBtn').classList.add('hidden');
        closeQuickEditPanel();
      }));

      switchPage('home');
      initMacroSlider();
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);
    };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
  </script>
</body>

</html>