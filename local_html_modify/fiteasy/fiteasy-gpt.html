<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0a0a0a" />
    <title>FitFlow · 健身×饮食×AI 复盘</title>

    <!-- Tailwind CDN (no build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- JSZip + FileSaver for ZIP import/export -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        /* 少量增强：更像“应用” */
        html,
        body {
            height: 100%;
            background: #070707;
        }

        .safe-bottom {
            padding-bottom: calc(env(safe-area-inset-bottom) + 76px);
        }

        .safe-top {
            padding-top: env(safe-area-inset-top);
        }

        .glass {
            background: rgba(20, 20, 20, .55);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
        }

        .shadow-soft {
            box-shadow: 0 10px 30px rgba(0, 0, 0, .45);
        }

        .tap {
            -webkit-tap-highlight-color: transparent;
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
            background-size: 200% 100%;
            animation: sk 1.2s infinite;
        }

        @keyframes sk {
            0% {
                background-position: 200% 0
            }

            100% {
                background-position: -200% 0
            }
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .scrollbar-none::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-none {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="text-zinc-100">
    <div id="app" class="min-h-full safe-top">
        <!-- Top Bar -->
        <header class="sticky top-0 z-40 glass border-b border-white/10">
            <div class="px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="h-10 w-10 rounded-2xl bg-gradient-to-br from-emerald-400/20 to-sky-400/20 border border-white/10 flex items-center justify-center">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M7 17l10-10" stroke="rgba(255,255,255,.85)" stroke-width="2"
                                stroke-linecap="round" />
                            <path d="M7 7h6v6" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-sm text-white/60">FitFlow</div>
                        <div id="topTitle" class="font-semibold leading-tight">时间线</div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button id="btnQuickAdd"
                        class="tap px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
                        + 记录
                    </button>
                    <button id="btnSyncHint"
                        class="tap px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
                        状态
                    </button>
                </div>
            </div>
        </header>

        <!-- Main -->
        <main class="safe-bottom">
            <!-- HOME -->
            <section id="viewHome" class="px-4 pt-4 pb-6 space-y-4">
                <!-- Summary cards -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="rounded-2xl border border-white/10 bg-white/5 p-3 shadow-soft">
                        <div class="text-xs text-white/60">近7天均热量</div>
                        <div id="sumKcal" class="mt-1 text-lg font-semibold">—</div>
                        <div class="mt-1 text-xs text-white/40">kcal/day</div>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-white/5 p-3 shadow-soft">
                        <div class="text-xs text-white/60">近7天均蛋白</div>
                        <div id="sumProtein" class="mt-1 text-lg font-semibold">—</div>
                        <div class="mt-1 text-xs text-white/40">g/day</div>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-white/5 p-3 shadow-soft">
                        <div class="text-xs text-white/60">近7天训练</div>
                        <div id="sumWorkouts" class="mt-1 text-lg font-semibold">—</div>
                        <div class="mt-1 text-xs text-white/40">sessions</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="flex items-center justify-between">
                    <div class="text-sm font-semibold">时间线</div>
                    <button id="btnRefresh"
                        class="tap text-sm text-white/70 hover:text-white underline underline-offset-4">刷新</button>
                </div>

                <div id="timeline" class="space-y-3">
                    <!-- filled by JS -->
                </div>

                <div id="homeEmpty" class="hidden rounded-2xl border border-white/10 bg-white/5 p-4 text-white/70">
                    <div class="font-semibold">还没有记录</div>
                    <div class="mt-1 text-sm text-white/60">从右上角「+记录」开始：训练截图 / 三餐照片 / 周复盘照</div>
                </div>
            </section>

            <!-- ADD -->
            <section id="viewAdd" class="hidden px-4 pt-4 pb-10 space-y-4">
                <div class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-soft">
                    <div class="text-sm text-white/70">快速记录</div>
                    <div class="mt-2 grid grid-cols-1 gap-3">
                        <button id="addWorkoutBtn"
                            class="tap w-full rounded-2xl border border-white/10 bg-gradient-to-br from-white/10 to-white/5 p-4 text-left hover:bg-white/10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">+ 训练截图（训记）</div>
                                    <div class="text-sm text-white/60 mt-1">自动解析动作/组数/重量/次数（可编辑）</div>
                                </div>
                                <div
                                    class="h-11 w-11 rounded-2xl bg-white/10 border border-white/10 flex items-center justify-center">
                                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                                        <path d="M7 7h10v10H7z" stroke="rgba(255,255,255,.85)" stroke-width="2"
                                            opacity=".9" />
                                        <path d="M9 15l2-2 2 2 2-3 2 3" stroke="rgba(255,255,255,.85)" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                            </div>
                        </button>

                        <button id="addMealBtn"
                            class="tap w-full rounded-2xl border border-white/10 bg-gradient-to-br from-emerald-500/10 to-white/5 p-4 text-left hover:bg-white/10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">+ 三餐照片</div>
                                    <div class="text-sm text-white/60 mt-1">识别食物项 → 克数滑块 ±5g 微调</div>
                                </div>
                                <div
                                    class="h-11 w-11 rounded-2xl bg-white/10 border border-white/10 flex items-center justify-center">
                                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                                        <path d="M4 12c0-4.4 3.6-8 8-8h8v8c0 4.4-3.6 8-8 8H4v-8z"
                                            stroke="rgba(255,255,255,.85)" stroke-width="2" />
                                        <path d="M8 12h8" stroke="rgba(255,255,255,.85)" stroke-width="2"
                                            stroke-linecap="round" />
                                    </svg>
                                </div>
                            </div>
                        </button>

                        <button id="addCheckinBtn"
                            class="tap w-full rounded-2xl border border-white/10 bg-gradient-to-br from-sky-500/10 to-white/5 p-4 text-left hover:bg-white/10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">+ 周复盘照（体态）</div>
                                    <div class="text-sm text-white/60 mt-1">建议同姿势/同距离拍摄，便于对比</div>
                                </div>
                                <div
                                    class="h-11 w-11 rounded-2xl bg-white/10 border border-white/10 flex items-center justify-center">
                                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 3v6" stroke="rgba(255,255,255,.85)" stroke-width="2"
                                            stroke-linecap="round" />
                                        <path d="M8 7h8" stroke="rgba(255,255,255,.85)" stroke-width="2"
                                            stroke-linecap="round" />
                                        <path d="M5 21V11a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v10"
                                            stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" />
                                    </svg>
                                </div>
                            </div>
                        </button>
                    </div>

                    <div class="mt-4 text-xs text-white/50">
                        图片将先压缩用于识别（≤200KB），再生成超小缩略图入库（目标 ≤10KB）。
                    </div>
                </div>
            </section>

            <!-- REVIEW -->
            <section id="viewReview" class="hidden px-4 pt-4 pb-10 space-y-4">
                <div class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-soft">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-white/70">复盘面板（MVP）</div>
                            <div class="font-semibold mt-0.5">趋势 & 最近训练容量</div>
                        </div>
                        <button id="btnRecompute"
                            class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 text-sm hover:bg-white/15">
                            重新计算
                        </button>
                    </div>

                    <div class="mt-4 grid grid-cols-2 gap-3">
                        <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                            <div class="text-xs text-white/60">近14天总热量</div>
                            <div id="revKcal14" class="text-lg font-semibold mt-1">—</div>
                            <div class="text-xs text-white/40 mt-1">kcal</div>
                        </div>
                        <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                            <div class="text-xs text-white/60">近14天总蛋白</div>
                            <div id="revP14" class="text-lg font-semibold mt-1">—</div>
                            <div class="text-xs text-white/40 mt-1">g</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="text-sm font-semibold">最近4次训练容量（Volume Load）</div>
                        <div id="revLast4" class="mt-2 space-y-2"></div>
                    </div>
                </div>

                <div class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-soft">
                    <div class="text-sm font-semibold">周复盘照</div>
                    <div class="mt-2 text-sm text-white/60">MVP：展示最近 3 条复盘</div>
                    <div id="revCheckins" class="mt-3 space-y-3"></div>
                </div>
            </section>

            <!-- SETTINGS -->
            <section id="viewSettings" class="hidden px-4 pt-4 pb-10 space-y-4">
                <div class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-soft">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-white/70">AI 设置</div>
                            <div class="font-semibold mt-0.5">OpenAI 兼容 · 双 Key 自动重试</div>
                        </div>
                        <button id="btnDefaults"
                            class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 text-sm hover:bg-white/15">恢复默认</button>
                    </div>

                    <div class="mt-4 space-y-3">
                        <label class="block">
                            <div class="text-xs text-white/60 mb-1">Base URL（两套 Provider 先统一）</div>
                            <input id="setBaseUrl"
                                class="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                                placeholder="https://.../v1" />
                        </label>
                        <label class="block">
                            <div class="text-xs text-white/60 mb-1">Model（两套 Provider 先统一）</div>
                            <input id="setModel"
                                class="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                                placeholder="gpt-4.1-mini" />
                        </label>
                        <div class="grid grid-cols-1 gap-3">
                            <label class="block">
                                <div class="text-xs text-white/60 mb-1">API Key #1</div>
                                <input id="setKey1" type="password"
                                    class="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                                    placeholder="sk-..." />
                            </label>
                            <label class="block">
                                <div class="text-xs text-white/60 mb-1">API Key #2（解析失败/网络失败自动重试）</div>
                                <input id="setKey2" type="password"
                                    class="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                                    placeholder="sk-..." />
                            </label>
                        </div>

                        <div class="flex items-center gap-2">
                            <button id="btnSaveSettings"
                                class="tap flex-1 rounded-2xl bg-white/10 border border-white/10 px-4 py-2 text-sm hover:bg-white/15">保存</button>
                            <button id="btnTestAI"
                                class="tap rounded-2xl bg-emerald-500/15 border border-emerald-400/20 px-4 py-2 text-sm hover:bg-emerald-500/20">测试</button>
                        </div>

                        <div id="aiTestResult"
                            class="hidden text-xs text-white/70 mt-2 rounded-2xl border border-white/10 bg-white/5 p-3">
                        </div>

                        <div class="text-xs text-white/50">
                            提示：Key 仅保存在本机浏览器（IndexedDB）。导出 ZIP 不包含 Key。
                        </div>
                    </div>
                </div>

                <div class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-soft">
                    <div class="text-sm text-white/70">营养关注项</div>
                    <div class="font-semibold mt-0.5">默认 + 自定义（动态插入提示词）</div>
                    <div class="mt-3 flex gap-2">
                        <input id="nutrientInput"
                            class="flex-1 rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                            placeholder="例如：鱼油 / 辅酶Q10 / 维生素D..." />
                        <button id="btnAddNutrient"
                            class="tap rounded-2xl bg-white/10 border border-white/10 px-4 py-2 text-sm hover:bg-white/15">添加</button>
                    </div>
                    <div id="nutrientTags" class="mt-3 flex flex-wrap gap-2"></div>
                    <div class="text-xs text-white/50 mt-2">模型会尝试在结构化输出里补充这些字段（没有也不会阻塞保存）。</div>
                </div>

                <div class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-soft">
                    <div class="text-sm text-white/70">数据管理（ZIP）</div>
                    <div class="font-semibold mt-0.5">导入 / 导出 / 清空</div>

                    <div class="mt-3 grid grid-cols-1 gap-3">
                        <button id="btnExportZip"
                            class="tap rounded-2xl bg-white/10 border border-white/10 px-4 py-3 text-left hover:bg-white/15">
                            <div class="font-semibold">导出 ZIP</div>
                            <div class="text-sm text-white/60 mt-1">ZIP 结构：/imgs 下为所有图片（按日期命名），根目录 data.json</div>
                        </button>

                        <div class="rounded-2xl border border-white/10 bg-black/25 p-3">
                            <div class="text-sm font-semibold">导入 ZIP</div>
                            <div class="text-xs text-white/60 mt-1">支持全量导入（覆盖本地）与增量导入（跳过已存在 ID）</div>

                            <div class="mt-3 flex gap-2">
                                <input id="zipFile" type="file" accept=".zip" class="hidden" />
                                <button id="btnPickZip"
                                    class="tap flex-1 rounded-2xl bg-white/10 border border-white/10 px-4 py-2 text-sm hover:bg-white/15">选择
                                    ZIP</button>
                                <button id="btnImportFull"
                                    class="tap rounded-2xl bg-sky-500/15 border border-sky-400/20 px-4 py-2 text-sm hover:bg-sky-500/20">全量导入</button>
                                <button id="btnImportInc"
                                    class="tap rounded-2xl bg-emerald-500/15 border border-emerald-400/20 px-4 py-2 text-sm hover:bg-emerald-500/20">增量导入</button>
                            </div>

                            <div id="importHint"
                                class="hidden mt-3 text-xs text-white/70 rounded-2xl border border-white/10 bg-white/5 p-3">
                            </div>
                        </div>

                        <button id="btnClearData"
                            class="tap rounded-2xl bg-red-500/10 border border-red-400/20 px-4 py-3 text-left hover:bg-red-500/15">
                            <div class="font-semibold text-red-200">清空本地数据</div>
                            <div class="text-sm text-white/60 mt-1">将删除 IndexedDB 数据库（无法撤销）</div>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Nav -->
        <nav class="fixed bottom-0 left-0 right-0 z-40 glass border-t border-white/10">
            <div class="px-4 py-2">
                <div class="grid grid-cols-4 gap-2">
                    <button data-nav="home"
                        class="navBtn tap rounded-2xl px-3 py-2 text-center border border-transparent hover:bg-white/5">
                        <div class="text-xs text-white/70">时间线</div>
                    </button>
                    <button data-nav="add"
                        class="navBtn tap rounded-2xl px-3 py-2 text-center border border-transparent hover:bg-white/5">
                        <div class="text-xs text-white/70">记录</div>
                    </button>
                    <button data-nav="review"
                        class="navBtn tap rounded-2xl px-3 py-2 text-center border border-transparent hover:bg-white/5">
                        <div class="text-xs text-white/70">复盘</div>
                    </button>
                    <button data-nav="settings"
                        class="navBtn tap rounded-2xl px-3 py-2 text-center border border-transparent hover:bg-white/5">
                        <div class="text-xs text-white/70">设置</div>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Floating Agent Button -->
        <button id="agentFab"
            class="tap fixed z-50 right-4 bottom-24 h-14 w-14 rounded-2xl bg-gradient-to-br from-emerald-400/25 to-sky-400/25 border border-white/10 shadow-soft flex items-center justify-center">
            <!-- simple SVG mascot -->
            <svg width="30" height="30" viewBox="0 0 64 64" fill="none">
                <path
                    d="M18 28c0-8 6.5-14.5 14.5-14.5S47 20 47 28v7c0 9-7.3 16.3-16.3 16.3h-1.4C20.3 51.3 13 44 13 35v-7c0-2.8 2.2-5 5-5z"
                    fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.55)" stroke-width="2" />
                <circle cx="26" cy="32" r="3" fill="rgba(255,255,255,.85)" />
                <circle cx="38" cy="32" r="3" fill="rgba(255,255,255,.85)" />
                <path d="M26 41c2.5 2 9.5 2 12 0" stroke="rgba(255,255,255,.7)" stroke-width="2"
                    stroke-linecap="round" />
                <path d="M20 20l-5-6M44 20l5-6" stroke="rgba(255,255,255,.45)" stroke-width="2"
                    stroke-linecap="round" />
            </svg>
        </button>

        <!-- Agent Drawer -->
        <div id="agentDrawer" class="fixed inset-0 z-50 hidden">
            <div id="agentBackdrop" class="absolute inset-0 bg-black/60"></div>
            <div
                class="absolute right-0 top-0 h-full w-full max-w-md glass border-l border-white/10 shadow-soft flex flex-col">
                <div class="p-4 border-b border-white/10 flex items-center justify-between">
                    <div>
                        <div class="text-sm text-white/60">AI Agent</div>
                        <div class="font-semibold">复盘助手 · reAct 工具调用</div>
                    </div>
                    <button id="agentClose"
                        class="tap rounded-xl bg-white/10 border border-white/10 px-3 py-2 text-sm hover:bg-white/15">关闭</button>
                </div>

                <div id="agentMsgs" class="flex-1 overflow-auto p-4 space-y-3 scrollbar-none"></div>

                <div class="p-4 border-t border-white/10">
                    <div class="flex gap-2">
                        <input id="agentInput"
                            class="flex-1 rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                            placeholder="例如：最近7天饮食复盘 / 最近4次训练容量 / 怎么瘦到60kg" />
                        <button id="agentSend"
                            class="tap rounded-2xl bg-emerald-500/15 border border-emerald-400/20 px-4 py-2 text-sm hover:bg-emerald-500/20">发送</button>
                    </div>
                    <div class="mt-2 flex flex-wrap gap-2">
                        <button
                            class="chip tap text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/10 hover:bg-white/15"
                            data-q="最近7天饮食状态复盘，给出热量/蛋白/波动原因，并给出下一周行动建议。">饮食复盘</button>
                        <button
                            class="chip tap text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/10 hover:bg-white/15"
                            data-q="统计最近4次训练的容量（Volume Load）变化，并提示我是否在进步。">训练容量</button>
                        <button
                            class="chip tap text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/10 hover:bg-white/15"
                            data-q="我想减脂到60kg。基于最近14天我的饮食与训练数据，给出热量目标、蛋白目标、训练建议和注意事项。">减到60kg</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden file inputs -->
        <input id="fileWorkout" type="file" accept="image/*" class="hidden" />
        <input id="fileMeal" type="file" accept="image/*" class="hidden" />
        <input id="fileCheckin" type="file" accept="image/*" multiple class="hidden" />

        <!-- Modal: Parse & Confirm -->
        <div id="modal" class="fixed inset-0 z-[60] hidden">
            <div id="modalBackdrop" class="absolute inset-0 bg-black/60"></div>
            <div
                class="absolute inset-x-0 bottom-0 mx-auto w-full max-w-md glass border-t border-white/10 rounded-t-3xl shadow-soft">
                <div class="p-4 border-b border-white/10 flex items-center justify-between">
                    <div>
                        <div id="modalSub" class="text-xs text-white/60">解析中</div>
                        <div id="modalTitle" class="font-semibold">—</div>
                    </div>
                    <button id="modalClose"
                        class="tap rounded-xl bg-white/10 border border-white/10 px-3 py-2 text-sm hover:bg-white/15">关闭</button>
                </div>

                <div id="modalBody" class="p-4 max-h-[70vh] overflow-auto scrollbar-none">
                    <!-- dynamic -->
                </div>

                <div class="p-4 border-t border-white/10 flex gap-2">
                    <button id="modalSave"
                        class="tap flex-1 rounded-2xl bg-emerald-500/15 border border-emerald-400/20 px-4 py-2 text-sm hover:bg-emerald-500/20">保存</button>
                    <button id="modalCancel"
                        class="tap rounded-2xl bg-white/10 border border-white/10 px-4 py-2 text-sm hover:bg-white/15">取消</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed z-[80] left-1/2 -translate-x-1/2 bottom-28 hidden">
            <div class="px-4 py-2 rounded-2xl glass border border-white/10 shadow-soft text-sm text-white/85"></div>
        </div>

    </div>

    <script>
        /* =========================
           FitFlow · Single HTML App
           - IndexedDB storage (entries + settings)
           - Image compression (<=200KB for AI, <=10KB thumb)
           - Meal/workout parsing via OpenAI-compatible API
           - ZIP export/import: /imgs + data.json
           - AI Agent: function-calling loop (reAct-like)
        ========================= */

        (() => {
            /** ---------- Utilities ---------- */
            const $ = (sel) => document.querySelector(sel);
            const $$ = (sel) => Array.from(document.querySelectorAll(sel));
            const sleep = (ms) => new Promise(r => setTimeout(r, ms));

            function toast(msg, ms = 2200) {
                const el = $("#toast");
                el.firstElementChild.textContent = msg;
                el.classList.remove("hidden");
                clearTimeout(toast._t);
                toast._t = setTimeout(() => el.classList.add("hidden"), ms);
            }

            function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
            function pad2(n) { return String(n).padStart(2, '0'); }

            function tsToDay(ts) {
                const d = new Date(ts);
                return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
            }
            function tsToHuman(ts) {
                const d = new Date(ts);
                return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
            }
            function dayToPretty(day) {
                const d = new Date(day + "T00:00:00");
                const w = ["日", "一", "二", "三", "四", "五", "六"][d.getDay()];
                return `${day} · 周${w}`;
            }
            function mealTypeFromTs(ts) {
                const h = new Date(ts).getHours();
                if (h < 10) return "早餐";
                if (h < 15) return "午餐";
                if (h < 20) return "晚餐";
                return "加餐";
            }

            function uid(prefix = "e") {
                return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
            }

            function blobToDataURL(blob) {
                return new Promise((resolve, reject) => {
                    const fr = new FileReader();
                    fr.onload = () => resolve(fr.result);
                    fr.onerror = reject;
                    fr.readAsDataURL(blob);
                });
            }

            function dataURLToBlob(dataURL) {
                const [head, body] = dataURL.split(",");
                const mime = head.match(/data:(.*?);base64/)[1];
                const bin = atob(body);
                const arr = new Uint8Array(bin.length);
                for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                return new Blob([arr], { type: mime });
            }

            function safeJsonParse(s) {
                try { return JSON.parse(s); } catch { return null; }
            }

            function extractFirstJson(text) {
                // Try find first {...} or [...] block (best-effort)
                const t = text.trim();
                if (!t) return null;
                // quick direct parse
                const direct = safeJsonParse(t);
                if (direct) return direct;

                // find first "{" and last "}" 
                const i = t.indexOf("{");
                const j = t.lastIndexOf("}");
                if (i !== -1 && j !== -1 && j > i) {
                    const sub = t.slice(i, j + 1);
                    const obj = safeJsonParse(sub);
                    if (obj) return obj;
                }
                // try array
                const a = t.indexOf("[");
                const b = t.lastIndexOf("]");
                if (a !== -1 && b !== -1 && b > a) {
                    const sub = t.slice(a, b + 1);
                    const obj = safeJsonParse(sub);
                    if (obj) return obj;
                }
                return null;
            }

            /** ---------- Image compression (no external lib) ---------- */
            async function fileToImage(file) {
                const url = URL.createObjectURL(file);
                try {
                    const img = new Image();
                    img.decoding = "async";
                    img.src = url;
                    await img.decode();
                    return img;
                } finally {
                    // do not revoke immediately before decode done; already awaited
                }
            }

            function canvasToBlob(canvas, mime, quality) {
                return new Promise(resolve => canvas.toBlob(resolve, mime, quality));
            }

            async function compressToTarget(file, {
                maxBytes = 200 * 1024,
                maxDim = 1280,
                mime = "image/webp",
                startQuality = 0.9,
                minQuality = 0.45
            } = {}) {
                const img = await fileToImage(file);

                let w = img.naturalWidth;
                let h = img.naturalHeight;

                const scale = Math.min(1, maxDim / Math.max(w, h));
                w = Math.round(w * scale);
                h = Math.round(h * scale);

                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d", { alpha: false });
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);

                let q = startQuality;
                let blob = await canvasToBlob(canvas, mime, q);

                // If still too large, reduce quality; if hits minQuality, shrink dimension gradually.
                while (blob && blob.size > maxBytes) {
                    if (q > minQuality) {
                        q = Math.max(minQuality, q - 0.08);
                    } else {
                        // shrink
                        w = Math.round(w * 0.90);
                        h = Math.round(h * 0.90);
                        if (w < 320 || h < 320) break;
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        q = startQuality;
                    }
                    blob = await canvasToBlob(canvas, mime, q);
                    if (!blob) break;
                }
                return blob;
            }

            async function makeThumbFromBlob(blob, {
                maxBytes = 10 * 1024,
                maxDim = 180,
                mime = "image/webp"
            } = {}) {
                const file = new File([blob], "x", { type: blob.type || "image/*" });
                return compressToTarget(file, { maxBytes, maxDim, mime, startQuality: 0.82, minQuality: 0.35 });
            }

            /** ---------- IndexedDB ---------- */
            const DB_NAME = "fitflow_db_v1";
            const DB_VERSION = 1;
            let db = null;

            function openDB() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        const db = req.result;
                        if (!db.objectStoreNames.contains("entries")) {
                            const st = db.createObjectStore("entries", { keyPath: "id" });
                            st.createIndex("by_ts", "ts", { unique: false });
                            st.createIndex("by_day", "day", { unique: false });
                            st.createIndex("by_type", "type", { unique: false });
                        }
                        if (!db.objectStoreNames.contains("settings")) {
                            db.createObjectStore("settings", { keyPath: "key" });
                        }
                    };
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }

            function tx(storeName, mode = "readonly") {
                const t = db.transaction(storeName, mode);
                return t.objectStore(storeName);
            }

            function idbGet(store, key) {
                return new Promise((resolve, reject) => {
                    const req = tx(store, "readonly").get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }

            function idbPut(store, value) {
                return new Promise((resolve, reject) => {
                    const req = tx(store, "readwrite").put(value);
                    req.onsuccess = () => resolve(true);
                    req.onerror = () => reject(req.error);
                });
            }

            function idbDelete(store, key) {
                return new Promise((resolve, reject) => {
                    const req = tx(store, "readwrite").delete(key);
                    req.onsuccess = () => resolve(true);
                    req.onerror = () => reject(req.error);
                });
            }

            function idbGetAll(store) {
                return new Promise((resolve, reject) => {
                    const req = tx(store, "readonly").getAll();
                    req.onsuccess = () => resolve(req.result || []);
                    req.onerror = () => reject(req.error);
                });
            }

            function idbClear(store) {
                return new Promise((resolve, reject) => {
                    const req = tx(store, "readwrite").clear();
                    req.onsuccess = () => resolve(true);
                    req.onerror = () => reject(req.error);
                });
            }

            async function deleteDatabase() {
                if (db) db.close();
                db = null;
                return new Promise((resolve, reject) => {
                    const req = indexedDB.deleteDatabase(DB_NAME);
                    req.onsuccess = () => resolve(true);
                    req.onerror = () => reject(req.error);
                    req.onblocked = () => reject(new Error("删除数据库被阻塞：请关闭其它同源标签页后重试。"));
                });
            }

            /** ---------- App State ---------- */
            const state = {
                view: "home",
                entries: [],
                settings: {
                    baseUrl: "https://b.apiyi.com/v1",
                    model: "gpt-4.1-mini",
                    key1: "",
                    key2: "",
                    nutrients: ["蛋白质", "维生素D", "维生素C", "鱼油", "辅酶Q10"]
                },
                modal: {
                    type: null, // 'meal'|'workout'|'checkin'
                    ts: null,
                    file: null,
                    files: null,
                    imgFull: null, // Blob <=200KB
                    imgThumb: null, // Blob <=10KB
                    previewURL: null,
                    parsed: null,
                    parsing: false,
                    error: null
                },
                agent: {
                    open: false,
                    msgs: []
                }
            };

            const DEFAULTS = {
                baseUrl: "https://b.apiyi.com/v1",
                model: "gpt-4.1-mini"
            };

            /** ---------- Views ---------- */
            function setView(v) {
                state.view = v;
                $("#viewHome").classList.toggle("hidden", v !== "home");
                $("#viewAdd").classList.toggle("hidden", v !== "add");
                $("#viewReview").classList.toggle("hidden", v !== "review");
                $("#viewSettings").classList.toggle("hidden", v !== "settings");

                const titleMap = { home: "时间线", add: "记录", review: "复盘", settings: "设置" };
                $("#topTitle").textContent = titleMap[v] || "FitFlow";

                $$(".navBtn").forEach(btn => {
                    const active = btn.dataset.nav === v;
                    btn.classList.toggle("bg-white/10", active);
                    btn.classList.toggle("border-white/10", active);
                    btn.classList.toggle("border-transparent", !active);
                });
            }

            /** ---------- Rendering ---------- */
            function objUrlFromBlob(blob) {
                if (!blob) return null;
                return URL.createObjectURL(blob);
            }

            function cleanupModalURLs() {
                if (state.modal.previewURL) {
                    URL.revokeObjectURL(state.modal.previewURL);
                    state.modal.previewURL = null;
                }
            }

            function groupByDay(entries) {
                const map = new Map();
                for (const e of entries) {
                    if (!map.has(e.day)) map.set(e.day, []);
                    map.get(e.day).push(e);
                }
                // newest day first
                return Array.from(map.entries()).sort((a, b) => b[0].localeCompare(a[0]));
            }

            function sumMacrosFromMeals(meals) {
                let kcal = 0, p = 0, c = 0, f = 0;
                for (const m of meals) {
                    const t = m.data?.totals;
                    if (t) {
                        kcal += Number(t.kcal || 0);
                        p += Number(t.p || 0);
                        c += Number(t.c || 0);
                        f += Number(t.f || 0);
                    }
                }
                return { kcal, p, c, f };
            }

            function renderTimeline() {
                const timeline = $("#timeline");
                timeline.innerHTML = "";

                if (!state.entries.length) {
                    $("#homeEmpty").classList.remove("hidden");
                    return;
                }
                $("#homeEmpty").classList.add("hidden");

                const grouped = groupByDay(state.entries);

                for (const [day, items] of grouped) {
                    const workouts = items.filter(x => x.type === "workout").sort((a, b) => b.ts - a.ts);
                    const meals = items.filter(x => x.type === "meal").sort((a, b) => b.ts - a.ts);
                    const checkins = items.filter(x => x.type === "checkin").sort((a, b) => b.ts - a.ts);

                    const wk = workouts[0] || null;
                    const mealMacros = sumMacrosFromMeals(meals);

                    const card = document.createElement("div");
                    card.className = "rounded-3xl border border-white/10 bg-white/5 p-4 shadow-soft";

                    const leftThumb = wk?.imgThumb ? objUrlFromBlob(wk.imgThumb) : null;

                    const mealThumbs = meals
                        .slice(0, 6)
                        .map(m => {
                            const u = m.imgThumb ? objUrlFromBlob(m.imgThumb) : null;
                            return u ? `<button class="tap shrink-0 h-14 w-14 rounded-2xl border border-white/10 overflow-hidden bg-black/30" data-open="${m.id}">
              <img src="${u}" class="h-full w-full object-cover"/>
            </button>` : `<div class="h-14 w-14 rounded-2xl border border-white/10 bg-black/30"></div>`;
                        }).join("");

                    const moreMeals = meals.length > 6 ? `<div class="shrink-0 h-14 px-3 rounded-2xl border border-white/10 bg-white/5 flex items-center text-xs text-white/70">+${meals.length - 6}</div>` : "";

                    const checkinBadge = checkins.length ? `<span class="ml-2 text-xs px-2 py-1 rounded-full bg-sky-500/15 border border-sky-400/20 text-sky-100">周复盘</span>` : "";

                    card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">${dayToPretty(day)} ${checkinBadge}</div>
            <div class="mt-1 text-xs text-white/60">
              饮食：${Math.round(mealMacros.kcal)} kcal · P ${Math.round(mealMacros.p)}g · C ${Math.round(mealMacros.c)}g · F ${Math.round(mealMacros.f)}g
            </div>
          </div>
          <button class="tap text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" data-open-day="${day}">查看</button>
        </div>

        <div class="mt-4 grid grid-cols-[92px_1fr] gap-3">
          <div>
            <div class="text-xs text-white/60 mb-2">训练</div>
            ${wk && leftThumb
                            ? `<button class="tap h-20 w-20 rounded-3xl border border-white/10 overflow-hidden bg-black/30" data-open="${wk.id}">
                     <img src="${leftThumb}" class="h-full w-full object-cover"/>
                   </button>
                   <div class="mt-2 text-[11px] text-white/55">
                     ${wk.data?.muscle_group ? `部位：${wk.data.muscle_group}` : "训练截图"}
                   </div>`
                            : `<div class="h-20 w-20 rounded-3xl border border-white/10 bg-black/30 flex items-center justify-center text-xs text-white/40">无</div>`
                        }
          </div>
          <div>
            <div class="text-xs text-white/60 mb-2">三餐</div>
            <div class="flex gap-2 overflow-x-auto scrollbar-none pb-1">
              ${mealThumbs || `<div class="text-xs text-white/40">无</div>`}
              ${moreMeals}
            </div>
            <div class="mt-2 text-[11px] text-white/55">
              ${meals.length ? `最新：${mealTypeFromTs(meals[0].ts)} · ${tsToHuman(meals[0].ts).slice(-5)}` : ""}
            </div>
          </div>
        </div>
      `;

                    // open handlers
                    card.querySelectorAll("[data-open]").forEach(btn => {
                        btn.addEventListener("click", () => openEntryDetail(btn.dataset.open));
                    });
                    card.querySelector("[data-open-day]")?.addEventListener("click", (e) => {
                        openDayDetail(e.currentTarget.dataset.openDay);
                    });

                    timeline.appendChild(card);
                }
            }

            function renderNutrientTags() {
                const wrap = $("#nutrientTags");
                wrap.innerHTML = "";
                for (const n of state.settings.nutrients) {
                    const tag = document.createElement("button");
                    tag.className = "tap text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/10 hover:bg-white/15";
                    tag.innerHTML = `${escapeHtml(n)} <span class="ml-1 text-white/50">×</span>`;
                    tag.addEventListener("click", async () => {
                        state.settings.nutrients = state.settings.nutrients.filter(x => x !== n);
                        await saveSettings();
                        renderNutrientTags();
                        toast("已删除");
                    });
                    wrap.appendChild(tag);
                }
            }

            function escapeHtml(s) {
                return String(s).replace(/[&<>"']/g, (m) => ({
                    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
                }[m]));
            }

            function renderReview() {
                // 14 days totals + last4 workouts
                const now = Date.now();
                const from14 = now - 14 * 24 * 3600 * 1000;
                const meals14 = state.entries.filter(e => e.type === "meal" && e.ts >= from14);
                const { kcal, p } = sumMacrosFromMeals(meals14);
                $("#revKcal14").textContent = Math.round(kcal) || "0";
                $("#revP14").textContent = Math.round(p) || "0";

                const wks = state.entries.filter(e => e.type === "workout").sort((a, b) => b.ts - a.ts).slice(0, 4);
                const list = $("#revLast4");
                list.innerHTML = "";
                if (!wks.length) {
                    list.innerHTML = `<div class="text-sm text-white/50">暂无训练记录</div>`;
                } else {
                    for (const w of wks) {
                        const vol = Math.round(Number(w.data?.totals?.volume_load || 0));
                        const mg = w.data?.muscle_group || "训练";
                        const row = document.createElement("div");
                        row.className = "rounded-2xl border border-white/10 bg-white/5 p-3 flex items-center justify-between";
                        row.innerHTML = `
          <div>
            <div class="text-sm font-semibold">${escapeHtml(mg)}</div>
            <div class="text-xs text-white/60 mt-1">${tsToHuman(w.ts)}</div>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold">${vol || "—"}</div>
            <div class="text-xs text-white/50">volume</div>
          </div>
        `;
                        row.addEventListener("click", () => openEntryDetail(w.id));
                        list.appendChild(row);
                    }
                }

                const checkins = state.entries.filter(e => e.type === "checkin").sort((a, b) => b.ts - a.ts).slice(0, 3);
                const ckWrap = $("#revCheckins");
                ckWrap.innerHTML = "";
                if (!checkins.length) {
                    ckWrap.innerHTML = `<div class="text-sm text-white/50">暂无周复盘照</div>`;
                } else {
                    for (const c of checkins) {
                        const thumbs = (c.data?.photosThumb || []).slice(0, 3).map(u => `
          <div class="h-16 w-16 rounded-2xl border border-white/10 overflow-hidden bg-black/30">
            <img src="${u}" class="h-full w-full object-cover"/>
          </div>
        `).join("");
                        const row = document.createElement("div");
                        row.className = "rounded-3xl border border-white/10 bg-white/5 p-4";
                        row.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">${escapeHtml(c.data?.weekLabel || tsToDay(c.ts))}</div>
              <div class="text-xs text-white/60 mt-1">${tsToHuman(c.ts)}</div>
            </div>
            <button class="tap text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15">查看</button>
          </div>
          <div class="mt-3 flex gap-2">${thumbs}</div>
        `;
                        row.querySelector("button")?.addEventListener("click", () => openEntryDetail(c.id));
                        ckWrap.appendChild(row);
                    }
                }
            }

            function renderSummaryCards() {
                const now = Date.now();
                const from7 = now - 7 * 24 * 3600 * 1000;

                const meals7 = state.entries.filter(e => e.type === "meal" && e.ts >= from7);
                const wks7 = state.entries.filter(e => e.type === "workout" && e.ts >= from7);

                const { kcal, p } = sumMacrosFromMeals(meals7);
                const days = Math.max(1, new Set(meals7.map(x => x.day)).size || 1);
                $("#sumKcal").textContent = Math.round(kcal / days) || "0";
                $("#sumProtein").textContent = Math.round(p / days) || "0";
                $("#sumWorkouts").textContent = String(wks7.length);
            }

            /** ---------- Entry Detail (simple) ---------- */
            async function openEntryDetail(id) {
                const entry = state.entries.find(e => e.id === id);
                if (!entry) return;

                openModal();
                $("#modalSub").textContent = tsToHuman(entry.ts);
                $("#modalTitle").textContent =
                    entry.type === "meal" ? `${entry.data?.meal_type || "用餐"} · 详情` :
                        entry.type === "workout" ? `训练 · 详情` :
                            `周复盘 · 详情`;

                const body = $("#modalBody");
                const imgURL = entry.imgFull ? objUrlFromBlob(entry.imgFull) : (entry.imgThumb ? objUrlFromBlob(entry.imgThumb) : null);

                let html = "";
                if (imgURL) {
                    html += `
        <div class="rounded-3xl border border-white/10 overflow-hidden bg-black/30">
          <img src="${imgURL}" class="w-full max-h-[40vh] object-cover"/>
        </div>
      `;
                }

                if (entry.type === "meal") {
                    const items = entry.data?.items || [];
                    const totals = entry.data?.totals || {};
                    html += `
        <div class="mt-4 rounded-3xl border border-white/10 bg-white/5 p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">${escapeHtml(entry.data?.meal_type || "用餐")}</div>
            <div class="text-xs text-white/60">${escapeHtml(entry.day)}</div>
          </div>
          <div class="mt-2 text-xs text-white/60">
            总计：${Math.round(totals.kcal || 0)} kcal · P ${Math.round(totals.p || 0)}g · C ${Math.round(totals.c || 0)}g · F ${Math.round(totals.f || 0)}g
          </div>
        </div>
        <div class="mt-3 space-y-2">
          ${items.map((it, i) => `
            <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">${escapeHtml(it.name || ("食物" + (i + 1)))}</div>
                <div class="text-xs text-white/60">${Math.round(it.grams || 0)} g</div>
              </div>
              <div class="mt-1 text-xs text-white/60">
                ${Math.round(it.kcal || 0)} kcal · P ${Math.round(it.p || 0)}g · C ${Math.round(it.c || 0)}g · F ${Math.round(it.f || 0)}g
              </div>
            </div>
          `).join("")}
        </div>
      `;
                } else if (entry.type === "workout") {
                    const ex = entry.data?.exercises || [];
                    const totals = entry.data?.totals || {};
                    html += `
        <div class="mt-4 rounded-3xl border border-white/10 bg-white/5 p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">${escapeHtml(entry.data?.muscle_group || "训练")}</div>
            <div class="text-xs text-white/60">${escapeHtml(entry.day)}</div>
          </div>
          <div class="mt-2 text-xs text-white/60">
            Volume：${Math.round(totals.volume_load || 0)} · 有效组：${Math.round(totals.hard_sets || 0)} · 总组：${Math.round(totals.set_count || 0)}
          </div>
        </div>
        <div class="mt-3 space-y-2">
          ${ex.map((it, i) => `
            <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
              <div class="text-sm font-semibold">${escapeHtml(it.name || ("动作" + (i + 1)))}</div>
              <div class="mt-1 text-xs text-white/60">
                组数 ${it.sets ?? "—"} · 次数 ${it.reps ?? "—"} · 重量 ${it.weight ?? "—"}
              </div>
            </div>
          `).join("")}
        </div>
      `;
                } else {
                    const photos = entry.data?.photosThumb || [];
                    html += `
        <div class="mt-4 rounded-3xl border border-white/10 bg-white/5 p-4">
          <div class="text-sm font-semibold">${escapeHtml(entry.data?.weekLabel || "周复盘")}</div>
          <div class="text-xs text-white/60 mt-1">${escapeHtml(entry.data?.note || "建议保持同光线/同距离/同姿势")}</div>
          <div class="mt-3 flex gap-2 flex-wrap">
            ${photos.map(u => `
              <div class="h-24 w-24 rounded-2xl border border-white/10 overflow-hidden bg-black/30">
                <img src="${u}" class="h-full w-full object-cover"/>
              </div>
            `).join("")}
          </div>
        </div>
      `;
                }

                html += `
      <div class="mt-4 flex gap-2">
        <button id="btnDelEntry" class="tap w-full rounded-2xl bg-red-500/10 border border-red-400/20 px-4 py-2 text-sm hover:bg-red-500/15">删除这条记录</button>
      </div>
      <div class="mt-2 text-[11px] text-white/45 mono">
        id: ${escapeHtml(entry.id)}
      </div>
    `;

                body.innerHTML = html;

                $("#modalSave").classList.add("hidden");
                $("#btnDelEntry").addEventListener("click", async () => {
                    await idbDelete("entries", entry.id);
                    await loadEntries();
                    toast("已删除");
                    closeModal();
                });
            }

            async function openDayDetail(day) {
                const items = state.entries.filter(e => e.day === day).sort((a, b) => b.ts - a.ts);
                openModal();
                $("#modalSub").textContent = dayToPretty(day);
                $("#modalTitle").textContent = "当天记录";

                const body = $("#modalBody");
                if (!items.length) {
                    body.innerHTML = `<div class="text-sm text-white/60">当天没有记录</div>`;
                } else {
                    body.innerHTML = items.map(e => {
                        const kind = e.type === "meal" ? (e.data?.meal_type || "用餐") : (e.type === "workout" ? "训练" : "周复盘");
                        const subtitle = e.type === "meal"
                            ? `${Math.round(e.data?.totals?.kcal || 0)}kcal · P${Math.round(e.data?.totals?.p || 0)}g`
                            : e.type === "workout"
                                ? `Volume ${Math.round(e.data?.totals?.volume_load || 0)}`
                                : `照片 ${e.data?.photosThumb?.length || 0} 张`;

                        const thumb = e.imgThumb ? objUrlFromBlob(e.imgThumb) : null;
                        return `
          <button class="tap w-full rounded-2xl border border-white/10 bg-white/5 p-3 flex items-center gap-3 hover:bg-white/10" data-open="${e.id}">
            <div class="h-14 w-14 rounded-2xl border border-white/10 overflow-hidden bg-black/30 shrink-0">
              ${thumb ? `<img src="${thumb}" class="h-full w-full object-cover"/>` : ``}
            </div>
            <div class="flex-1 text-left">
              <div class="text-sm font-semibold">${escapeHtml(kind)}</div>
              <div class="text-xs text-white/60 mt-1">${escapeHtml(tsToHuman(e.ts))} · ${escapeHtml(subtitle)}</div>
            </div>
            <div class="text-xs text-white/50">›</div>
          </button>
        `;
                    }).join("");

                    body.querySelectorAll("[data-open]").forEach(btn => {
                        btn.addEventListener("click", () => openEntryDetail(btn.dataset.open));
                    });
                }

                $("#modalSave").classList.add("hidden");
            }

            /** ---------- Modal helpers ---------- */
            function openModal() {
                $("#modal").classList.remove("hidden");
                $("#modalSave").classList.remove("hidden");
                $("#modalClose").onclick = closeModal;
                $("#modalCancel").onclick = closeModal;
                $("#modalBackdrop").onclick = closeModal;
            }

            function closeModal() {
                cleanupModalURLs();
                $("#modal").classList.add("hidden");
                $("#modalSave").classList.remove("hidden");
                // reset modal state
                state.modal = { type: null, ts: null, file: null, files: null, imgFull: null, imgThumb: null, previewURL: null, parsed: null, parsing: false, error: null };
                $("#modalBody").innerHTML = "";
                $("#modalTitle").textContent = "—";
                $("#modalSub").textContent = "—";
                $("#modalSave").onclick = null;
            }

            /** ---------- Settings ---------- */
            async function loadSettings() {
                const s = await idbGet("settings", "app_settings");
                if (s && s.value) {
                    state.settings = { ...state.settings, ...s.value };
                } else {
                    // first run: save defaults
                    await saveSettings();
                }
                // bind to UI
                $("#setBaseUrl").value = state.settings.baseUrl || DEFAULTS.baseUrl;
                $("#setModel").value = state.settings.model || DEFAULTS.model;
                $("#setKey1").value = state.settings.key1 || "";
                $("#setKey2").value = state.settings.key2 || "";
                renderNutrientTags();
            }

            async function saveSettings() {
                await idbPut("settings", { key: "app_settings", value: state.settings });
            }

            /** ---------- Load entries ---------- */
            async function loadEntries() {
                const all = await idbGetAll("entries");
                // sort desc by ts
                all.sort((a, b) => b.ts - a.ts);
                state.entries = all;

                renderSummaryCards();
                renderTimeline();
                renderReview();
            }

            /** ---------- OpenAI-compatible API ---------- */
            function normalizeBaseUrl(u) {
                let s = (u || "").trim();
                if (!s) return "";
                // remove trailing slash
                s = s.replace(/\/+$/, "");
                return s;
            }

            function getProviders() {
                const baseUrl = normalizeBaseUrl(state.settings.baseUrl || DEFAULTS.baseUrl);
                const model = (state.settings.model || DEFAULTS.model).trim();
                return [
                    { name: "p1", baseUrl, model, apiKey: (state.settings.key1 || "").trim() },
                    { name: "p2", baseUrl, model, apiKey: (state.settings.key2 || "").trim() }
                ];
            }

            async function openaiChat(provider, payload) {
                const url = provider.baseUrl + "/chat/completions";
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": provider.apiKey ? `Bearer ${provider.apiKey}` : ""
                    },
                    body: JSON.stringify({
                        model: provider.model,
                        ...payload
                    })
                });
                if (!res.ok) {
                    const t = await res.text().catch(() => "");
                    throw new Error(`HTTP ${res.status} ${res.statusText} :: ${t.slice(0, 200)}`);
                }
                return res.json();
            }

            async function callVisionStructured({ imageBlob, kind, ts, nutrients }) {
                const providers = getProviders();
                if (!providers[0].apiKey && !providers[1].apiKey) {
                    throw new Error("未配置 API Key（请到 设置 → AI 设置）");
                }

                const imgDataUrl = await blobToDataURL(imageBlob);
                const extraNutrients = (nutrients || []).filter(Boolean).slice(0, 12);

                // Ask for JSON only. Keep schema stable.
                const schemaMeal = {
                    meal_type: "早餐|午餐|晚餐|加餐",
                    items: [
                        {
                            name: "string",
                            grams: "number",
                            kcal: "number",
                            p: "number",
                            c: "number",
                            f: "number",
                            micros: "object (optional, include keys from custom nutrients if possible)",
                            confidence: "0..1"
                        }
                    ],
                    totals: { kcal: "number", p: "number", c: "number", f: "number", micros: "object(optional)" },
                    notes: "string(optional)"
                };

                const schemaWorkout = {
                    muscle_group: "胸|肩|背|腿|臂|全身|其它",
                    duration_min: "number(optional)",
                    exercises: [
                        { name: "string", sets: "number", reps: "string|number(optional)", weight: "string|number(optional)" }
                    ],
                    totals: { volume_load: "number(optional)", hard_sets: "number(optional)", set_count: "number(optional)" },
                    notes: "string(optional)",
                    confidence: "0..1"
                };

                const system = `
你是一个健身与饮食记录解析器。你必须输出严格 JSON，不要任何多余文本。
如果不确定，给出合理估计，并在 notes 说明不确定点。
数值尽量保留 1 位小数或整数。
自定义营养关注项（若能判断则填到 micros 与 totals.micros 中）：${extraNutrients.join("、") || "无"}。
`;

                const user = kind === "meal"
                    ? `解析这张用餐照片为 JSON（结构参考 schema）。时间：${new Date(ts).toISOString()}。meal_type 也请根据时间合理推断。schema：${JSON.stringify(schemaMeal)}`
                    : `解析这张训练截图（类似训记）为 JSON（结构参考 schema）。时间：${new Date(ts).toISOString()}。schema：${JSON.stringify(schemaWorkout)}`;

                const payload = {
                    temperature: 0.2,
                    messages: [
                        { role: "system", content: system.trim() },
                        {
                            role: "user", content: [
                                { type: "text", text: user },
                                { type: "image_url", image_url: { url: imgDataUrl } }
                            ]
                        }
                    ]
                };

                // Try provider #1 then #2
                let lastErr = null;
                for (const p of providers) {
                    if (!p.apiKey) continue;
                    try {
                        const json = await openaiChat(p, payload);
                        const text = json?.choices?.[0]?.message?.content || "";
                        const parsed = extractFirstJson(text);
                        if (!parsed) throw new Error("模型返回无法解析为 JSON");
                        // minimal sanity check
                        if (kind === "meal" && !Array.isArray(parsed.items)) throw new Error("JSON 缺少 items 数组");
                        if (kind === "workout" && !Array.isArray(parsed.exercises)) throw new Error("JSON 缺少 exercises 数组");
                        return { provider: p.name, parsed };
                    } catch (err) {
                        lastErr = err;
                    }
                }
                throw lastErr || new Error("解析失败");
            }

            /** ---------- Compute helpers for meal adjustment ---------- */
            function normalizeMealParsed(p) {
                // Ensure numeric and provide per-gram linear ratio for recalculation
                const items = (p.items || []).map(it => {
                    const grams = Number(it.grams || 0) || 0;
                    const kcal = Number(it.kcal || 0) || 0;
                    const P = Number(it.p || 0) || 0;
                    const C = Number(it.c || 0) || 0;
                    const F = Number(it.f || 0) || 0;
                    const per = grams > 0 ? {
                        kcal: kcal / grams,
                        p: P / grams,
                        c: C / grams,
                        f: F / grams
                    } : { kcal: 0, p: 0, c: 0, f: 0 };

                    return {
                        name: String(it.name || "").trim() || "未知食物",
                        grams,
                        kcal, p: P, c: C, f: F,
                        per_gram: per,
                        micros: it.micros || {},
                        confidence: clamp(Number(it.confidence || 0.6), 0, 1)
                    };
                });

                const totals = calcMealTotals(items);
                return {
                    meal_type: p.meal_type || "用餐",
                    items,
                    totals,
                    notes: p.notes || ""
                };
            }

            function calcMealTotals(items) {
                let kcal = 0, p = 0, c = 0, f = 0;
                for (const it of items) {
                    kcal += Number(it.kcal || 0);
                    p += Number(it.p || 0);
                    c += Number(it.c || 0);
                    f += Number(it.f || 0);
                }
                return { kcal, p, c, f };
            }

            function recalcMealItem(it, newGrams) {
                const g = Math.max(0, Number(newGrams || 0));
                it.grams = g;
                it.kcal = g * (it.per_gram?.kcal || 0);
                it.p = g * (it.per_gram?.p || 0);
                it.c = g * (it.per_gram?.c || 0);
                it.f = g * (it.per_gram?.f || 0);
            }

            /** ---------- Compute helpers for workout ---------- */
            function normalizeWorkoutParsed(p) {
                const ex = (p.exercises || []).map(it => ({
                    name: String(it.name || "").trim() || "未知动作",
                    sets: Number(it.sets || 0) || 0,
                    reps: (it.reps ?? "").toString(),
                    weight: (it.weight ?? "").toString()
                }));

                // Best-effort volume load: parse "weight x reps" if possible
                let setCount = 0;
                for (const e of ex) setCount += (Number(e.sets) || 0);

                const totals = {
                    set_count: setCount,
                    hard_sets: Number(p.totals?.hard_sets ?? setCount) || setCount,
                    volume_load: Number(p.totals?.volume_load ?? 0) || 0
                };

                return {
                    muscle_group: p.muscle_group || "其它",
                    duration_min: Number(p.duration_min || 0) || 0,
                    exercises: ex,
                    totals,
                    notes: p.notes || "",
                    confidence: clamp(Number(p.confidence || 0.6), 0, 1)
                };
            }

            /** ---------- Add flow ---------- */
            async function startAdd(kind, fileOrFiles) {
                try {
                    openModal();
                    state.modal.type = kind;
                    state.modal.ts = Date.now();

                    $("#modalSub").textContent = "准备图片...";
                    $("#modalTitle").textContent = kind === "meal" ? "三餐识别" : kind === "workout" ? "训练截图识别" : "周复盘照";
                    $("#modalSave").classList.remove("hidden");
                    $("#modalSave").disabled = true;

                    if (kind === "checkin") {
                        const files = Array.from(fileOrFiles || []);
                        state.modal.files = files;
                        $("#modalSub").textContent = `已选择 ${files.length} 张`;
                        // Generate thumbs for preview, store as data URLs in parsed
                        const photoThumbs = [];
                        const photoFulls = [];
                        for (const f of files.slice(0, 6)) {
                            const full = await compressToTarget(f, { maxBytes: 200 * 1024, maxDim: 1280, mime: "image/webp" });
                            const th = await makeThumbFromBlob(full, { maxBytes: 10 * 1024, maxDim: 220, mime: "image/webp" });
                            photoFulls.push(full);
                            const u = await blobToDataURL(th);
                            photoThumbs.push(u);
                        }
                        state.modal.parsed = {
                            weekLabel: buildWeekLabel(state.modal.ts),
                            note: "建议同光线/同距离/同姿势拍摄，便于对比",
                            photosThumb: photoThumbs,
                            photosFull: photoFulls // keep blobs for save
                        };
                        renderCheckinConfirm();
                        $("#modalSave").disabled = false;
                        $("#modalSub").textContent = "可保存";
                        $("#modalSave").onclick = saveModalEntry;
                        return;
                    }

                    // kind meal/workout: compress full to <=200KB for AI
                    const file = fileOrFiles;
                    state.modal.file = file;

                    $("#modalSub").textContent = "压缩用于识别（≤200KB）...";
                    const imgFull = await compressToTarget(file, { maxBytes: 200 * 1024, maxDim: 1280, mime: "image/webp" });
                    state.modal.imgFull = imgFull;

                    $("#modalSub").textContent = "生成缩略图（目标≤10KB）...";
                    const imgThumb = await makeThumbFromBlob(imgFull, { maxBytes: 10 * 1024, maxDim: 220, mime: "image/webp" });
                    state.modal.imgThumb = imgThumb;

                    // preview
                    cleanupModalURLs();
                    state.modal.previewURL = objUrlFromBlob(imgFull);

                    $("#modalSub").textContent = "AI 解析中...";
                    state.modal.parsing = true;

                    const { parsed } = await callVisionStructured({
                        imageBlob: imgFull,
                        kind,
                        ts: state.modal.ts,
                        nutrients: state.settings.nutrients
                    });

                    state.modal.parsing = false;

                    if (kind === "meal") {
                        // override meal_type by time if absent
                        if (!parsed.meal_type) parsed.meal_type = mealTypeFromTs(state.modal.ts);
                        state.modal.parsed = normalizeMealParsed(parsed);
                        renderMealConfirm();
                    } else {
                        state.modal.parsed = normalizeWorkoutParsed(parsed);
                        renderWorkoutConfirm();
                    }

                    $("#modalSub").textContent = "可编辑后保存";
                    $("#modalSave").disabled = false;
                    $("#modalSave").onclick = saveModalEntry;

                } catch (err) {
                    state.modal.parsing = false;
                    $("#modalSub").textContent = "失败";
                    $("#modalBody").innerHTML = `
        <div class="rounded-3xl border border-red-400/20 bg-red-500/10 p-4 text-red-100">
          <div class="font-semibold">解析失败</div>
          <div class="mt-2 text-sm text-white/80">${escapeHtml(err?.message || String(err))}</div>
          <div class="mt-3 text-xs text-white/60">
            提示：请检查 设置 → AI 设置（BaseURL / Model / Key），或稍后重试。
          </div>
        </div>
      `;
                    $("#modalSave").disabled = true;
                    $("#modalSave").onclick = null;
                }
            }

            function buildWeekLabel(ts) {
                // Simple "YYYY-WW" label (approx; MVP)
                const d = new Date(ts);
                const year = d.getFullYear();
                const start = new Date(year, 0, 1);
                const days = Math.floor((d - start) / 86400000);
                const week = Math.floor((days + start.getDay()) / 7) + 1;
                return `${year} 第${week}周`;
            }

            function renderMealConfirm() {
                const p = state.modal.parsed;
                const preview = state.modal.previewURL;
                const body = $("#modalBody");

                const itemsHtml = p.items.map((it, idx) => {
                    const g = Math.round(it.grams || 0);
                    return `
        <div class="rounded-3xl border border-white/10 bg-white/5 p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <input class="itName w-full bg-transparent text-sm font-semibold outline-none border-b border-white/10 focus:border-white/25 pb-1"
                     data-i="${idx}" value="${escapeHtml(it.name)}" />
              <div class="text-xs text-white/60 mt-2">
                <span class="mono">${Math.round(it.kcal || 0)} kcal</span>
                <span class="mx-2 text-white/30">·</span>
                P <span class="mono">${Math.round(it.p || 0)}g</span>
                <span class="mx-2 text-white/30">·</span>
                C <span class="mono">${Math.round(it.c || 0)}g</span>
                <span class="mx-2 text-white/30">·</span>
                F <span class="mono">${Math.round(it.f || 0)}g</span>
              </div>
            </div>
            <div class="text-right shrink-0">
              <div class="text-xs text-white/60">克数</div>
              <div class="text-lg font-semibold mono" id="g_${idx}">${g}</div>
              <div class="text-xs text-white/50">g</div>
            </div>
          </div>

          <div class="mt-3">
            <input type="range" min="0" max="400" step="5" value="${g}" data-grams="${idx}" class="w-full accent-white/60"/>
            <div class="mt-2 flex gap-2">
              <button class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 text-xs hover:bg-white/15" data-step="${idx}" data-d="-5">-5g</button>
              <button class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 text-xs hover:bg-white/15" data-step="${idx}" data-d="5">+5g</button>
              <div class="ml-auto text-xs text-white/50">置信度 <span class="mono">${Math.round((it.confidence || 0.6) * 100)}%</span></div>
            </div>
          </div>
        </div>
      `;
                }).join("");

                body.innerHTML = `
      <div class="rounded-3xl border border-white/10 overflow-hidden bg-black/30">
        <img src="${preview}" class="w-full max-h-[34vh] object-cover"/>
      </div>

      <div class="mt-4 rounded-3xl border border-white/10 bg-white/5 p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">用餐类型</div>
          <select id="mealTypeSel" class="rounded-xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none">
            ${["早餐", "午餐", "晚餐", "加餐"].map(t => `<option ${p.meal_type === t ? "selected" : ""}>${t}</option>`).join("")}
          </select>
        </div>
        <div class="mt-2 text-xs text-white/60">
          时间：${tsToHuman(state.modal.ts)}
        </div>
        <div class="mt-3 rounded-2xl border border-white/10 bg-black/25 p-3">
          <div class="text-xs text-white/60">总计</div>
          <div class="mt-1 text-sm">
            <span class="mono" id="totKcal">${Math.round(p.totals.kcal || 0)}</span> kcal
            <span class="mx-2 text-white/30">·</span>
            P <span class="mono" id="totP">${Math.round(p.totals.p || 0)}</span>g
            <span class="mx-2 text-white/30">·</span>
            C <span class="mono" id="totC">${Math.round(p.totals.c || 0)}</span>g
            <span class="mx-2 text-white/30">·</span>
            F <span class="mono" id="totF">${Math.round(p.totals.f || 0)}</span>g
          </div>
        </div>
      </div>

      <div class="mt-4 space-y-3">
        ${itemsHtml || `<div class="text-sm text-white/60">未识别到食物项，你可以换一张更清晰的照片再试。</div>`}
      </div>

      <div class="mt-4 text-xs text-white/50">
        微调规则：滑块步进 5g。总计会实时重算（线性缩放）。
      </div>
    `;

                // bind controls
                $("#mealTypeSel").addEventListener("change", (e) => {
                    state.modal.parsed.meal_type = e.target.value;
                });

                body.querySelectorAll("[data-grams]").forEach(r => {
                    r.addEventListener("input", () => {
                        const idx = Number(r.dataset.grams);
                        const it = state.modal.parsed.items[idx];
                        recalcMealItem(it, Number(r.value));
                        $("#g_" + idx).textContent = Math.round(it.grams || 0);
                        updateMealTotalsUI();
                    });
                });

                body.querySelectorAll("[data-step]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const idx = Number(btn.dataset.step);
                        const d = Number(btn.dataset.d);
                        const it = state.modal.parsed.items[idx];
                        const next = clamp((it.grams || 0) + d, 0, 400);
                        recalcMealItem(it, next);
                        // sync slider
                        const slider = body.querySelector(`input[type="range"][data-grams="${idx}"]`);
                        slider.value = Math.round(next / 5) * 5;
                        $("#g_" + idx).textContent = Math.round(it.grams || 0);
                        updateMealTotalsUI();
                    });
                });

                body.querySelectorAll(".itName").forEach(inp => {
                    inp.addEventListener("change", () => {
                        const idx = Number(inp.dataset.i);
                        state.modal.parsed.items[idx].name = inp.value.trim() || state.modal.parsed.items[idx].name;
                    });
                });

                updateMealTotalsUI();
            }

            function updateMealTotalsUI() {
                const totals = calcMealTotals(state.modal.parsed.items);
                state.modal.parsed.totals = totals;
                $("#totKcal").textContent = Math.round(totals.kcal || 0);
                $("#totP").textContent = Math.round(totals.p || 0);
                $("#totC").textContent = Math.round(totals.c || 0);
                $("#totF").textContent = Math.round(totals.f || 0);
            }

            function renderWorkoutConfirm() {
                const p = state.modal.parsed;
                const preview = state.modal.previewURL;
                const body = $("#modalBody");

                const exHtml = (p.exercises || []).map((it, idx) => `
      <div class="rounded-3xl border border-white/10 bg-white/5 p-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0 flex-1">
            <input class="wkName w-full bg-transparent text-sm font-semibold outline-none border-b border-white/10 focus:border-white/25 pb-1"
                   data-i="${idx}" value="${escapeHtml(it.name)}"/>
            <div class="mt-2 grid grid-cols-3 gap-2">
              <label class="block">
                <div class="text-[11px] text-white/60 mb-1">组数</div>
                <input class="wkSets w-full rounded-xl bg-black/35 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25 mono"
                       data-i="${idx}" value="${escapeHtml(it.sets)}"/>
              </label>
              <label class="block">
                <div class="text-[11px] text-white/60 mb-1">次数</div>
                <input class="wkReps w-full rounded-xl bg-black/35 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25 mono"
                       data-i="${idx}" value="${escapeHtml(it.reps)}"/>
              </label>
              <label class="block">
                <div class="text-[11px] text-white/60 mb-1">重量</div>
                <input class="wkWeight w-full rounded-xl bg-black/35 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25 mono"
                       data-i="${idx}" value="${escapeHtml(it.weight)}"/>
              </label>
            </div>
          </div>
          <button class="tap text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" data-del="${idx}">删除</button>
        </div>
      </div>
    `).join("");

                body.innerHTML = `
      <div class="rounded-3xl border border-white/10 overflow-hidden bg-black/30">
        <img src="${preview}" class="w-full max-h-[34vh] object-cover"/>
      </div>

      <div class="mt-4 rounded-3xl border border-white/10 bg-white/5 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="flex-1">
            <div class="text-xs text-white/60">训练部位</div>
            <input id="wkGroup" class="mt-1 w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                   value="${escapeHtml(p.muscle_group || "其它")}" />
          </div>
          <div class="text-right shrink-0">
            <div class="text-xs text-white/60">总组</div>
            <div id="wkSetCount" class="text-lg font-semibold mono">${Math.round(p.totals?.set_count || 0)}</div>
          </div>
        </div>

        <div class="mt-3 text-xs text-white/60">时间：${tsToHuman(state.modal.ts)}</div>

        <div class="mt-3 rounded-2xl border border-white/10 bg-black/25 p-3">
          <div class="text-xs text-white/60">训练指标（可后续完善）</div>
          <div class="mt-1 text-sm">
            Volume <span class="mono" id="wkVol">${Math.round(p.totals?.volume_load || 0)}</span>
            <span class="mx-2 text-white/30">·</span>
            Hard Sets <span class="mono" id="wkHard">${Math.round(p.totals?.hard_sets || 0)}</span>
          </div>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm font-semibold">动作列表</div>
        <button id="btnAddEx" class="tap text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15">+ 添加动作</button>
      </div>

      <div id="wkList" class="mt-3 space-y-3">
        ${exHtml || `<div class="text-sm text-white/60">未识别到动作，你可以手动添加。</div>`}
      </div>

      <div class="mt-4 text-xs text-white/50">提示：MVP 阶段 Volume Load 若截图缺少重量/次数，可能为 0。你后续可以用更完整的记录源增强。</div>
    `;

                // bind
                $("#wkGroup").addEventListener("change", (e) => {
                    state.modal.parsed.muscle_group = e.target.value.trim() || "其它";
                });

                $("#btnAddEx").addEventListener("click", () => {
                    state.modal.parsed.exercises.push({ name: "新动作", sets: 3, reps: "10", weight: "" });
                    renderWorkoutConfirm();
                    recomputeWorkoutTotals();
                });

                body.querySelectorAll("[data-del]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const idx = Number(btn.dataset.del);
                        state.modal.parsed.exercises.splice(idx, 1);
                        renderWorkoutConfirm();
                        recomputeWorkoutTotals();
                    });
                });

                body.querySelectorAll(".wkName").forEach(inp => {
                    inp.addEventListener("change", () => {
                        const idx = Number(inp.dataset.i);
                        state.modal.parsed.exercises[idx].name = inp.value.trim() || state.modal.parsed.exercises[idx].name;
                    });
                });
                body.querySelectorAll(".wkSets").forEach(inp => {
                    inp.addEventListener("change", () => {
                        const idx = Number(inp.dataset.i);
                        state.modal.parsed.exercises[idx].sets = Number(inp.value || 0) || 0;
                        recomputeWorkoutTotals();
                    });
                });
                body.querySelectorAll(".wkReps").forEach(inp => {
                    inp.addEventListener("change", () => {
                        const idx = Number(inp.dataset.i);
                        state.modal.parsed.exercises[idx].reps = inp.value;
                    });
                });
                body.querySelectorAll(".wkWeight").forEach(inp => {
                    inp.addEventListener("change", () => {
                        const idx = Number(inp.dataset.i);
                        state.modal.parsed.exercises[idx].weight = inp.value;
                    });
                });

                recomputeWorkoutTotals();
            }

            function recomputeWorkoutTotals() {
                const ex = state.modal.parsed.exercises || [];
                let setCount = 0;
                for (const e of ex) setCount += Number(e.sets || 0) || 0;
                state.modal.parsed.totals = state.modal.parsed.totals || {};
                state.modal.parsed.totals.set_count = setCount;
                if (!state.modal.parsed.totals.hard_sets) state.modal.parsed.totals.hard_sets = setCount;
                // keep volume_load as is (can be enhanced later)
                $("#wkSetCount") && ($("#wkSetCount").textContent = String(Math.round(setCount)));
                $("#wkHard") && ($("#wkHard").textContent = String(Math.round(state.modal.parsed.totals.hard_sets || 0)));
                $("#wkVol") && ($("#wkVol").textContent = String(Math.round(state.modal.parsed.totals.volume_load || 0)));
            }

            function renderCheckinConfirm() {
                const p = state.modal.parsed;
                const body = $("#modalBody");
                body.innerHTML = `
      <div class="rounded-3xl border border-white/10 bg-white/5 p-4">
        <div class="text-sm font-semibold">周复盘</div>
        <div class="text-xs text-white/60 mt-1">时间：${tsToHuman(state.modal.ts)}</div>

        <div class="mt-3">
          <div class="text-xs text-white/60 mb-1">标签</div>
          <input id="ckWeek" class="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25"
                 value="${escapeHtml(p.weekLabel || buildWeekLabel(state.modal.ts))}" />
        </div>
        <div class="mt-3">
          <div class="text-xs text-white/60 mb-1">备注</div>
          <textarea id="ckNote" rows="2" class="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/25">${escapeHtml(p.note || "")}</textarea>
        </div>

        <div class="mt-4">
          <div class="text-xs text-white/60 mb-2">预览（缩略图）</div>
          <div class="flex gap-2 flex-wrap">
            ${(p.photosThumb || []).map(u => `
              <div class="h-24 w-24 rounded-2xl border border-white/10 overflow-hidden bg-black/30">
                <img src="${u}" class="h-full w-full object-cover"/>
              </div>
            `).join("")}
          </div>
        </div>
      </div>
    `;

                $("#ckWeek").addEventListener("change", (e) => state.modal.parsed.weekLabel = e.target.value.trim());
                $("#ckNote").addEventListener("change", (e) => state.modal.parsed.note = e.target.value.trim());
            }

            async function saveModalEntry() {
                const kind = state.modal.type;
                const ts = state.modal.ts;
                const day = tsToDay(ts);

                if (kind === "meal") {
                    const entry = {
                        id: uid("meal"),
                        type: "meal",
                        ts, day,
                        imgFull: state.modal.imgFull,
                        imgThumb: state.modal.imgThumb,
                        data: {
                            meal_type: state.modal.parsed.meal_type || mealTypeFromTs(ts),
                            items: state.modal.parsed.items,
                            totals: state.modal.parsed.totals,
                            notes: state.modal.parsed.notes || ""
                        }
                    };
                    await idbPut("entries", entry);
                    await loadEntries();
                    toast("已保存：三餐");
                    closeModal();
                    setView("home");
                    return;
                }

                if (kind === "workout") {
                    const entry = {
                        id: uid("wk"),
                        type: "workout",
                        ts, day,
                        imgFull: state.modal.imgFull,
                        imgThumb: state.modal.imgThumb,
                        data: state.modal.parsed
                    };
                    await idbPut("entries", entry);
                    await loadEntries();
                    toast("已保存：训练");
                    closeModal();
                    setView("home");
                    return;
                }

                if (kind === "checkin") {
                    // store full blobs in entry for export; store thumbs as data URLs for quick UI
                    const entry = {
                        id: uid("ck"),
                        type: "checkin",
                        ts, day,
                        imgFull: null,
                        imgThumb: null,
                        data: {
                            weekLabel: state.modal.parsed.weekLabel || buildWeekLabel(ts),
                            note: state.modal.parsed.note || "",
                            photosThumb: state.modal.parsed.photosThumb || [],
                            photosFull: state.modal.parsed.photosFull || []
                        }
                    };
                    await idbPut("entries", entry);
                    await loadEntries();
                    toast("已保存：周复盘");
                    closeModal();
                    setView("review");
                    return;
                }
            }

            /** ---------- ZIP Export/Import ---------- */
            function filenameFromEntry(entry, idx = 0) {
                const d = new Date(entry.ts);
                const stamp = `${d.getFullYear()}${pad2(d.getMonth() + 1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
                const t = entry.type;
                return `${stamp}_${t}_${entry.id}${idx ? ("_" + idx) : ""}.webp`;
            }

            async function exportZip() {
                const zip = new JSZip();
                const imgs = zip.folder("imgs");

                const entries = await idbGetAll("entries");
                entries.sort((a, b) => a.ts - b.ts);

                const out = {
                    app: "FitFlow",
                    version: 1,
                    exported_at: new Date().toISOString(),
                    entries: []
                };

                for (const e of entries) {
                    const copy = {
                        id: e.id,
                        type: e.type,
                        ts: e.ts,
                        day: e.day,
                        data: JSON.parse(JSON.stringify(stripBlobsFromData(e.data))),
                        img_files: []
                    };

                    // main image
                    if (e.imgFull instanceof Blob) {
                        const fn = filenameFromEntry(e);
                        copy.img_files.push(fn);
                        imgs.file(fn, e.imgFull);
                    }

                    // checkin multiple photos
                    if (e.type === "checkin" && Array.isArray(e.data?.photosFull)) {
                        const arr = e.data.photosFull;
                        for (let i = 0; i < arr.length; i++) {
                            const b = arr[i];
                            if (b instanceof Blob) {
                                const fn = filenameFromEntry(e, i + 1);
                                copy.img_files.push(fn);
                                imgs.file(fn, b);
                            }
                        }
                        // DO NOT export thumbs as images by default (keep zip smaller)
                        // thumbs stay in data as dataURLs for convenience; still okay (small)
                    }

                    out.entries.push(copy);
                }

                zip.file("data.json", JSON.stringify(out, null, 2));
                const blob = await zip.generateAsync({ type: "blob", compression: "DEFLATE", compressionOptions: { level: 6 } });
                saveAs(blob, `fitflow_export_${Date.now()}.zip`);
                toast("已导出 ZIP");
            }

            function stripBlobsFromData(data) {
                // Avoid structured clone issues in JSON for export
                if (!data) return data;
                const d = { ...data };
                if (d.photosFull) delete d.photosFull; // images stored separately in /imgs
                return d;
            }

            async function importZip(file, mode /* 'full'|'inc' */) {
                if (!file) throw new Error("未选择 ZIP 文件");
                $("#importHint").classList.remove("hidden");
                $("#importHint").textContent = "读取 ZIP 中...";
                const buf = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(buf);

                const dataFile = zip.file("data.json");
                if (!dataFile) throw new Error("ZIP 缺少 data.json");
                const dataText = await dataFile.async("string");
                const pack = JSON.parse(dataText);
                if (!pack.entries || !Array.isArray(pack.entries)) throw new Error("data.json 格式不正确");

                const imgsFolder = zip.folder("imgs");

                if (mode === "full") {
                    $("#importHint").textContent = "全量导入：清空本地数据...";
                    await idbClear("entries");
                }

                // Build existing set for incremental
                const existing = new Set((await idbGetAll("entries")).map(e => e.id));

                let imported = 0, skipped = 0;
                for (const e of pack.entries) {
                    if (mode === "inc" && existing.has(e.id)) {
                        skipped++;
                        continue;
                    }

                    $("#importHint").textContent = `导入中：${imported + skipped + 1}/${pack.entries.length}`;

                    const record = {
                        id: e.id,
                        type: e.type,
                        ts: e.ts,
                        day: e.day,
                        imgFull: null,
                        imgThumb: null,
                        data: e.data || {}
                    };

                    // Re-attach images from /imgs
                    if (Array.isArray(e.img_files) && e.img_files.length) {
                        // For meal/workout: first file is main
                        if (e.type !== "checkin") {
                            const fn = e.img_files[0];
                            const zf = imgsFolder?.file(fn);
                            if (zf) {
                                const blob = await zf.async("blob");
                                record.imgFull = blob;
                                record.imgThumb = await makeThumbFromBlob(blob, { maxBytes: 10 * 1024, maxDim: 220, mime: "image/webp" });
                            }
                        } else {
                            // For checkin: multiple files; store in data.photosFull (blobs) for export later, thumbs for UI
                            const photosFull = [];
                            const photosThumb = [];
                            for (const fn of e.img_files) {
                                const zf = imgsFolder?.file(fn);
                                if (!zf) continue;
                                const blob = await zf.async("blob");
                                photosFull.push(blob);
                                const th = await makeThumbFromBlob(blob, { maxBytes: 10 * 1024, maxDim: 220, mime: "image/webp" });
                                photosThumb.push(await blobToDataURL(th));
                            }
                            record.data.photosFull = photosFull;
                            record.data.photosThumb = record.data.photosThumb || photosThumb;
                        }
                    }

                    // Normalize parsed structures for older exports if needed
                    if (record.type === "meal") {
                        // ensure totals exist
                        if (!record.data.totals && Array.isArray(record.data.items)) {
                            record.data.totals = calcMealTotals(record.data.items);
                        }
                    }
                    if (record.type === "workout") {
                        record.data.totals = record.data.totals || {};
                    }

                    await idbPut("entries", record);
                    imported++;
                }

                await loadEntries();
                $("#importHint").textContent = `导入完成：导入 ${imported} 条，跳过 ${skipped} 条。`;
                toast("导入完成");
            }

            /** ---------- AI Agent (function calling loop) ---------- */
            function pushAgentMsg(role, html) {
                state.agent.msgs.push({ role, html, ts: Date.now() });
                renderAgentMsgs();
            }

            function renderAgentMsgs() {
                const wrap = $("#agentMsgs");
                wrap.innerHTML = state.agent.msgs.map(m => {
                    const isUser = m.role === "user";
                    const bubble = isUser
                        ? `bg-emerald-500/10 border-emerald-400/20`
                        : `bg-white/8 border-white/10`;
                    return `
        <div class="flex ${isUser ? "justify-end" : "justify-start"}">
          <div class="max-w-[92%] rounded-3xl border ${bubble} p-3">
            <div class="text-xs text-white/50">${isUser ? "你" : "AI"} · ${tsToHuman(m.ts).slice(-5)}</div>
            <div class="mt-1 text-sm text-white/85 leading-relaxed">${m.html}</div>
          </div>
        </div>
      `;
                }).join("");
                wrap.scrollTop = wrap.scrollHeight;
            }

            function toolsSpec() {
                return [
                    {
                        type: "function",
                        function: {
                            name: "queryMeals",
                            description: "查询指定时间范围的用餐记录（结构化）",
                            parameters: {
                                type: "object",
                                properties: {
                                    from: { type: "number", description: "起始时间戳ms" },
                                    to: { type: "number", description: "结束时间戳ms" },
                                    meal_type: { type: "string", description: "早餐/午餐/晚餐/加餐（可选）" }
                                },
                                required: ["from", "to"]
                            }
                        }
                    },
                    {
                        type: "function",
                        function: {
                            name: "queryWorkouts",
                            description: "查询指定时间范围的训练记录（结构化）",
                            parameters: {
                                type: "object",
                                properties: {
                                    from: { type: "number" },
                                    to: { type: "number" },
                                    muscle_group: { type: "string", description: "胸/肩/背/腿/臂/全身/其它（可选）" }
                                },
                                required: ["from", "to"]
                            }
                        }
                    },
                    {
                        type: "function",
                        function: {
                            name: "computeMacroTrend",
                            description: "计算最近N天热量与三大营养素趋势（按天）",
                            parameters: {
                                type: "object",
                                properties: { days: { type: "number" } },
                                required: ["days"]
                            }
                        }
                    },
                    {
                        type: "function",
                        function: {
                            name: "computeTrainingVolumeTrend",
                            description: "计算最近N次训练的容量（Volume Load）趋势",
                            parameters: {
                                type: "object",
                                properties: {
                                    nSessions: { type: "number" },
                                    muscle_group: { type: "string" }
                                },
                                required: ["nSessions"]
                            }
                        }
                    },
                    {
                        type: "function",
                        function: {
                            name: "suggestPlan",
                            description: "基于目标与近14天数据给出热量/蛋白/训练建议（启发式）",
                            parameters: {
                                type: "object",
                                properties: {
                                    goal: { type: "string", description: "增肌/减脂" },
                                    target_weight: { type: "number" },
                                    current_weight: { type: "number" },
                                    days_window: { type: "number" }
                                },
                                required: ["goal", "days_window"]
                            }
                        }
                    }
                ];
            }

            async function toolImpl(name, args) {
                const now = Date.now();
                if (name === "queryMeals") {
                    const from = Number(args.from), to = Number(args.to);
                    const mt = args.meal_type;
                    const meals = state.entries
                        .filter(e => e.type === "meal" && e.ts >= from && e.ts <= to)
                        .filter(e => !mt || e.data?.meal_type === mt)
                        .sort((a, b) => a.ts - b.ts)
                        .map(e => ({
                            id: e.id, ts: e.ts, day: e.day, meal_type: e.data?.meal_type,
                            totals: e.data?.totals, items: (e.data?.items || []).slice(0, 12)
                        }));
                    return { count: meals.length, meals };
                }

                if (name === "queryWorkouts") {
                    const from = Number(args.from), to = Number(args.to);
                    const mg = args.muscle_group;
                    const wks = state.entries
                        .filter(e => e.type === "workout" && e.ts >= from && e.ts <= to)
                        .filter(e => !mg || (e.data?.muscle_group === mg))
                        .sort((a, b) => a.ts - b.ts)
                        .map(e => ({
                            id: e.id, ts: e.ts, day: e.day, muscle_group: e.data?.muscle_group,
                            totals: e.data?.totals, exercises: (e.data?.exercises || []).slice(0, 12)
                        }));
                    return { count: wks.length, workouts: wks };
                }

                if (name === "computeMacroTrend") {
                    const days = Math.max(1, Number(args.days) || 7);
                    const from = now - days * 24 * 3600 * 1000;
                    const meals = state.entries.filter(e => e.type === "meal" && e.ts >= from);
                    const byDay = new Map();
                    for (const m of meals) {
                        if (!byDay.has(m.day)) byDay.set(m.day, { day: m.day, kcal: 0, p: 0, c: 0, f: 0 });
                        const t = m.data?.totals || {};
                        const x = byDay.get(m.day);
                        x.kcal += Number(t.kcal || 0);
                        x.p += Number(t.p || 0);
                        x.c += Number(t.c || 0);
                        x.f += Number(t.f || 0);
                    }
                    const series = Array.from(byDay.values()).sort((a, b) => a.day.localeCompare(b.day));
                    const daysCount = Math.max(1, series.length);
                    const avg = {
                        kcal: series.reduce((s, x) => s + x.kcal, 0) / daysCount,
                        p: series.reduce((s, x) => s + x.p, 0) / daysCount,
                        c: series.reduce((s, x) => s + x.c, 0) / daysCount,
                        f: series.reduce((s, x) => s + x.f, 0) / daysCount
                    };
                    return { days, series, avg };
                }

                if (name === "computeTrainingVolumeTrend") {
                    const n = Math.max(1, Number(args.nSessions) || 4);
                    const mg = args.muscle_group;
                    const wks = state.entries
                        .filter(e => e.type === "workout")
                        .filter(e => !mg || e.data?.muscle_group === mg)
                        .sort((a, b) => b.ts - a.ts)
                        .slice(0, n)
                        .reverse()
                        .map(e => ({
                            id: e.id, ts: e.ts, day: e.day, muscle_group: e.data?.muscle_group,
                            volume_load: Number(e.data?.totals?.volume_load || 0)
                        }));
                    return { nSessions: n, series: wks };
                }

                if (name === "suggestPlan") {
                    const goal = args.goal || "减脂";
                    const windowDays = Math.max(7, Number(args.days_window || 14));
                    const macro = await toolImpl("computeMacroTrend", { days: windowDays });
                    const wk = await toolImpl("computeTrainingVolumeTrend", { nSessions: 4 });
                    // A tiny heuristic plan
                    const avgKcal = macro.avg.kcal || 0;
                    const avgP = macro.avg.p || 0;
                    let targetKcal = avgKcal;
                    let targetP = avgP;

                    if (goal.includes("减") || goal.includes("脂")) {
                        targetKcal = Math.max(1200, avgKcal * 0.88);
                        targetP = Math.max(90, avgP, 1.6 * (Number(args.current_weight || 60) || 60));
                    } else {
                        targetKcal = avgKcal * 1.10;
                        targetP = Math.max(110, avgP, 1.8 * (Number(args.current_weight || 60) || 60));
                    }

                    return {
                        windowDays,
                        current_avg: { kcal: avgKcal, p: avgP },
                        target: { kcal: Math.round(targetKcal), p: Math.round(targetP) },
                        recent_training: wk.series,
                        suggestions: [
                            goal.includes("减") ? "优先保证蛋白，再轻微下调热量（-10%~ -15%）。" : "轻微盈余热量（+5%~+15%），维持高蛋白与渐进超负荷。",
                            "用餐分配：训练后优先补充蛋白+适量碳水；晚餐避免高油高糖。",
                            "训练：每个大肌群每周 10~20 有效组；记录重量/次数以便计算真实容量。"
                        ]
                    };
                }

                throw new Error("未知工具：" + name);
            }

            async function agentAsk(question) {
                const providers = getProviders();
                const provider = providers.find(p => p.apiKey) || providers[0];

                if (!provider.apiKey) {
                    pushAgentMsg("assistant", `请先在「设置 → AI 设置」配置 API Key。`);
                    return;
                }

                pushAgentMsg("user", escapeHtml(question));
                pushAgentMsg("assistant", `<div class="text-white/70">收到。我会拆解 → 调用工具查询你的本地数据 → 给出结论与下一步行动。</div>`);

                const system = `
你是 FitFlow 的健康与训练复盘 Agent。你必须使用工具来查询用户的本地数据（饮食/训练），再给建议。
输出要简洁：先给 3-6 条 plan（要点），再给关键发现（数字），最后给行动建议（可执行）。
如果用户问到“最近X天/最近4次”，你必须调用相应工具。
如果数据不足，要明确指出缺口，并给出“下一次怎么记录能更准”。
`;
                const messages = [
                    { role: "system", content: system.trim() },
                    { role: "user", content: question }
                ];

                const tools = toolsSpec();

                const maxLoops = 6;
                let loop = 0;
                let finalText = "";

                while (loop++ < maxLoops) {
                    let resp;
                    try {
                        resp = await openaiChat(provider, {
                            temperature: 0.2,
                            messages,
                            tools,
                            tool_choice: "auto"
                        });
                    } catch (err) {
                        // fallback to provider #2 if exists
                        const p2 = providers[1];
                        if (p2?.apiKey) {
                            try {
                                resp = await openaiChat(p2, {
                                    temperature: 0.2,
                                    messages,
                                    tools,
                                    tool_choice: "auto"
                                });
                            } catch (err2) {
                                pushAgentMsg("assistant", `<div class="text-red-100">请求失败：${escapeHtml(err2.message || String(err2))}</div>`);
                                return;
                            }
                        } else {
                            pushAgentMsg("assistant", `<div class="text-red-100">请求失败：${escapeHtml(err.message || String(err))}</div>`);
                            return;
                        }
                    }

                    const msg = resp?.choices?.[0]?.message;
                    if (!msg) break;

                    // tool calls?
                    if (Array.isArray(msg.tool_calls) && msg.tool_calls.length) {
                        for (const tc of msg.tool_calls) {
                            const name = tc.function?.name;
                            const argsStr = tc.function?.arguments || "{}";
                            const args = safeJsonParse(argsStr) || {};
                            pushAgentMsg("assistant", `<div class="text-white/70"><span class="mono text-white/85">tool_call</span> · ${escapeHtml(name)} ${escapeHtml(JSON.stringify(args))}</div>`);
                            let result;
                            try {
                                result = await toolImpl(name, args);
                            } catch (err) {
                                result = { error: err.message || String(err) };
                            }
                            pushAgentMsg("assistant", `<div class="text-white/70"><span class="mono text-white/85">tool_result</span> · ${escapeHtml(name)} → <span class="mono">${escapeHtml(JSON.stringify(result).slice(0, 500))}${JSON.stringify(result).length > 500 ? "…" : ""}</span></div>`);
                            messages.push({ role: "assistant", tool_calls: [tc] });
                            messages.push({ role: "tool", tool_call_id: tc.id, content: JSON.stringify(result) });
                        }
                        continue;
                    }

                    finalText = msg.content || "";
                    break;
                }

                if (!finalText) {
                    finalText = "我已查询了数据，但没有得到可输出的最终回答（可能是工具返回为空）。你可以换个问法或先补充几条记录。";
                }

                pushAgentMsg("assistant", `<div class="whitespace-pre-wrap">${escapeHtml(finalText)}</div>`);
            }

            /** ---------- Events ---------- */
            function bindEvents() {
                // nav
                $$(".navBtn").forEach(btn => {
                    btn.addEventListener("click", () => setView(btn.dataset.nav));
                });

                $("#btnQuickAdd").addEventListener("click", () => setView("add"));
                $("#btnRefresh").addEventListener("click", async () => {
                    await loadEntries();
                    toast("已刷新");
                });
                $("#btnRecompute").addEventListener("click", () => {
                    renderReview();
                    toast("已更新");
                });

                $("#btnSyncHint").addEventListener("click", () => {
                    const eCount = state.entries.length;
                    toast(eCount ? `本地记录：${eCount} 条` : "暂无记录");
                });

                // add buttons
                $("#addWorkoutBtn").addEventListener("click", () => $("#fileWorkout").click());
                $("#addMealBtn").addEventListener("click", () => $("#fileMeal").click());
                $("#addCheckinBtn").addEventListener("click", () => $("#fileCheckin").click());

                $("#fileWorkout").addEventListener("change", async (e) => {
                    const f = e.target.files?.[0];
                    e.target.value = "";
                    if (!f) return;
                    await startAdd("workout", f);
                    $("#modalSave").onclick = saveModalEntry;
                });

                $("#fileMeal").addEventListener("change", async (e) => {
                    const f = e.target.files?.[0];
                    e.target.value = "";
                    if (!f) return;
                    await startAdd("meal", f);
                    $("#modalSave").onclick = saveModalEntry;
                });

                $("#fileCheckin").addEventListener("change", async (e) => {
                    const files = e.target.files;
                    e.target.value = "";
                    if (!files || !files.length) return;
                    await startAdd("checkin", files);
                    $("#modalSave").onclick = saveModalEntry;
                });

                // modal close
                $("#modalClose").addEventListener("click", closeModal);
                $("#modalCancel").addEventListener("click", closeModal);
                $("#modalBackdrop").addEventListener("click", closeModal);

                // agent
                $("#agentFab").addEventListener("click", () => {
                    $("#agentDrawer").classList.remove("hidden");
                    state.agent.open = true;
                    if (!state.agent.msgs.length) {
                        pushAgentMsg("assistant", `你可以问我：<br/>• 最近7天饮食复盘<br/>• 最近4次训练容量<br/>• 怎么瘦到60kg（基于你的数据）`);
                    }
                });
                $("#agentClose").addEventListener("click", () => $("#agentDrawer").classList.add("hidden"));
                $("#agentBackdrop").addEventListener("click", () => $("#agentDrawer").classList.add("hidden"));
                $("#agentSend").addEventListener("click", () => {
                    const q = $("#agentInput").value.trim();
                    if (!q) return;
                    $("#agentInput").value = "";
                    agentAsk(q);
                });
                $("#agentInput").addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        $("#agentSend").click();
                    }
                });
                $$(".chip").forEach(ch => {
                    ch.addEventListener("click", () => {
                        const q = ch.dataset.q;
                        agentAsk(q);
                    });
                });

                // settings save
                $("#btnDefaults").addEventListener("click", async () => {
                    state.settings.baseUrl = DEFAULTS.baseUrl;
                    state.settings.model = DEFAULTS.model;
                    $("#setBaseUrl").value = state.settings.baseUrl;
                    $("#setModel").value = state.settings.model;
                    await saveSettings();
                    toast("已恢复默认 BaseURL/Model");
                });

                $("#btnSaveSettings").addEventListener("click", async () => {
                    state.settings.baseUrl = $("#setBaseUrl").value.trim() || DEFAULTS.baseUrl;
                    state.settings.model = $("#setModel").value.trim() || DEFAULTS.model;
                    state.settings.key1 = $("#setKey1").value.trim();
                    state.settings.key2 = $("#setKey2").value.trim();
                    await saveSettings();
                    toast("已保存设置");
                });

                $("#btnTestAI").addEventListener("click", async () => {
                    const box = $("#aiTestResult");
                    box.classList.remove("hidden");
                    box.textContent = "测试中...";
                    try {
                        state.settings.baseUrl = $("#setBaseUrl").value.trim() || DEFAULTS.baseUrl;
                        state.settings.model = $("#setModel").value.trim() || DEFAULTS.model;
                        state.settings.key1 = $("#setKey1").value.trim();
                        state.settings.key2 = $("#setKey2").value.trim();
                        await saveSettings();

                        const p = getProviders().find(x => x.apiKey);
                        if (!p?.apiKey) throw new Error("未设置 Key");
                        const resp = await openaiChat(p, {
                            temperature: 0.2,
                            messages: [
                                { role: "system", content: "你是测试助手，只回复 'ok'." },
                                { role: "user", content: "test" }
                            ]
                        });
                        const t = resp?.choices?.[0]?.message?.content || "";
                        box.textContent = `✅ OK · provider=${p.name} · reply=${t.slice(0, 40)}`;
                    } catch (err) {
                        box.textContent = `❌ 失败：${err.message || String(err)}`;
                    }
                });

                // nutrients
                $("#btnAddNutrient").addEventListener("click", async () => {
                    const v = $("#nutrientInput").value.trim();
                    if (!v) return;
                    $("#nutrientInput").value = "";
                    if (!state.settings.nutrients.includes(v)) {
                        state.settings.nutrients.push(v);
                        await saveSettings();
                        renderNutrientTags();
                        toast("已添加");
                    } else {
                        toast("已存在");
                    }
                });

                // zip export/import
                $("#btnExportZip").addEventListener("click", async () => {
                    try {
                        await exportZip();
                    } catch (err) {
                        toast("导出失败：" + (err.message || String(err)));
                    }
                });

                $("#btnPickZip").addEventListener("click", () => $("#zipFile").click());

                $("#btnImportFull").addEventListener("click", async () => {
                    const f = $("#zipFile").files?.[0];
                    try {
                        await importZip(f, "full");
                    } catch (err) {
                        $("#importHint").classList.remove("hidden");
                        $("#importHint").textContent = "导入失败：" + (err.message || String(err));
                    }
                });

                $("#btnImportInc").addEventListener("click", async () => {
                    const f = $("#zipFile").files?.[0];
                    try {
                        await importZip(f, "inc");
                    } catch (err) {
                        $("#importHint").classList.remove("hidden");
                        $("#importHint").textContent = "导入失败：" + (err.message || String(err));
                    }
                });

                $("#zipFile").addEventListener("change", () => {
                    const f = $("#zipFile").files?.[0];
                    if (f) {
                        $("#importHint").classList.remove("hidden");
                        $("#importHint").textContent = `已选择：${f.name}（${Math.round(f.size / 1024)} KB）`;
                    }
                });

                $("#btnClearData").addEventListener("click", async () => {
                    const ok = confirm("确认清空本地数据？此操作不可撤销。");
                    if (!ok) return;
                    try {
                        await deleteDatabase();
                        toast("已清空，刷新中...");
                        location.reload();
                    } catch (err) {
                        alert(err.message || String(err));
                    }
                });
            }

            /** ---------- Init ---------- */
            async function init() {
                // Ensure defaults required by user:
                // baseurl: https://b.apiyi.com/v1 , model: gpt-4.1-mini
                db = await openDB();
                await loadSettings();

                // force-set default baseurl/model on first run (or if missing)
                if (!state.settings.baseUrl) state.settings.baseUrl = DEFAULTS.baseUrl;
                if (!state.settings.model) state.settings.model = DEFAULTS.model;
                await saveSettings();

                await loadEntries();
                bindEvents();
                setView("home");
            }

            init().catch(err => {
                alert("初始化失败：" + (err.message || String(err)));
            });

        })();
    </script>
</body>

</html>