<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BodyOS 进化体</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Dexie (Database) -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- Image Compression -->
    <script
        src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Marked (Markdown rendering) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* iOS 风格滚动条隐藏 */
        ::-webkit-scrollbar {
            display: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FAFAFA;
            -webkit-tap-highlight-color: transparent;
        }

        .slide-enter-active,
        .slide-leave-active {
            transition: all 0.3s ease;
        }

        .slide-enter-from,
        .slide-leave-to {
            transform: translateY(100%);
            opacity: 0;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* 自定义滑块样式 */
        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 5px;
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #000;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .masonry-col {
            break-inside: avoid;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="text-gray-900 pb-20">

    <div id="app" class="h-screen flex flex-col overflow-hidden relative">

        <!-- 顶部导航 -->
        <header
            class="flex justify-between items-center p-4 bg-white sticky top-0 z-10 shadow-sm/50 backdrop-blur-md bg-opacity-90">
            <h1 class="text-xl font-bold tracking-tight">BodyOS</h1>
            <button @click="currentView = 'settings'" class="p-2 rounded-full hover:bg-gray-100">
                <i data-lucide="settings" class="w-6 h-6 text-gray-600"></i>
            </button>
        </header>

        <!-- 主视图区域 -->
        <main class="flex-1 overflow-y-auto p-3 relative">

            <!-- 仪表盘：双列时间轴 -->
            <div v-if="currentView === 'dashboard'" class="flex gap-2">
                <!-- 左列：健身 -->
                <div class="w-1/2 flex flex-col gap-3">
                    <div v-for="log in workoutLogs" :key="log.id"
                        class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100"
                        @click="openDetail(log)">
                        <img :src="log.thumbnail" class="w-full h-32 object-cover bg-gray-50">
                        <div class="p-2">
                            <div class="text-xs text-gray-400 mb-1">{{ formatDate(log.timestamp) }}</div>
                            <h3 class="font-bold text-sm line-clamp-2">{{ log.summary }}</h3>
                            <div class="mt-2 flex gap-1 flex-wrap">
                                <span
                                    class="px-1.5 py-0.5 bg-orange-100 text-orange-700 text-[10px] rounded font-medium">无氧</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右列：饮食 -->
                <div class="w-1/2 flex flex-col gap-3 pt-6"> <!-- 错位布局 -->
                    <div v-for="log in mealLogs" :key="log.id"
                        class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100"
                        @click="openDetail(log)">
                        <img :src="log.thumbnail" class="w-full h-32 object-cover bg-gray-50">
                        <div class="p-2">
                            <div class="text-xs text-gray-400 mb-1">{{ formatDate(log.timestamp) }}</div>
                            <h3 class="font-bold text-sm">{{ log.summary }}</h3>
                            <div class="mt-2 flex justify-between items-end">
                                <span class="text-xs font-mono text-gray-500">{{ log.kcal }} kcal</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 空状态 -->
            <div v-if="logs.length === 0 && currentView === 'dashboard'"
                class="flex flex-col items-center justify-center h-64 text-gray-400">
                <i data-lucide="activity" class="w-12 h-12 mb-2 opacity-20"></i>
                <p>开始记录你的进化之路</p>
            </div>

            <!-- 设置页 -->
            <div v-if="currentView === 'settings'" class="space-y-6 p-2">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="font-bold mb-4">API 设置</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">API URL (默认)</label>
                            <input v-model="settings.baseUrl"
                                class="w-full bg-gray-50 p-2 rounded text-sm border focus:outline-none focus:border-black"
                                placeholder="https://...">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">API Key 1 (主要)</label>
                            <input v-model="settings.apiKey1" type="password"
                                class="w-full bg-gray-50 p-2 rounded text-sm border" placeholder="sk-...">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">API Key 2 (备用)</label>
                            <input v-model="settings.apiKey2" type="password"
                                class="w-full bg-gray-50 p-2 rounded text-sm border" placeholder="sk-...">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">Model</label>
                            <input v-model="settings.model" class="w-full bg-gray-50 p-2 rounded text-sm border"
                                placeholder="gpt-4.1-mini">
                        </div>
                        <button @click="saveSettings"
                            class="w-full bg-black text-white py-2 rounded-lg text-sm font-medium">保存配置</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="font-bold mb-4">数据管理</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="exportData"
                            class="bg-gray-100 py-3 rounded-lg text-sm font-medium flex flex-col items-center justify-center gap-1">
                            <i data-lucide="download" class="w-4 h-4"></i> 导出 ZIP
                        </button>
                        <label
                            class="bg-gray-100 py-3 rounded-lg text-sm font-medium flex flex-col items-center justify-center gap-1 cursor-pointer">
                            <i data-lucide="upload" class="w-4 h-4"></i> 导入 ZIP
                            <input type="file" @change="importData" class="hidden" accept=".zip">
                        </label>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <button @click="clearData" class="text-red-500 text-sm w-full text-center">清空所有数据</button>
                    </div>
                </div>

                <button @click="currentView = 'dashboard'" class="w-full py-3 text-gray-500 text-sm">返回首页</button>
            </div>

        </main>

        <!-- 底部功能区 -->
        <div class="fixed bottom-6 left-0 w-full px-6 flex justify-between items-end pointer-events-none z-20">
            <!-- 添加按钮 -->
            <div class="pointer-events-auto flex gap-3">
                <button @click="startAdd('workout')"
                    class="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                    <i data-lucide="dumbbell" class="w-5 h-5"></i>
                </button>
                <button @click="startAdd('meal')"
                    class="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                    <i data-lucide="utensils" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- AI Agent 图标 -->
            <button @click="toggleChat"
                class="pointer-events-auto w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-xl hover:shadow-2xl active:scale-95 transition-all relative overflow-hidden group">
                <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity"></div>
                <!-- 简单吉祥物 SVG -->
                <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" />
                    <path d="M9 9h.01" />
                    <path d="M15 9h.01" />
                    <path d="M9.5 15a3.5 3.5 0 0 0 5 0" />
                </svg>
            </button>
        </div>

        <!-- 弹窗：添加记录/编辑 -->
        <transition name="slide">
            <div v-if="showModal" class="fixed inset-0 bg-white z-30 flex flex-col">
                <!-- 头部 -->
                <div class="p-4 border-b flex justify-between items-center bg-white">
                    <h3 class="font-bold text-lg">{{ modalMode === 'workout' ? '健身记录' : '饮食记录' }}</h3>
                    <button @click="closeModal" class="p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 space-y-4">

                    <!-- 图片上传区 -->
                    <div v-if="!tempData.imageBlob"
                        class="border-2 border-dashed border-gray-300 rounded-xl h-48 flex flex-col items-center justify-center bg-gray-50 relative">
                        <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 w-full h-full"
                            accept="image/*">
                        <i data-lucide="camera" class="w-8 h-8 text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-500">{{ modalMode === 'workout' ? '上传训记截图' : '拍照记录饮食' }}</p>
                    </div>
                    <div v-else class="relative rounded-xl overflow-hidden shadow-sm">
                        <img :src="tempData.imagePreview" class="w-full object-cover max-h-64">
                        <div v-if="isAnalyzing"
                            class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white backdrop-blur-sm">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mb-2"></div>
                            <span class="text-sm font-medium">AI 正在分析成分...</span>
                        </div>
                    </div>

                    <!-- 饮食：滑块编辑区 -->
                    <div v-if="modalMode === 'meal' && tempData.items.length > 0" class="space-y-6 pb-20">
                        <div v-for="(item, idx) in tempData.items" :key="idx"
                            class="bg-white p-4 rounded-xl border shadow-sm">
                            <div class="flex justify-between items-center mb-3">
                                <input v-model="item.name"
                                    class="font-bold text-lg bg-transparent border-b border-transparent focus:border-gray-300 outline-none w-2/3">
                                <div class="text-right">
                                    <div class="text-xl font-mono font-bold">{{ Math.round(item.weight_g *
                                        (item.kcal_per_100g/100)) }} <span
                                            class="text-xs font-normal text-gray-500">kcal</span></div>
                                </div>
                            </div>

                            <!-- 滑块 -->
                            <div class="mb-4">
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>分量</span>
                                    <span class="font-bold text-black">{{ item.weight_g }}g</span>
                                </div>
                                <input type="range" v-model.number="item.weight_g" min="0" max="500" step="5"
                                    class="range-slider">
                            </div>

                            <!-- 宏量展示 (只读，动态计算) -->
                            <div class="grid grid-cols-3 gap-2 text-center text-xs bg-gray-50 p-2 rounded-lg">
                                <div>
                                    <div class="text-gray-400">碳水</div>
                                    <div class="font-medium">{{ (item.weight_g * item.macros.c / 100).toFixed(1) }}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-gray-400">蛋白质</div>
                                    <div class="font-medium">{{ (item.weight_g * item.macros.p / 100).toFixed(1) }}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-gray-400">脂肪</div>
                                    <div class="font-medium">{{ (item.weight_g * item.macros.f / 100).toFixed(1) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 营养补剂 Checkbox -->
                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-100">
                            <h4 class="text-sm font-bold text-yellow-800 mb-2">补剂检查</h4>
                            <div class="flex flex-wrap gap-2">
                                <label v-for="sup in tempData.supplements" :key="sup.name"
                                    class="flex items-center gap-2 text-sm bg-white px-3 py-1.5 rounded-full border border-yellow-200">
                                    <input type="checkbox" v-model="sup.taken"
                                        class="rounded text-yellow-600 focus:ring-yellow-500">
                                    {{ sup.name }}
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 健身：文本解析展示 -->
                    <div v-if="modalMode === 'workout' && tempData.workoutSummary"
                        class="bg-gray-50 p-4 rounded-xl text-sm font-mono whitespace-pre-wrap border">{{
                        tempData.workoutSummary }}</div>

                </div>

                <!-- 底部保存 -->
                <div class="p-4 border-t bg-white safe-bottom">
                    <button @click="saveRecord" :disabled="!tempData.imageBlob || isAnalyzing"
                        class="w-full bg-black text-white py-3 rounded-xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        保存记录
                    </button>
                </div>
            </div>
        </transition>

        <!-- AI 聊天界面 -->
        <transition name="slide">
            <div v-if="showChat" class="fixed inset-0 bg-white z-40 flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-white shadow-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white">
                            <i data-lucide="bot" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold">健康教练 Agent</span>
                    </div>
                    <button @click="toggleChat" class="p-2 bg-gray-100 rounded-full"><i data-lucide="chevron-down"
                            class="w-5 h-5"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" id="chat-container">
                    <div v-for="(msg, i) in chatHistory" :key="i"
                        :class="['flex', msg.role === 'user' ? 'justify-end' : 'justify-start']">
                        <div
                            :class="['max-w-[85%] p-3 rounded-2xl text-sm shadow-sm', msg.role === 'user' ? 'bg-black text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-gray-100']">
                            <div v-if="msg.role === 'assistant'" v-html="renderMarkdown(msg.content)"></div>
                            <div v-else>{{ msg.content }}</div>
                            <div v-if="msg.loading" class="mt-2 flex gap-1">
                                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"
                                    style="animation-delay: 0.1s"></span>
                                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"
                                    style="animation-delay: 0.2s"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-white border-t">
                    <div class="flex gap-2">
                        <input v-model="chatInput" @keyup.enter="sendMessage" placeholder="问问我最近的训练或饮食..."
                            class="flex-1 bg-gray-100 px-4 py-2.5 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button @click="sendMessage" class="p-2.5 bg-indigo-600 text-white rounded-full">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;

        // Database Setup
        const db = new Dexie('BodyOS_DB');
        db.version(1).stores({
            logs: '++id, timestamp, type', // id, timestamp, type, summary, thumbnail(base64), details(json), imageBlob
            settings: 'key'
        });

        createApp({
            setup() {
                // State
                const currentView = ref('dashboard');
                const showModal = ref(false);
                const showChat = ref(false);
                const modalMode = ref('meal'); // 'meal' or 'workout'
                const isAnalyzing = ref(false);
                const logs = ref([]);

                // Settings
                const settings = reactive({
                    baseUrl: "https://b.apiyi.com/v1",
                    apiKey1: "",
                    apiKey2: "",
                    model: "gpt-4.1-mini"
                });

                // Temp data for adding records
                const tempData = reactive({
                    imageBlob: null,
                    imagePreview: null,
                    items: [], // for meals
                    supplements: [],
                    workoutSummary: "", // for workouts
                    rawAnalysis: null
                });

                // Chat
                const chatInput = ref("");
                const chatHistory = ref([
                    { role: 'assistant', content: '嗨！我是你的 AI 健康教练。我可以帮你分析饮食、复盘训练。\n试着问我："这周我的训练容量怎么样？" 或 "今天的蛋白质摄入够吗？"' }
                ]);

                // Computed
                const workoutLogs = computed(() => logs.value.filter(l => l.type === 'workout').sort((a, b) => b.timestamp - a.timestamp));
                const mealLogs = computed(() => logs.value.filter(l => l.type === 'meal').sort((a, b) => b.timestamp - a.timestamp));

                // Lifecycle
                onMounted(async () => {
                    lucide.createIcons();
                    await loadSettings();
                    await loadLogs();
                });

                // --- Database & Settings ---
                async function loadSettings() {
                    const saved = await db.settings.get('config');
                    if (saved) Object.assign(settings, saved);
                }

                async function saveSettings() {
                    const data = JSON.parse(JSON.stringify(settings));
                    data.key = 'config';
                    await db.settings.put(data);
                    alert('设置已保存');
                }

                async function loadLogs() {
                    logs.value = await db.logs.toArray();
                }

                async function clearData() {
                    if (confirm('确定清空所有数据？不可恢复。')) {
                        await db.logs.clear();
                        logs.value = [];
                        alert('数据已清空');
                    }
                }

                // --- Image Handling ---
                async function handleImageUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // 1. Compress for Display/Upload (~200KB)
                    const options = { maxSizeMB: 0.2, maxWidthOrHeight: 1280, useWebWorker: true };
                    try {
                        const compressedFile = await imageCompression(file, options);
                        tempData.imageBlob = compressedFile;
                        tempData.imagePreview = URL.createObjectURL(compressedFile);

                        // 2. Trigger AI Analysis
                        analyzeImage(compressedFile);
                    } catch (error) {
                        console.error(error);
                        alert('图片处理失败');
                    }
                }

                async function createThumbnail(blob) {
                    // Compress extremely small for DB list (<10KB)
                    const options = { maxSizeMB: 0.01, maxWidthOrHeight: 100, useWebWorker: true };
                    const thumbBlob = await imageCompression(blob, options);
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(thumbBlob);
                        reader.onloadend = () => resolve(reader.result);
                    });
                }

                async function blobToBase64(blob) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => resolve(reader.result);
                    });
                }

                // --- AI Logic (The Brain) ---
                async function callLLM(messages, useJson = true) {
                    const keys = [settings.apiKey1, settings.apiKey2].filter(k => k);
                    if (keys.length === 0) {
                        alert('请先在设置中配置 API Key');
                        return null;
                    }

                    for (const key of keys) {
                        try {
                            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${key}`
                                },
                                body: JSON.stringify({
                                    model: settings.model,
                                    messages: messages,
                                    response_format: useJson ? { type: "json_object" } : undefined
                                })
                            });

                            if (!response.ok) throw new Error('API Error');
                            const data = await response.json();
                            return data.choices[0].message.content;
                        } catch (e) {
                            console.warn(`Key failed, retrying...`, e);
                            continue;
                        }
                    }
                    alert('AI 服务暂时不可用，请检查网络或 Key');
                    return null;
                }

                async function analyzeImage(imageBlob) {
                    isAnalyzing.value = true;
                    const base64Img = await blobToBase64(imageBlob);

                    let systemPrompt = "";
                    let userPrompt = "";

                    if (modalMode.value === 'meal') {
                        systemPrompt = `你是一个专业的营养师。请分析图片中的食物。
                返回 JSON 格式：
                {
                    "items": [
                        {"name": "食物名", "weight_g": 估算克数(number), "kcal_per_100g": number, "macros": {"p": 蛋白质g/100g, "c": 碳水g/100g, "f": 脂肪g/100g}}
                    ],
                    "supplements": [
                        {"name": "维C", "taken": false}, {"name": "鱼油", "taken": false}
                    ] 
                }
                识别是否有补剂(如鱼油, 维生素等)，如果用户设置了偏好请自动添加。`;
                        userPrompt = "请分析这顿饭的营养成分。";
                    } else {
                        systemPrompt = `你是一个健身教练。请分析"训记"APP的截图。
                **只关注黑色加粗的真实训练数据**，忽略浅灰色的模板文字。
                返回 JSON 格式：
                {
                    "summary": "简短总结(如: 胸肩训练 3.5吨)",
                    "exercises": [{"name": "动作名", "sets": 组数, "best": "最大重量"}],
                    "total_volume": "总容量(kg)"
                }`;
                        userPrompt = "分析这次训练。";
                    }

                    const messages = [
                        { role: "system", content: systemPrompt },
                        {
                            role: "user", content: [
                                { type: "text", text: userPrompt },
                                { type: "image_url", image_url: { url: base64Img } }
                            ]
                        }
                    ];

                    const result = await callLLM(messages, true);
                    isAnalyzing.value = false;

                    if (result) {
                        try {
                            const parsed = JSON.parse(result);
                            if (modalMode.value === 'meal') {
                                tempData.items = parsed.items || [];
                                // 默认补剂列表 + AI识别的
                                tempData.supplements = parsed.supplements || [];
                                if (tempData.supplements.length === 0) {
                                    tempData.supplements = [{ name: '鱼油', taken: false }, { name: '综合维生素', taken: false }];
                                }
                            } else {
                                tempData.workoutSummary = result; // Keep raw json for debug or parsed summary
                                tempData.rawAnalysis = parsed;
                            }
                        } catch (e) {
                            alert('AI 解析数据格式出错');
                        }
                    }
                }

                // --- Core Functions ---
                function startAdd(mode) {
                    modalMode.value = mode;
                    // Reset temp data
                    tempData.imageBlob = null;
                    tempData.imagePreview = null;
                    tempData.items = [];
                    tempData.workoutSummary = "";
                    showModal.value = true;
                }

                function closeModal() {
                    showModal.value = false;
                }

                async function saveRecord() {
                    const thumbnail = await createThumbnail(tempData.imageBlob);
                    const now = new Date();
                    let summaryText = "";
                    let detailsData = {};

                    if (modalMode.value === 'meal') {
                        let totalKcal = 0;
                        tempData.items.forEach(i => {
                            totalKcal += (i.weight_g * i.kcal_per_100g / 100);
                        });

                        // Determine Meal Type
                        const hour = now.getHours();
                        let mealType = "加餐";
                        if (hour < 10) mealType = "早餐";
                        else if (hour < 15) mealType = "午餐";
                        else mealType = "晚餐";

                        summaryText = `${mealType}`;
                        detailsData = {
                            items: JSON.parse(JSON.stringify(tempData.items)),
                            supplements: JSON.parse(JSON.stringify(tempData.supplements)),
                            totalKcal: Math.round(totalKcal)
                        };
                    } else {
                        const parsed = tempData.rawAnalysis || {};
                        summaryText = parsed.summary || "训练记录";
                        detailsData = parsed;
                    }

                    await db.logs.add({
                        timestamp: now.getTime(),
                        dateStr: now.toISOString().split('T')[0],
                        type: modalMode.value,
                        summary: summaryText,
                        thumbnail: thumbnail, // Base64 < 10KB
                        kcal: detailsData.totalKcal || 0,
                        imageBlob: tempData.imageBlob, // Full Blob
                        details: detailsData
                    });

                    await loadLogs();
                    closeModal();
                }

                // --- Data Import/Export (Zip) ---
                async function exportData() {
                    const zip = new JSZip();
                    const allLogs = await db.logs.toArray();

                    // 1. Export JSON Data (exclude huge blobs to keep json light, strictly structure)
                    const exportLogs = allLogs.map(l => {
                        const { imageBlob, ...rest } = l;
                        return { ...rest, imgName: `${l.timestamp}.jpg` };
                    });
                    zip.file("data.json", JSON.stringify(exportLogs));

                    // 2. Export Images folder
                    const imgFolder = zip.folder("imgs");
                    for (const log of allLogs) {
                        if (log.imageBlob) {
                            imgFolder.file(`${log.timestamp}.jpg`, log.imageBlob);
                        }
                    }

                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `BodyOS_Backup_${new Date().toISOString().split('T')[0]}.zip`);
                }

                async function importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const zip = new JSZip();
                    const loadedZip = await zip.loadAsync(file);

                    const jsonData = await loadedZip.file("data.json").async("string");
                    const logsData = JSON.parse(jsonData);

                    // Simple logic: Overwrite if ID exists, or Add. For this demo: clear & load is safer.
                    // But requirement says "Incremental or Full". Let's do Incremental by timestamp check.
                    let count = 0;
                    for (const log of logsData) {
                        const existing = await db.logs.where('timestamp').equals(log.timestamp).first();
                        if (!existing) {
                            // Load image blob
                            const imgBlob = await loadedZip.file(`imgs/${log.imgName}`).async("blob");
                            await db.logs.add({
                                ...log,
                                imageBlob: imgBlob
                            });
                            count++;
                        }
                    }
                    await loadLogs();
                    alert(`导入完成，新增 ${count} 条记录`);
                }

                // --- AI Agent (ReAct Simulation) ---
                function toggleChat() {
                    showChat.value = !showChat.value;
                    if (showChat.value) {
                        nextTick(() => {
                            const el = document.getElementById('chat-container');
                            if (el) el.scrollTop = el.scrollHeight;
                        });
                    }
                }

                function renderMarkdown(text) {
                    return marked.parse(text);
                }

                async function sendMessage() {
                    if (!chatInput.value.trim()) return;

                    const userMsg = chatInput.value;
                    chatHistory.value.push({ role: 'user', content: userMsg });
                    chatInput.value = "";

                    const loadingMsg = { role: 'assistant', content: '', loading: true };
                    chatHistory.value.push(loadingMsg);

                    // ReAct Logic
                    // 1. Prepare Context (Tools)
                    const recentLogs = logs.value.slice(0, 10).map(l => `${l.dateStr} ${l.type}: ${l.summary} (Details: ${JSON.stringify(l.details)})`).join('\n');

                    const systemPrompt = `你是一个智能健康助手。
            用户当前有以下最近记录(Memory):
            ${recentLogs}
            
            你的能力：
            1. 分析训练容量和频率。
            2. 检查饮食热量和营养均衡。
            
            请根据 Memory 数据回答用户。如果数据不足，请告诉用户多记录。
            请用简洁、鼓励性的语气。支持 Markdown。`;

                    // 2. Call LLM
                    const response = await callLLM([
                        { role: "system", content: systemPrompt },
                        ...chatHistory.value.filter(m => !m.loading).map(m => ({ role: m.role, content: m.content }))
                    ], false); // False = text mode

                    // 3. Update UI
                    chatHistory.value.pop(); // remove loading
                    if (response) {
                        chatHistory.value.push({ role: 'assistant', content: response });
                    } else {
                        chatHistory.value.push({ role: 'assistant', content: "抱歉，我好像断线了，请检查网络或 Key。" });
                    }

                    nextTick(() => {
                        const el = document.getElementById('chat-container');
                        el.scrollTop = el.scrollHeight;
                    });
                }

                // Utils
                function formatDate(ts) {
                    const d = new Date(ts);
                    return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
                }
                function openDetail(log) {
                    // 简单实现：点击可以在 Console 看到详情，实际产品应跳转详情页
                    console.log(log);
                    alert(`详细数据:\n${JSON.stringify(log.details, null, 2)}`);
                }

                return {
                    currentView, showModal, showChat, modalMode, isAnalyzing,
                    settings, tempData, logs, workoutLogs, mealLogs, chatInput, chatHistory,
                    startAdd, closeModal, handleImageUpload, saveRecord,
                    saveSettings, exportData, importData, clearData,
                    toggleChat, sendMessage, renderMarkdown, formatDate, openDetail
                };
            }
        }).mount('#app');
    </script>

</body>

</html>